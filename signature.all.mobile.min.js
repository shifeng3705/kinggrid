!function(){var n={},u=!1;function e(e,t){n[e]=t}window.JSON&&(u='{"x":"中"}'!==window.JSON.stringify({x:"中"})),e("jquery",function(){return jQuery}),e("popup",function(e){var S=e("jquery"),n=!("minWidth"in S("html")[0].style),a=!n;function o(){this.destroyed=!1,this.__popup=S("<div />").css({display:"none",position:"absolute",outline:0}).attr("tabindex","-1").html(this.innerHTML).appendTo("body"),this.__backdrop=this.__mask=S("<div />").css({opacity:.7,background:"#000"}),this.node=this.__popup[0],this.backdrop=this.__backdrop[0],0}return S.extend(o.prototype,{node:null,backdrop:null,fixed:!1,destroyed:!0,open:!1,returnValue:"",autofocus:!0,align:"bottom left",innerHTML:"",className:"ui-popup",show:function(e){if(this.destroyed)return this;var t=this.__popup,i=this.__backdrop;return this.__activeElement=this.__getActive(),this.open=!0,this.follow=e||this.follow,this.__ready||(t.addClass(this.className).attr("role",this.modal?"alertdialog":"dialog").css("position","fixed"),n||S(window).on("resize",S.proxy(this.reset,this)),this.modal&&(e={position:"fixed",left:0,top:0,width:"100%",height:"100%",overflow:"hidden",userSelect:"none",zIndex:this.zIndex||o.zIndex},t.addClass(this.className+"-modal"),a||S.extend(e,{position:"absolute",width:S(window).width()+"px",height:S(document).height()+"px"}),i.css(e).attr({tabindex:"0"}).on("focus",S.proxy(this.focus,this)),this.__mask=i.clone(!0).attr("style","").insertAfter(t),i.addClass(this.className+"-backdrop").insertBefore(t),this.__ready=!0),t.html()||t.html(this.innerHTML)),t.addClass(this.className+"-show").show(),i.show(),this.reset().focus(),this.__dispatchEvent("show"),this},showModal:function(){return this.modal=!0,this.show.apply(this,arguments)},close:function(e){return!this.destroyed&&this.open&&(void 0!==e&&(this.returnValue=e),this.__popup.hide().removeClass(this.className+"-show"),this.__backdrop.hide(),this.open=!1,this.blur(),this.__dispatchEvent("close")),this},remove:function(){if(this.destroyed)return this;for(var e in this.__dispatchEvent("beforeremove"),o.current===this&&(o.current=null),this.__popup.remove(),this.__backdrop.remove(),this.__mask.remove(),n||S(window).off("resize",this.reset),this.__dispatchEvent("remove"),this)delete this[e];return this},reset:function(){var e=this.follow;return e?this.__follow(e):this.__center(),this.__dispatchEvent("reset"),this},focus:function(){var e=this.node,t=this.__popup,i=o.current,n=this.zIndex=o.zIndex++;return i&&i!==this&&i.blur(!1),S.contains(e,this.__getActive())||(i=t.find("[autofocus]")[0],!this._autofocus&&i?this._autofocus=!0:i=e,this.__focus(i)),t.css("zIndex",n),o.current=this,t.addClass(this.className+"-focus"),this.__dispatchEvent("focus"),this},blur:function(){var e=this.__activeElement;return!1!==arguments[0]&&this.__focus(e),this._autofocus=!1,this.__popup.removeClass(this.className+"-focus"),this.__dispatchEvent("blur"),this},addEventListener:function(e,t){return this.__getEventListener(e).push(t),this},removeEventListener:function(e,t){for(var i=this.__getEventListener(e),n=0;n<i.length;n++)t===i[n]&&i.splice(n--,1);return this},__getEventListener:function(e){var t=this.__listener;return(t=t||(this.__listener={}))[e]||(t[e]=[]),t[e]},__dispatchEvent:function(e){var t=this.__getEventListener(e);this["on"+e]&&this["on"+e]();for(var i=0;i<t.length;i++)t[i].call(this)},__focus:function(e){try{this.autofocus&&!/^iframe$/i.test(e.nodeName)&&e.focus()}catch(e){}},__getActive:function(){try{var e=document.activeElement,t=e.contentDocument;return t&&t.activeElement||e}catch(e){}},__center:function(){this.__popup[0].style.left="0px";var e=this.__popup,t=S(window),i=S(document),n=this.fixed,n=(n||i.scrollLeft(),n||i.scrollTop(),t.width()),i=t.height(),t=e.width(),i=(i-e.height())/2,e=e[0].style;e.left=(n-t)/2+"px",e.top=i+"px"},__follow:function(e){var t=e.parentNode&&S(e),i=this.__popup;if(this.__followSkin&&i.removeClass(this.__followSkin),t){var n=t.offset();if(n.left*n.top<0)return this.__center()}var n=this.fixed,a=S(window),o=S(document),s=a.width(),a=a.height(),r=o.scrollLeft(),o=o.scrollTop(),l=i.width(),c=i.height(),g=t?t.outerWidth():0,d=t?t.outerHeight():0,e=this.__offset(e),u=e.left,e=e.top,u=n?u-r:u,e=n?e-o:e,r=n?0:r,n=n?0:o,o=r+s-l,s=n+a-c,a={},h=this.align.split(" "),p=this.className+"-",f={top:"bottom",bottom:"top",left:"right",right:"left"},m={top:"top",bottom:"top",left:"left",right:"left"},v=[{top:e-c,bottom:e+d,left:u-l,right:u+g},{top:e,bottom:e-c+d,left:u,right:u-l+g}],u={left:u+g/2-l/2,top:e+d/2-c/2},k={left:[r,o],top:[n,s]};S.each(h,function(e,t){v[e][t]>k[m[t]][1]&&(t=h[e]=f[t]),v[e][t]<k[m[t]][0]&&(h[e]=f[t])}),h[1]||(m[h[1]]="left"===m[h[0]]?"top":"left",v[1][h[1]]=u[m[h[1]]]),p+=h.join("-")+" "+this.className+"-follow",this.__followSkin=p,t&&i.addClass(p),a[m[h[0]]]=parseInt(v[0][h[0]]),a[m[h[1]]]=parseInt(v[1][h[1]]),i.css(a)},__offset:function(e){var t=e.parentNode,i=t?S(e).offset():{left:e.pageX,top:e.pageY},t=(e=t?e:e.target).ownerDocument,e=t.defaultView||t.parentWindow;if(e==window)return i;var e=e.frameElement,t=S(t),n=t.scrollLeft(),t=t.scrollTop(),e=S(e).offset(),a=e.left,e=e.top;return{left:i.left+a-n,top:i.top+e-t}}}),o.zIndex=1024,o.current=null,o}),e("dialog-config",{backdropBackground:"#000",backdropOpacity:.7,content:'<span class="ui-dialog-loading">Loading..</span>',title:"",statusbar:"",button:null,ok:null,cancel:null,okValue:"ok",cancelValue:"cancel",cancelDisplay:!0,width:"",height:"",padding:"",skin:"",quickClose:!1,cssUri:"../css/ui-dialog.css",innerHTML:'<div i="dialog" class="ui-dialog"><div class="ui-dialog-arrow-a"></div><div class="ui-dialog-arrow-b"></div><table class="ui-dialog-grid"><tr><td i="header" class="ui-dialog-header"><button i="close" class="ui-dialog-close">&#215;</button><div i="title" class="ui-dialog-title"></div></td></tr><tr><td i="body" class="ui-dialog-body"><div i="content" class="ui-dialog-content"></div></td></tr><tr><td i="footer" class="ui-dialog-footer"><div i="statusbar" class="ui-dialog-statusbar"></div><div i="checkInput" class="ui-dialog-checkInput"></div><div i="button" class="ui-dialog-button"></div></td></tr></table></div>'}),e("dialog",function(e){function o(e,t,i){var n=e=e||{},n=("string"!=typeof e&&1!==e.nodeType||(e={content:e,fixed:!g}),(e=r.extend(!0,{},o.defaults,e)).original=n,e.id=e.id||c+l),a=o.get(n);return a?a.focus():(d||(e.fixed=!1),e.quickClose&&(e.modal=!0,e.backdropOpacity=0),r.isArray(e.button)||(e.button=[]),void 0!==i&&(e.cancel=i),e.cancel&&e.button.push({id:"cancel",value:e.cancelValue,callback:e.cancel,display:e.cancelDisplay}),void 0!==t&&(e.ok=t),e.ok&&e.button.push({id:"ok",value:e.okValue,callback:e.ok,autofocus:!0}),o.list[n]=new o.create(e))}function t(){}var r=e("jquery"),s=e("popup"),i=e("dialog-config"),n=i.cssUri,l=(!n||(e=e[e.toUrl?"toUrl":"resolve"])&&(n='<link rel="stylesheet" href="'+e(n)+'" />',r("base")[0]?r("base").before(n):r("head").append(n)),0),c=+new Date,e=!("minWidth"in r("html")[0].style),g="createTouch"in document&&!("onmousemove"in document)||/(iPhone|iPad|iPod)/i.test(navigator.userAgent),d=!e&&!g,n=(t.prototype=s.prototype,o.prototype=new t);return(o.create=function(e){var a=this,t=(r.extend(this,new s),e.original,r(this.node).html(e.innerHTML)),i=r(this.backdrop);return this.options=e,this._popup=t,this.fixed=!0,r.each(e,function(e,t){"function"==typeof a[e]?a[e](t):a[e]=t}),e.zIndex&&(s.zIndex=e.zIndex),t.attr({"aria-labelledby":this._$("title").attr("id","title:"+this.id).attr("id"),"aria-describedby":this._$("content").attr("id","content:"+this.id).attr("id")}),this._$("close").css("display",!1===this.cancel?"none":"").attr("title",this.cancelValue).on("click",function(e){a._trigger("cancel"),e.preventDefault()}),this._$("dialog").addClass(this.skin),this._$("body").css("padding",this.padding),e.quickClose&&i.on("onmousedown"in document?"mousedown":"click",function(){return a._trigger("cancel"),!1}),this.addEventListener("show",function(){i.css({opacity:0,background:e.backdropBackground}).animate({opacity:e.backdropOpacity},150)}),this._esc=function(e){var t=e.target,i=t.nodeName,n=s.current===a,e=e.keyCode;!n||/^input|textarea$/i.test(i)&&"button"!==t.type||27===e&&a._trigger("cancel")},r(document).on("keydown",this._esc),this.addEventListener("remove",function(){r(document).off("keydown",this._esc),delete o.list[this.id]}),l++,o.oncreate(this),this}).prototype=n,r.extend(n,{content:function(e){var t=this._$("content");return"object"==typeof e?(e=r(e),t.empty("").append(e.show()),this.addEventListener("beforeremove",function(){r("body").append(e.hide())})):t.html(e),this.reset()},title:function(e){return this._$("title").text(e),this._$("header")[e?"show":"hide"](),this},width:function(e){return this._$("content").css("width",e),this.reset()},height:function(e){return this._$("content").css("height",e),this.reset()},button:function(e){e=e||[];var a=this,o="",s=0;return this.callbacks={},"string"==typeof e?(o=e,s++):r.each(e,function(e,t){var i=t.id=t.id||t.value,n="";a.callbacks[i]=t.callback,!1===t.display?n=' style="display:none"':s++,o+='<button type="button" i-id="'+i+'"'+("cancel"==i?' class="kg-default-btn-red" ':"")+n+(t.disabled?" disabled":"")+(t.autofocus?u?' class="ui-dialog-autofocus kg-primary-btn-red"':' autofocus class="ui-dialog-autofocus kg-primary-btn-red"':"")+">"+t.value+"</button>",a._$("button").on("click","[i-id="+i+"]",function(e){r(this).attr("disabled")||a._trigger(i),e.preventDefault()})}),this._$("button").html(o),this._$("footer")[s?"show":"hide"](),this},statusbar:function(e){return this._$("statusbar").html(e)[e?"show":"hide"](),this},_$:function(e){return this._popup.find("[i="+e+"]")},_trigger:function(e){e=this.callbacks[e];return"function"!=typeof e||!1!==e.call(this)?this.close().remove():this}}),o.oncreate=r.noop,o.getCurrent=function(){return s.current},o.get=function(e){return void 0===e?o.list:o.list[e]},o.list={},o.defaults=i,o}),window.KG_Dialog=function e(t){var t=n[t],i="exports";return"object"==typeof t?t:(t[i]||(t[i]={},t[i]=t.call(t[i],e,t[i],t)||t[i]),t[i])}("dialog")}();var maxTickDepth=100,toString=Object.prototype.toString,nextTick="function"==typeof setImmediate?setImmediate:function(e){setTimeout(e,0)},isArray=Array.isArray||function(e){return"[object Array]"===toString.call(e)};function slice(e,t){var i=e.length,n=Array(i);for(t=t||0;i-- >t;)n[i-t]=e[i];return n}function carry(t,e){try{e.apply(null,slice(arguments,2))}catch(e){t(e)}}function defer(t,e){var i=slice(arguments,2);nextTick(function(){try{e.apply(null,i)}catch(e){t(e)}})}function Thenjs(e,t){var i,n=this;if(e instanceof Thenjs)return e;if(!(n instanceof Thenjs))return new Thenjs(e,t);if(n._success=n._each=n._eachSeries=n._parallel=n._series=null,n._finally=n._error=n._fail=n._result=n._nextThen=n._chain=null,!arguments.length)return n;i=genContinuation(n,t);try{"function"==typeof e?e(i):null==e?i():"function"==typeof e.toThunk?e.toThunk()(i):"function"==typeof e.then?e.then(function(e){i(null,e)},i):i(null,e)}catch(e){i(e)}}Thenjs.defer=defer,Thenjs.each=function(t,i,e){return thenFactory(function(e){defer(e,each,e,t,i)},null,e)},Thenjs.eachSeries=function(t,i,e){return thenFactory(function(e){defer(e,eachSeries,e,t,i)},null,e)},Thenjs.parallel=function(t,e){return thenFactory(function(e){defer(e,parallel,e,t)},null,e)},Thenjs.series=function(t,e){return thenFactory(function(e){defer(e,series,e,t)},null,e)},Thenjs.nextTick=function(e){var t=slice(arguments,1);nextTick(function(){e.apply(null,t)})},Thenjs.onerror=function(e){throw console.error("Thenjs caught error: ",e),e};var proto=Thenjs.prototype,instance;function continuation(t){var i=this,e=arguments;if(!1!==i._result){!i._result&&i._chain&&i.debug.apply(i,["\nChain "+i._chain+": "].concat(slice(e))),i._result=!1;try{continuationExec(i,e,t)}catch(e){nextTick(function(){continuationError(i,e,t)})}}}function continuationExec(e,t,i){if(e._finally)return e._finally.apply(null,t);if(null!=i)throw i;i=e._success||e._each||e._eachSeries||e._parallel||e._series;if(i)return i.apply(null,slice(t,1));e._result=t}function continuationError(e,t,i){var n=e,a=e._error||e._fail;for(e._nextThen&&null==i&&(a=null,n=e._nextThen);!a&&n;)a=n._fail,n=n._nextThen;return a?a(t):Thenjs.onerror?Thenjs.onerror(t):void(n._result=[t])}function genContinuation(e,t){function i(){return continuation.apply(e,arguments)}return i._isCont=!0,t&&(proto.debug="function"==typeof t?t:defaultDebug,e._chain=1),i}function thenFactory(e,t,i){var n=new Thenjs;return e(genContinuation(n,i),t),t&&(t._nextThen=n,t._chain&&(n._chain=t._chain+1),t._result&&nextTick(function(){continuation.apply(t,t._result)})),n}function wrapTaskHandler(e,t){return t._isCont?t:function(){t.apply(null,[e].concat(slice(arguments)))}}function parallelNext(i,n,a,o){function e(e,t){if(!a.finished)return null!=e?(a.finished=!0,i(e)):(n[o]=t,--a.i<0&&i(null,n))}return e._isCont=!0,e}function each(e,t,i){var n,a=[],o={};if(!isArray(t))return e(errorify(t,"each"));if(o.i=n=t.length-1,n<0)return e(null,a);for(var s=0;s<=n;s++)i(parallelNext(e,a,o,s),t[s],s,t)}function parallel(e,t){var i,n=[],a={};if(!isArray(t))return e(errorify(t,"parallel"));if(a.i=i=t.length-1,i<0)return e(null,n);for(var o=0;o<=i;o++)t[o](parallelNext(e,n,a,o),o,t)}function eachSeries(i,n,a){var o,s=0,r=[],l=maxTickDepth;function c(e,t){return null!=e?i(e):(r[s]=t,++s>o?i(null,r):void(0<--l?carry:(l=maxTickDepth,defer))(i,a,c,n[s],s,n))}return c._isCont=!0,isArray(n)?(o=n.length-1)<0?i(null,r):void a(c,n[0],0,n):i(errorify(n,"eachSeries"))}function series(i,n){var a,o=0,s=[],r=maxTickDepth;function l(e,t){return null!=e?i(e):(s[o]=t,++o>a?i(null,s):void(0<--r?carry:(r=maxTickDepth,defer))(i,n[o],l,o,n))}return l._isCont=!0,isArray(n)?(a=n.length-1)<0?i(null,s):void n[0](l,0,n):i(errorify(n,"series"))}function defaultDebug(){console.log.apply(console,arguments)}function errorify(e,t){return new Error("The argument "+(e&&e.toString())+' in "'+t+'" is not Array!')}proto.fin=proto.all=proto.finally=function(i){return thenFactory(function(e,t){t._finally=wrapTaskHandler(e,i)},this)},proto.then=function(i,n){return thenFactory(function(e,t){t._success=wrapTaskHandler(e,i),t._error=n&&wrapTaskHandler(e,n)},this)},proto.fail=proto.catch=function(i){return thenFactory(function(e,t){t._fail=wrapTaskHandler(e,i),t._success=function(){e.apply(null,[null].concat(slice(arguments)))}},this)},proto.each=function(n,a){return thenFactory(function(i,e){e._each=function(e,t){each(i,n||e,a||t)}},this)},proto.eachSeries=function(n,a){return thenFactory(function(i,e){e._eachSeries=function(e,t){eachSeries(i,n||e,a||t)}},this)},proto.parallel=function(i){return thenFactory(function(t,e){e._parallel=function(e){parallel(t,i||e)}},this)},proto.series=function(i){return thenFactory(function(t,e){e._series=function(e){series(t,i||e)}},this)},proto.toThunk=function(){var t=this;return function(e){t._result?(e.apply(null,t._result),t._result=!1):!1!==t._result&&(t._finally=e)}},Thenjs.NAME="Thenjs",Thenjs.VERSION="1.3.4";var root=window,KG=function(){function c(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length}function t(e){this.map=e}var s=!1,l=(root.JSON&&(s='{"x":"中"}'!==root.JSON.stringify({x:"中"})),!!window.ActiveXObject||"ActiveXObject"in window),i=(c.prototype={clamp:function(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4)},toString:function(e){return(e||i).stringify(this)}},{stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n+=2)i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new c.init(i,t/2)}}),G=function(e){for(var t=e.words,i=e.sigBytes,n=[],a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},N=function(e){for(var t=e.length,i=[],n=0;n<t;n++)i[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new c(i,t)},n={stringify:function(e){try{return decodeURIComponent(escape(G(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return N(unescape(encodeURIComponent(e)))}},a=(t.map={},t.of=function(e){e=e||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return t.map[e]||new t(e)},t.prototype={decodeByte:function(e){for(var t,i,n=e.length,a=this.map,o=a.charAt(64),s=(!o||-1!=(o=e.indexOf(o))&&(n=o),[]),r=0,l=0;l<n;l++)l%4&&(t=a.indexOf(e.charAt(l-1))<<l%4*2,i=a.indexOf(e.charAt(l))>>>6-l%4*2,s[r>>>2]|=(t|i)<<24-r%4*8,r++);return new c(s,r)},decode:function(e){return n.stringify(this.decodeByte(e))},encode:function(e){if(e)return this.encodeByte(n.parse(e))},encodeByte:function(e){for(var t=e.words,i=e.sigBytes,n=this.map,a=(e.clamp(),[]),o=0;o<i;o+=3)for(var s=(t[o>>>2]>>>24-o%4*8&255)<<16|(t[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|t[o+2>>>2]>>>24-(o+2)%4*8&255,r=0;r<4&&o+.75*r<i;r++)a.push(n.charAt(s>>>6*(3-r)&63));var l=n.charAt(64);if(l)for(;a.length%4;)a.push(l);return a.join("")}},!{toString:null}.propertyIsEnumerable("toString")),r=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];function o(e,t){var i=r.length,n=e.constructor,a=k.is("Function",n)&&n.prototype||ObjProto,o="constructor";for(k.has(e,o)&&!_.contains(t,o)&&t.push(o);i--;)(o=r[i])in e&&e[o]!==a[o]&&!_.contains(t,o)&&t.push(o)}var g=function(e,t){var i=e.length,n=[];for(t=t||0;i-- >t;)n[i-t]=e[i];return n};function d(){}function u(){return(new Date).getTime()}function e(e){this.name=e}function h(e,t){var i,n=0,a="";for(i in e){var o=e[i];if(null!=o){function s(e){0<n&&(a+=t),a+=i+"="+e,n++}if(k.is("Array",o))for(var r=0;r<o.length;r++)s(o[r]);else s(o)}}return L.trigger("formatData",a),a}function p(e,t){var i="",t=t||"";if(k.is("Array",e))for(var n=0;n<e.length;n++)0<n&&(i+=t),i+=h(e[n],t);else i=h(e,t);return i}function f(e,t){L.trigger.apply(L,["response",t].concat(this)),g(arguments,1),e&&e(t)}var m,O,v,k={Utf8:n,Base64:t,slice:g,boolean:function(e,t,i){return Boolean(e.hasOwnProperty(t)?e[t]:i)},rand:function(e){return Math.ceil((9301*(new Date).getTime()+49297)%233280/233280*e)},addEvent:(F=root.document.attachEvent,v="micromessenger"!=(x=navigator.userAgent.toLowerCase()).match(/MicroMessenger/i)&&("qq"!=x.match(/QQ/i)&&("weibo"!=x.match(/WeiBo/i)&&(null!=x.match(/Android/i)?null==x.match(/browser/i):null!=x.match(/iPhone/i)?null==x.match(/safari/i):null==x.match(/macintosh/i)&&null==x.match(/windows/i)))),F?function(t,e,i){for(var n=e.split(" "),a=0;a<n.length;a++)t.attachEvent("on"+n[a],function(e){e.target=t,e.preventDefault=d,e.stopPropagation=d,i(e)})}:function(e,t,i){void 0===e.eventList&&(e.eventList={});for(var n=t.split(" "),a=0;a<n.length;a++){for(var o in e.eventList)if(o===n[a])return;v?e.addEventListener(n[a],i):document.addEventListener.apply(e,[n[a]].concat(k.slice(arguments,2))),e.eventList[n[a]]=!0}}),extend:(m=function(e){if(!k.is("Object",e))return[];var t,i=[];for(t in e)i.push(t);return a&&o(e,i),i},function(e){var t=arguments.length;if(t<2||null==e)return e;for(var i=1;i<t;i++)for(var n=arguments[i],a=m(n),o=a.length,s=0;s<o;s++){var r=a[s];O&&void 0!==e[r]||(e[r]=n[r])}return e}),filter:function(e,t){var i,n,a={},o=t;for(i in k.is("String",t)&&(n=k.slice(arguments,1),o=function(e){for(var t=0;t<n.length;t++)if(n[t]===e)return!1;return!0}),e)(n=o.call(e,i))&&(a[i]=e[i]);return a},convertText:function(e){for(var t="",i=0;i<e.length;i++)t+=e[i].replace(/(\S)/gi,"<span>$1</span>").replace(/\n|\r/gi,"<span><br></span>").replace(/\s/gi,"<span>&nbsp;</span>");return t},handleEdittable:function(a,e){var o=new Array,s=0,r=0;return $.each(a.find("span"),function(e,t){var i=$(t).text()||$(t).html(),n=new Object;"<br>"==i&&(s=0,r+=l?$(t).height()/2:$(t).height(),i=""),0==r&&(r=$(t).height()),s>=a.width()-$(t).width()&&(s=0,r+=$(t).height()),n.txt=i,n.left=s,n.top=r,o.push(n),""!=i&&(s+=$(t).width())}),o},val:function(e,t){var i;return k.is("Function",e)?(i=arguments.length<3?[]:[].slice.call(arguments).slice(2),e.apply(t,i)):e},$:function(e){var t,i=document.getElementById(e);return i||(t=document.getElementsByName(e))&&0<t.length&&(i=t[0]),i||(t=document.getElementsByTagName(e))&&0<t.length&&(i=t[0]),i},keys:function(e){if(!k.is("Object",e))return[];if(nativeKeys)return nativeKeys(e);var t,i=[];for(t in e)k.has(e,t)&&i.push(t);return a&&o(e,i),i},contains:function(e,t,i){return function(e){e=e&&e.length;return"number"==typeof e&&0<=e&&e<=MAX_ARRAY_INDEX}(e)||(e=_.values(e)),0<=_.indexOf(e,t,"number"==typeof i&&i)},values:function(e){for(var t=_.keys(e),i=t.length,n=Array(i),a=0;a<i;a++)n[a]=e[t[a]];return n},has:function(e,t){return null!=e&&Object.prototype.hasOwnProperty.call(e,t)},inherit:function(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i,(e.prototype.constructor=e).uber=t.prototype},is:function(e,t){var i=Object.prototype.toString.call(t).slice(8,-1);return null!=t&&i===e},colorRgb:function(e){var t=e.toLowerCase();if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(t)){if(4===t.length){for(var i="#",n=1;n<4;n+=1)i+=t.slice(n,n+1).concat(t.slice(n,n+1));t=i}for(var a=[],n=1;n<7;n+=2)a.push(parseInt("0x"+t.slice(n,n+2)));return"RGB("+a.join(",")+")"}return t},colorHex:function(e){if(/^(rgb|RGB)/.test(e)){for(var t=e.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),i="#",n=0;n<t.length;n++){var a=Number(t[n]).toString(16);"0"===a&&(a+=a),i+=a}return(i=7!==i.length?e:i).toUpperCase()}if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(e)){var o=e.replace(/#/,"").split("");if(6===o.length)return e.toUpperCase();if(3===o.length){for(var s="#",n=0;n<o.length;n+=1)s+=o[n]+o[n];return s.toUpperCase()}}return e.toUpperCase()},dateConvert:function(e,a){var o=[["零","一","二","三","四","五","六","七","八","九"],["〇","一","二","三","四","五","六","七","八","九"]],s="十",t=e.match(/^(\d{2}|\d{4})(年)(\d{1,2})(月)(\d{1,2})(日)$/),i="";if(null!=t){for(var n=1;n<t.length;n+=2)i+=function(e){if(2==e.length)return"1"==e.charAt(0)?"0"==e.charAt(1)?s:s+o[a-1][e.charAt(1)]:"0"!=e.charAt(1)?o[a-1][e.charAt(0)]+s+o[a-1][e.charAt(1)]:o[a-1][e.charAt(0)]+s;for(var t=e,i="",n=0;n<t.length;n++)i+=o[a-1][t.charAt(n)];return i}(t[n])+t[n+1];return i}},formatDate:function(e,t){var i,n,a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],o={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(i in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),new RegExp("(MMM)").test(t)&&(t=t.replace(RegExp.$1,"$")),o)new RegExp("("+i+")").test(t)&&(n=o[i],2==RegExp.$1.length&&(n=("00"+o[i]).substr((""+o[i]).length)),t=t.replace(RegExp.$1,n));return t=t.replace("$",a),/[*]/gi.test(t)&&(e=t.replace(/[*]/gi,""),a=t.length-e.length,t=this.dateConvert(e,a)),t},getDate:function(e){return 10==e.toString().length&&(e*=1e3),new Date(e)},template:function(e,t){for(var i,n=/<%([^%>]+)?%>/g,a=/(^( )?(var|if|for|else|switch|case|break|{|}))(.*)?/g,o="var r=[];\n",s=0,r=function(e,t){return o+=t?e.match(a)?e+"\n":"r.push("+e+");\n":""!=e?'r.push("'+e.replace(/"/g,'\\"')+'");\n':"",r};i=n.exec(e);)r(e.slice(s,i.index))(i[1],!0),s=i.index+i[0].length;return r(e.substr(s,e.length-s)),o+='return r.join("");',new Function(o.replace(/[\r\t\n]/g,"")).apply(t,g(arguments,2))},first:function(e,t){return e.substring(0,1)[t?"toLowerCase":"toUpperCase"]()+e.substring(1)},html2Escape:function(e){return e.replace(/[<>&"]/g,function(e){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e]})},conversion_getDPI:function(){var e,t=new Array;return window.screen.deviceXDPI?(t[0]=window.screen.deviceXDPI,t[1]=window.screen.deviceYDPI):((e=document.createElement("DIV")).style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(e),t[0]=parseInt(e.offsetWidth),t[1]=parseInt(e.offsetHeight),e.parentNode.removeChild(e)),t},pxConversionMm:function(e){return 25.4*(e/this.conversion_getDPI()[0])},eosFormatTime:function(e){var t=e.split(" ")[0],e=e.split(" ")[1].split(":"),i=e.slice(1,e.length).join(":"),e=parseInt(e[0])+8,e=(e<24?e:e%24).toString();return t+" "+(e=e<10?"0"+e:e)+":"+i}},R=(e.prototype={on:function(e,t){return this.__getEventListener(e).push(t),this},off:function(e,t){for(var i=this.__getEventListener(e),n=0;n<i.length;n++)t===i[n]&&i.splice(n--,1);return this},clear:function(e){return 0<this.__getEventListener(e).length&&(this.__listener[e]=[]),this},trigger:function(e){var t,i=this.__getEventListener(e),n=Array.prototype.slice.call(arguments);this["on"+e]&&(t=this["on"+e].apply(this,n.slice(1)));for(var a=0;a<i.length;a++)i[a].apply(this,n.slice(1));return t},__getEventListener:function(e){var t=this.__listener;return(t=t||(this.__listener={}))[e]||(t[e]=[]),t[e]}},{result:!1,errcode:"interErr"}),S={result:!1,errcode:"responseErr"},y={result:!1,errcode:"connectionErr"},b={result:!1,errcode:"parseErr"},w={result:!1,errcode:"timeoutErr"},C=function(e,t){this.url=e,this.data=t,L.trigger("beforeJSONP",e,t)},x=C.prototype,A=(x.parseData=function(){var e="",t=this.data;if(k.is("String",t))e=t;else if(k.is("Object",t))for(var i in t)t[i]&&(e+="&"+i+"="+encodeURIComponent(t[i]));else if(k.is("Array",t))for(var n=0;n<t.length;n++){var a=t[n];for(i in a)a[i]&&(e+="&"+i+"="+encodeURIComponent(a[i]))}return e=(e=(e+="&hookback="+this.name)+("&_="+u())).substr(1),L.trigger("parseData",e),e},x.getJSON=function(t){function e(){setTimeout(function(){clearTimeout(r),s.parentNode.removeChild(s);try{delete window[o]}catch(e){}},1)}var i=this,n=i.url,a=i.data,o=this.name="jsonp_"+u()+"_"+k.rand(1e5),n=n+(-1===n.indexOf("?")?"?":"&")+this.parseData(a),s=document.createElement("script"),r=(s.type="text/javascript",s.src=n,s.id=o,s.charset="utf-8",window[o]=function(e){i._execed=!0,f.call(i,t,e)},s.onload=function(){e(),i._execed||f.call(i,t,b)},s.onerror=function(){e(),void 0!==Signature.options.isResponseErr&&Signature.options.isResponseErr||f.call(i,t,S)},setTimeout(function(){e(),f.call(i,t,w)},U.options.timeout)),a=document.getElementsByTagName("head");a&&a[0]&&a[0].appendChild(s)},function(e,t){this.url=e,this.data=t,this.xdr=new XDomainRequest}),D=(A.prototype.getJSON=function(t){var i=this.xdr;i.onload=function(){var e;try{e=JSON.parse(i.responseText)}catch(e){return void f.call(i,t,b)}f.call(i,t,e)},i.onerror=function(){f.call(i,t,y)},i.timeout=U.options.timeout,i.ontimeout=function(){f.call(i,t,w)},i.open("POST",this.url),i.send(p(this.data,"\r\n"))},function(e,t){var i;if(window.XMLHttpRequest)i=new XMLHttpRequest;else if(window.ActiveXObject)for(var n=0;n<activexName.length;n++)try{i=new ActiveXObject(activexName[n]);break}catch(e){}this.xhr=i,this.url=e,this.data=t});D.prototype.getJSON=function(t){var i=this.xhr,n=!1,e=(i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status||304==i.status)try{var e=JSON.parse(i.responseText);f.call(i,t,e)}catch(e){return void f.call(i,t,b)}else n&&f.call(i,t,S)},i.open("POST",this.url,!0),i.onerror=function(){f.call(i,t,y)},i.timeout=U.options.timeout,i.ontimeout=function(){n=!0,f.call(i,t,w)},i.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),p(this.data,"\r\n"));i.send(e)},XMLHttpRequest.prototype._send=function(e){Signature.setRequestHeader(this),this.send(e)},Function.prototype.before=function(e){var t=this;return function(){return e.apply(this,arguments),t.apply(this,arguments)}},XMLHttpRequest.prototype.send=XMLHttpRequest.prototype.send.before(function(){Signature.setRequestHeader(this)});var H=!("withCredentials"in XMLHttpRequest.prototype)&&"undefined"!=typeof XDomainRequest,T=function(e,t,i){return L.trigger.apply(L,["beforeAjax"].concat(g(arguments))),new(i?C:H?A:D)(e,t)},z={Boolean:"BOOL",String:"BSTR",Number:"LONG"};function I(e){for(var t,i,n=[],a=0;a<e.length;a++){var o={};o.type=(t=e[a],z[Object.prototype.toString.call(t).slice(8,-1)]),o.value=e[a],n.push(o)}return i=n,i=JSON.stringify(i),s?i.replace(/\\u([0-9a-fA-F]{2,4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}):i}function B(e,t,i,n){L.trigger("beforeMethod",arguments);var a=Array.prototype.slice.call(arguments).slice(4),o={value:0==a.length?'{"MethodCall":{"caller":"'+t+'","function":"'+n+'"},"usercode":"'+i+'"}':'{"MethodCall":{"caller":"'+t+'","function":"'+n+'",'+('"params":'+I(a))+'},"usercode":"'+i+'"}'};return function(t){T(e+"/MethodCall",o,!1).getJSON(function(e){L.trigger("responseMethod",e),"none"!=e.type&&t(null,e.value||e)})}}function M(e,t,i){L.trigger("beforeAttr",arguments);var n=Array.prototype.slice.call(arguments).slice(3),a={value:0==n.length?'{"PropertyCall":{"caller":"'+t+'","property":"'+i+'"}}':'{"MethodCall":{"caller":"'+t+'","property":"'+i+'",'+('"params":'+I(n))+"}}"};return function(t){T(e,a,!0).getJSON(function(e){L.trigger("responseMethod",e),"none"!=e.type&&t(null,e.value)})}}function P(e,t){this.url=e,this.data=t,L.trigger("beforeAjaxJ",e,t)}function E(e){this.serverUrl=e,this.thenjs=Thenjs(function(e){e(null)})}var U=function(){},F=(U.errCode={1e4:"系统错误",20001:"密钥盘信息错误",20003:"密码错误，请输入正确密码",20004:"请输入密码!",11100:"签章服务器错误",111e3:"当前用户没有签章",111001:"该用户没有公章",111002:"该用户没有私章",111003:"该用户没有法人章",111004:"该用户没有法人签名印章",111005:"该用户没有手写签名印章",11101:"当前用户没有签章",11102:"印章错误",11103:"证书过期",11104:"印章过期",11105:"获取签章信息失败!",11106:"获取证书信息失败!",11107:"未搜索到您要的签章!",11108:"未设置签章密码!",11109:"操作失败，签章助手未启用或未授权",11110:"操作失败，请拔掉当前钥匙盘再进行操作",11111:"允许移动失败，请使用原签章密钥允许移动！",11112:"允许移动失败，该签章数据没有允许移动请求权限！",11113:"您的浏览器不支持手写签名。",11114:"请插入当前签章所属密钥盘",11115:"当前用户没有操作该签章权限",none:"客户端未知异常!",signErr:"签名失败",serverErr:"调用产品组件异常",parseErr:"数据格式异常",responseErr:"产品组件响应异常",connectionErr:"产品组件连接异常",timeoutErr:"请求响应超时",interErr:"获取接口异常","-7":"签名组件错误"},k.extend(U.errCode,{then:{"-1":"请安装客户端","-2":"请插入当前签章所属的密钥盘","-3":"未安装手机盾组件","-12":"获取证书失败","-13":"签名时，加载证书失败","-15":"签名数据不能为空","-16":"密码不能为空","-17":"解析证书失败","-18":"未安装手机盾组件","-19":"手机盾登录失败",1:"没有检测到密钥盘",2:"密钥盘没有正确初始化",3:"密钥盘驱动未安装",4:"只能插入一个密钥盘",7:"密码错误或密钥盘被锁定",8:"非法授权",9:"网络连接失败",10:"手机盾登录失败",11:"当前密钥盘没有印章",12:"获取印章信息失败",35:"钥匙盘未生效，不能签章！",36:"钥匙盘已过期，不能签章！",37:"授权信息结构非法！",38:"签章证书已经过期或还未生效！",39:"签章证书不受颁发机构信任！",40:"签章证书已被吊销！",41:"签章证书根证书未安装或无效的根证书！",42:"吊销列表文件不存在",43:"未检测到证书",44:"根证书文件不存在",45:"根证书和该证书的根证书不配套",46:"吊销列表和该证书的吊销列表不配套","-101":"获取密钥盘有效期异常","-103":"密钥盘未生效","-104":"期限许可已过期","-999":"金格组件未知错误","30001@gm":"验证电子印章失败：验证电子印章签名值失败！","30002@gm":"验证电子印章失败：验证电子印章制章人证书有效期失败！","30003@gm":"验证电子印章失败：验证电子印章的有效期失败！","30004@gm":"验证电子印章失败：验证签章人证书有效性失败！","30005@gm":"验证电子印章失败：验证电子签章数据失败！","-7@KGCrySignMessage":"签名组件错误","8@KGVerifySign":"验证失效","1@KGVerifySign":"未安装签名组件","2@KGCrySignMessage":"获取证书失败","3@KGCrySignMessage":"签名时，加载证书失败","5@KGCrySignMessage":"签名数据不能为空","6@KGCrySignMessage":"密码不能为空","7@KGCrySignMessage":"解析证书失败"},KGRunFingerPrints:{"-1":"设备类型设置错误","-2":"没有安装指纹组件","-3":"指纹采集失败"},KGRunHandWritten:{"-1":"设备类型设置错误","-2":"没有安装手写组件","-3":"授权码不正确","-4":"签名取消","-5":"无服务可用","-6":"签名设备错误","-7":"未知错误"},KGGetTSWithDigest:{1:"获取时间戳异常",2:"获取时间戳失败",3:"响应数据为空"},KGGetTSURLInfo:{1:"时间戳未启用"},KGValidate_GM:{"-1":"没有安装签名组件","-2":"没有公共模块组件","-3":"KCL280 验证失败，未知原因的验证失败",1:"KCL272_验证签章人证书失败，签章人证书已过期或未生效！",2:"KCL274 验证签章人证书失败，签章人证书根证书验证未通过!",3:" KCL270_验证签章人证书失败，签章人证书已被吊销！",4:" KCL276 验证签章人证书失败，签章人证书根证书安装未成功!",5:" KCL266_验证签章人证书失败，未检测到签章人证书吊销列表！",6:"KCL260_验证签章人证书失败，未检测到签章人证书！",7:"KCL262_验证签章人根证书失败，未检测到签章人根证书！",8:"KCL264_验证签章人根证书失败，签章人证书与该证书的根证书不匹配！",9:"KCL268_验证签章人证书失败，签章人证书与该证书吊销列表不匹配！",10:"KCL273_验证制章人证书失败，制章人证书已过期或未生效",11:"KCL275 验证制章人证书失败，制章人证书根证书验证未通过!",12:"KCL271_验证制章人证书失败，制章人证书已被吊销！",13:"KCL277_验证制章人证书失败，制章人证书根证书安装未成功!",14:"KCL267_验证制章人证书失败，未检测到制章人证书吊销列表！",15:"KCL281_验证制章人证书失败，未检测到制章人证书！",16:"KCL263_验证制章人根证书失败，未检测到制章人根证书！",17:"KCL265_验证制章人根证书失败，制章人证书与该证书的根证书不匹配！",18:"KCL269_验证制章人证书失败，制章人证书与该证书吊销列表不匹配！",19:"KCL261_验证签章人证书失败，签章人证书不在印章的签章人证书列表中！",20:"KCL278_验证印章制章时间失败，印章未生效！",21:"KCL279 验证印章制章时间失败，印章已经过期！"},KGValidateCertificate:{"-1":"没有安装签名组件","-2":"未知错误",1:"验证失败，签章证书已经过期或还未生效！",2:"验证失败，签章证书不受颁发机构信任！",3:"验证失败，签章证书已被吊销！",4:"验证失败，签章证书根证书未安装或无效的根证书！",5:"验证失败，吊销列表文件不存在！",6:"验证失败，未检测到证书！",7:"验证失败，根证书文件不存在！",8:"验证失败，根证书和该证书的根证书不配套！",9:"验证失败，吊销列表和该证书的吊销列表不配套！"},KG_MSG:{in_input_msg:"请输入密码！",in_verification_msg:"请输入验证码！",timestamp_time:"(时间来源于时间戳服务器)",server_time:"(时间来源于签章服务器)",local_time:"(时间来源于本地)",modify_signdata:"签名数据被篡改",normal_signdata:"签名数据验证正常",success_signdata:"数字签名成功！",invalid_signdata:"签章无效，不能执行数字签名！",cannot_move:"这个印章不是你当前插入的key的印章，不能移动！"},KG_TITLE:{SignatureMoveNot:"禁止移动",SignatureMoveDo:"允许移动",SignSignature:"数字签名",SignVerify:"签名验证",SignatureVerify:"签章验证",RevokeSignature:"撤销签章",KinggridSignature:"电子签章",DateSet:"日期设置",HWSignature:"手写签批",scanBCSignature:"扫码签章",moveSignature:"移动签章",ProtectedDataSet:"保护项设置"},KGVerifyGBSealAction:{"-1":"服务器通讯失败",1:"印章结构体为空",2:"印章状态无效",3:"解析异常",4:"印章已删除",5:"印章未制作",6:"印章已冻结"},KGfontColor:{"黑":"black","红":"red","蓝":"blue","绿":"green"}}),U.msg=function(e,t){return U.errCode[e]||(t?U.errCode[t]:U.errCode)[e]||e},U.options={_version:"1.0",timeout:2e4},U.Utils=k,U.Listener=e,P.prototype.getJSON=function(n){var a=this;$.ajax({url:this.url,contentType:"text/plain;charset=utf-8",type:"POST",data:p(this.data,"\r\n"),success:function(e){f.call(a,n,e)},error:function(e,t,i){f.call(a,n,y)}})},Thenjs.onerror=function(e){if(!k.is("String",e))throw e;alert("[error]"+e)},E.prototype),L=(F.init=function(e,t,i){this.serverUrl;return this.progid=e,this.interid=t,this.clientCode=i,this},F.fail=function(n){var a=this;return a.thenjs=a.thenjs.fail(function(e,t){var i=n.call(a,e,t);e(a.respData(null==i?t:i))}),a},F.fin=function(n){var a=this;return a.thenjs=a.thenjs.fin(function(e,t,i){n.call(a,e,t,i)}),a},F.then=function(t){var n=this;return n.thenjs=n.thenjs.then(function(i,e){t.call(n,function(e,t){n.respData(t),i(e,t)},e)}),n},F.series=function(e){return this.thenjs=this.thenjs.series(e),this},F.calArgs=function(e){for(var t=this._data,i=[],n=0;n<e.length;n++){var a=e[n];k.is("Function",a)&&(a=a.call(this,t)),k.is("Array",a)?i=i.concat(a):i.push(a)}return i},F.msg=function(e,t,i,n){t=t||this._method,i=i||this.progid,n||this.clientCode,n=U.errCode.then;return L.trigger("msgArg",e,t,i),U.errCode[e]||n[e+"@"+t+"."+i]||n[e+"@"+t]||n[e]||e},F.ret=function(n){var a=this;return this.then(function(e,t){var i=n.call(a,t);e(null,a.respData(null==i?t:i))}),this},F.respData=function(e){return e&&(this._data=e),this._data},F.attr=function(e){var i=this,n=g(arguments);return i.series([function(e){var t=i.calArgs(n);i._method=t[0],M.apply(null,[i.serverUrl,i.proid].concat(t))(e)}]).then(function(e,t){e(null,i.respData(t[0]))}),this},F.attrSeries=function(){var i=this,e=[];i.initProid();for(var t=0;t<arguments.length;t++)e.push(function(){var t=i.calArgs(arguments);return function(e){i._method=t[0],M.apply(null,[i.serverUrl,i.proid].concat(t))(e)}}.apply(null,arguments[t]));return i.series(e).then(function(e,t){i.respData(t),e(null,t)}),this},F.initProid=function(){var i=this;return this.series([function(e,t,i,n){L.trigger("beforeProg",arguments);var a={value:'{"GetInterface":{"progid":"'+t+'","interface":"'+i+'"},"usercode":"'+n+'"}'};return function(t){T(e+"/GetInterface",a,!1).getJSON(function(e){L.trigger("resonseProg",e),"none"==e.type?t(null,S):"0"===e.value?t(null,R):t(null,e)})}}(i.serverUrl,i.progid,i.interid,i.clientCode)]).then(function(e,t){t=t[0];L.trigger("initProid",t),t.value?(i.proid=t.value,e(null,t)):e(t.errcode)}),this},F.invokeSeries=function(){var i=this,e=[];i.initProid();for(var t=0;t<arguments.length;t++)e.push(function(){var t=i.calArgs(arguments);return function(e){i._method=t[0],B.apply(null,[i.serverUrl,i.proid,i.clientCode].concat(t))(e)}}.apply(null,arguments[t]));return i.series(e).then(function(e,t){i.respData(t),e(null,t)}),this},F.invoke=function(e){var i=this,n=(i.initProid(),g(arguments));return i.series([function(e){var t=i.calArgs(n);i._method=t[0],B.apply(null,[i.serverUrl,i.proid,i.clientCode].concat(t))(e)}]).then(function(e,t){i.respData(t[0]),e(null,t[0])}),this},F.request=function(e,t){var i=this;return i.series([function(e,i){return L.trigger("ajaxRequest",arguments),U.ajax?function(t){new P(e,i).getJSON(function(e){t(null,e)})}:function(t){T(e,i,!1).getJSON(function(e){t(null,e)})}}(i.serverUrl+e,t)]).then(function(e,t){t=t[0];i.respData(t),e(null,t)}),this},new e("kgthen"));return U.addRequestListener=function(e,t){L.on(e,t)},U.surry=function(e,t,i,n){return new E(e||"http://127.0.0.1:9581").init(t,i,n)},U.KgThen=E,U};function KGInstance(){return instance=null==instance?new KG:instance}root.kinggrid=KGInstance();var Utils=kinggrid.Utils,config=kinggrid.options,isIE8=!1,dialog=(root.JSON&&(isIE8='{"x":"中"}'!==root.JSON.stringify({x:"中"})),root.KG_Dialog),dialogConfig=(dialog&&dialog.create&&(dialog.create.prototype.button=function(e){e=e||[];var a=this,o="",s=0;return this.callbacks={},"string"==typeof e?(o=e,s++):$.each(e,function(e,t){var i=t.id=t.id||t.value,n=("cancel"==i&&(t.value="取消"),"");a.callbacks[i]=t.callback,!1===t.display?n=' style="display:none"':s++,o+='<button type="button" i-id="'+i+'"'+("cancel"==i?' class="kg-default-btn-red" ':"")+n+(t.disabled?" disabled":"")+(t.autofocus?isIE8?' class="ui-dialog-autofocus kg-primary-btn-red"':' autofocus class="ui-dialog-autofocus kg-primary-btn-red"':"")+">"+t.value+"</button>",a._$("button").on("click","[i-id="+i+"]",function(e){$(this).attr("disabled")||a._trigger(i),e.preventDefault()})}),this._$("button").html(o),this._$("footer")[s?"show":"hide"](),this}),{okValue:"确定",cancelValue:"关闭",modal:!0,fixed:!0,backdropOpacity:.2,skin:"kg-ui-dialog"}),toBase64Img=function(e){var t=e.imgdata;return 0==t.indexOf(e.signsn)&&(t=e.imgdata.substring(65)),Utils.Base64.of().encodeByte(Utils.Base64.of(e.signsn).decodeByte(t))},dialogList={},createDialog,createDialog=function(e,t){return t.id=e,(void 0!==root.iframeDialog&&root.iframeDialog?root.top:root).KG_Dialog(t)},kingDialog=function(e,t){var i=this;if(!(i instanceof kingDialog))return new kingDialog(e,t);var n=Utils.extend({},plus.dialogConfig,t),a=n.onOk,o=(a&&(delete n.onOk,n.ok=function(){return a.call(i)}),n.onCancel);o&&(delete n.onCancel,n.cancel=function(){return o.call(i)}),i.init(e,n),i.options=t,i.id=e},dialogProto=kingDialog.prototype,Switcher=(dialogProto.init=function(e,t){return this[0]=createDialog(e,t),this},dialogProto.on=function(e,t){this[0]["on"+e]=t},dialogProto.show=function(e){return this.options.iconClose&&this[0]._$("close").hide(),this.options.onShow&&this.options.onShow.call(this),this[0].show(),this},dialogProto.remove=function(){this[0].remove(),delete this[0]},dialogProto.close=function(){return this[0].close(),this},dialogProto.content=function(e){return this[0].content(e),this[0].reset(),this},dialogProto.find=function(e){return this[0]._popup.find(e)},Thenjs.onerror=function(e){if(plus.hideLoading(),!Utils.is("String",e))throw e;"client"==Signature.options.sealType&&Signature.options.isResponseErr&&"connectionErr"==e?console.warn(kinggrid.msg(e,"then")):Signature.options.errorCall?Signature.options.errorCall.call(null,{result:!1,errcode:e}):plus.alert(kinggrid.msg(e,"then"),function(){Signature.options.beginDlgOkCall&&Signature.options.beginDlgOkCall.call()},function(){Signature.options.beginDlgShowCall&&Signature.options.beginDlgShowCall.call()})},function(e,t){var i=this;i.target=$(e),t&&$.each(t,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t}),i.init()}),Tab=(Utils.extend(Switcher.prototype,{running:!1,index:0,animate:!0,init:function(){var e=this.target,t=this.wrapper=e.find(".kg-wrapper"),i=this.guide=e.find(".kg-guide"),e=t.children(".kg-slide"),n=parseInt(e.css("height")),a=e.outerWidth(!0),t=(t.css({height:n,width:e.length*a}),this.count=e.length,parseFloat(this.index,10)||0),n=t+1;e.each(function(e){this.setAttribute("index",e),i.append('<span index="'+e+'"></span>')}),this.guide.html(n+"/"+this.count),this._active(t)},_active:function(e){var t=this,i=t.index,i=(t.wrapper.children().eq(i).removeClass("active"),t.guide.children().eq(i).removeClass("active"),t.wrapper.children().eq(e).addClass("active"),t.guide.children().eq(e).addClass("active"),(this.index=e)+1);this.guide.html(i+"/"+this.count)},to:function(e){var t,i=this;i.running||(t=e%this.count)!=i.index&&(i.running=!0,e=i.wrapper.children().eq(t),e=-t*e.outerWidth(!0),this.animate?this.wrapper.animate({left:e},100,function(){i._active(t),i.running=!1}):(this.wrapper.css({left:e}),i._active(t),i.running=!1))},swipePrev:function(){var e=this.index-1;e<0&&(e=this.wrapper.children().length-1),this.to(e)},swipeNext:function(){var e=this.index+1,t=this.wrapper.children().length;this.to(e=t<e+1?0:e)}}),Utils.Switcher=Switcher,function(e){this.target=e;var e=this.nav=this.target.find(".kg-nav"),t=(this.content=this.target.find(".kg-tab-content"),this.items=e.children()),e=e.children(".active");0==e.length&&(e=t.eq(0)),this._getClassName(),this.active(e),this.init()}),plus=(Tab.prototype={active:function(e){this.activeLi&&(this.activeContent.removeClass("active"),this.activeLi.removeClass("active")),e.addClass("active");var t=e.children("a").attr("kg-target"),t=(this.target.find(".kg-nav li a").each(function(){$(this).removeClass(this.className)}),e.children("a").addClass(this.className),this.target.find("."+t));t.addClass("active"),this.activeLi=e,this.activeContent=t},init:function(){var t=this;this.target.find(".kg-nav li").click(function(e){e.preventDefault();e=$(this);e.hasClass("active")||t.active(e)}),t._location()},_location:function(){var n=this.items.length,e=document.body.clientWidth,a=Signature.options.isMobile&&e<375?e:430;this.items.each(function(e,t){var i=$(t).width(),i=(a-i*n)/2;$(t).offset({left:i})})},_getClassName:function(){var e=this;this.target.find(".kg-nav li a").each(function(){e.className=$(this).attr("class")})}},Utils.tab=function(e){return new Tab(e)},{dialogConfig:dialogConfig,alertConfig:{},loadingConfig:{}}),internationalization=Utils.internationalization=function(){try{$("[i-id=cancel]").html($.kgi18n.prop("Close")),$("[data-kgi18n-html]").each(function(e){$(this).html($.kgi18n.prop($(this).data("kgi18n-html"))),$(this).addClass("kg-fontFamily")}),$("[data-kgi18n-value]").each(function(e){$(this).val($.kgi18n.prop($(this).data("kgi18n-value"))),$(this).addClass("kg-fontFamily")}),$("[data-kgi18n-title]").each(function(e){$(this).attr("title",$.kgi18n.prop($(this).data("kgi18n-title"))),$(this).addClass("kg-fontFamily")}),$(".kg-default-btn-red").each(function(){$(this).addClass("kg-fontFamily")}),$(".kg-primary-btn-red").each(function(){$(this).addClass("kg-fontFamily")}),$(".kg-default-btn-blue").each(function(){$(this).addClass("kg-fontFamily")}),$(".kg-primary-btn-blue").each(function(){$(this).addClass("kg-fontFamily")}),$(".kg-tab-content").find(".kg-label").each(function(e){$(this).removeClass().addClass("kg-label").addClass(Signature.options.Global+"-label")});$(".kg-tab-content").find(".kg-value").each(function(e){$(this).removeClass().addClass("kg-value").addClass(Signature.options.Global+"-value")});var e=$("[data-kgi18n-html=SignatureDate]").next().html();if(e)for(var t=e.indexOf("("),i=e.substring(t),n=["(时间来源于时间戳服务器)","(時間來源於時間戳服務器)","(The time comes from the timestamp server)","(时间来源于签章服务器)","(時間來源於簽章服務器)","(Time comes from signature server)","(时间来源于本地)","(時間來源於本地)","(Time comes from local)"],a=0;a<n.length;a++)i==n[a]&&(e=a<3?e.substring(0,t)+$.kgi18n.prop("KG_MSGtimestamp_time"):3<=a&&a<6?e.substring(0,t)+$.kgi18n.prop("KG_MSGserver_time"):e.substring(0,t)+$.kgi18n.prop("KG_MSGlocal_time"),$("[data-kgi18n-html=SignatureDate]").next().html(e))}catch(e){}},showCacheDialog=function(e,t,i){var n,a=dialogList[e];return a||((n=i.okCall)&&delete i.okCall,i=Utils.extend({onOk:function(){var e=!0;return(e=n?0!=n.call(this):e)&&this.close().remove(),!1},cancel:!1},i),a=dialogList[e]=plus.showDialog(e,i)),a.on("remove",function(){delete dialogList[e]}),a.content(t),internationalization(),a},template=(plus.alert=function(e,t,i){t=Utils.extend({title:$.kgi18n.prop("OtherInfoTip"),onShow:function(){return Signature.editThemeColor(),i},okCall:t},plus.alertConfig);return showCacheDialog("alert",'<div class="kg-dialog kg-alert" ><i class="kg-icon kg-icon-attention-circled"></i>'+e+"</div>",t)},plus.showLoading=function(e){var t=Utils.extend({onOk:!1},plus.loadingConfig);return showCacheDialog("loading",'<div class="kg-loading"><img title="加载中..." src="data:image/gif;base64,R0lGODlhIAAgALMAAP///7Ozs/v7+9bW1uHh4fLy8rq6uoGBgTQ0NAEBARsbG8TExJeXl/39/VRUVAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFBQAAACwAAAAAIAAgAAAE5xDISSlLrOrNp0pKNRCdFhxVolJLEJQUoSgOpSYT4RowNSsvyW1icA16k8MMMRkCBjskBTFDAZyuAEkqCfxIQ2hgQRFvAQEEIjNxVDW6XNE4YagRjuBCwe60smQUDnd4Rz1ZAQZnFAGDd0hihh12CEE9kjAEVlycXIg7BAsMB6SlnJ87paqbSKiKoqusnbMdmDC2tXQlkUhziYtyWTxIfy6BE8WJt5YEvpJivxNaGmLHT0VnOgGYf0dZXS7APdpB309RnHOG5gDqXGLDaC457D1zZ/V/nmOM82XiHQjYKhKP1oZmADdEAAAh+QQFBQAAACwAAAAAGAAXAAAEchDISasKNeuJFKoHs4mUYlJIkmjIV54Soypsa0wmLSnqoTEtBw52mG0AjhYpBxioEqRNy8V0qFzNw+GGwlJki4lBqx1IBgjMkRIghwjrzcDti2/Gh7D9qN774wQGAYOEfwCChIV/gYmDho+QkZKTR3p7EQAh+QQFBQAAACwBAAAAHQAOAAAEchDISWdANesNHHJZwE2DUSEo5SjKKB2HOKGYFLD1CB/DnEoIlkti2PlyuKGEATMBaAACSyGbEDYD4zN1YIEmh0SCQQgYehNmTNNaKsQJXmBuuEYPi9ECAU/UFnNzeUp9VBQEBoFOLmFxWHNoQw6RWEocEQAh+QQFBQAAACwHAAAAGQARAAAEaRDICdZZNOvNDsvfBhBDdpwZgohBgE3nQaki0AYEjEqOGmqDlkEnAzBUjhrA0CoBYhLVSkm4SaAAWkahCFAWTU0A4RxzFWJnzXFWJJWb9pTihRu5dvghl+/7NQmBggo/fYKHCX8AiAmEEQAh+QQFBQAAACwOAAAAEgAYAAAEZXCwAaq9ODAMDOUAI17McYDhWA3mCYpb1RooXBktmsbt944BU6zCQCBQiwPB4jAihiCK86irTB20qvWp7Xq/FYV4TNWNz4oqWoEIgL0HX/eQSLi69boCikTkE2VVDAp5d1p0CW4RACH5BAUFAAAALA4AAAASAB4AAASAkBgCqr3YBIMXvkEIMsxXhcFFpiZqBaTXisBClibgAnd+ijYGq2I4HAamwXBgNHJ8BEbzgPNNjz7LwpnFDLvgLGJMdnw/5DRCrHaE3xbKm6FQwOt1xDnpwCvcJgcJMgEIeCYOCQlrF4YmBIoJVV2CCXZvCooHbwGRcAiKcmFUJhEAIfkEBQUAAAAsDwABABEAHwAABHsQyAkGoRivELInnOFlBjeM1BCiFBdcbMUtKQdTN0CUJru5NJQrYMh5VIFTTKJcOj2HqJQRhEqvqGuU+uw6AwgEwxkOO55lxIihoDjKY8pBoThPxmpAYi+hKzoeewkTdHkZghMIdCOIhIuHfBMOjxiNLR4KCW1ODAlxSxEAIfkEBQUAAAAsCAAOABgAEgAABGwQyEkrCDgbYvvMoOF5ILaNaIoGKroch9hacD3MFMHUBzMHiBtgwJMBFolDB4GoGGBCACKRcAAUWAmzOWJQExysQsJgWj0KqvKalTiYPhp1LBFTtp10Is6mT5gdVFx1bRN8FTsVCAqDOB9+KhEAIfkEBQUAAAAsAgASAB0ADgAABHgQyEmrBePS4bQdQZBdR5IcHmWEgUFQgWKaKbWwwSIhc4LonsXhBSCsQoOSScGQDJiWwOHQnAxWBIYJNXEoFCiEWDI9jCzESey7GwMM5doEwW4jJoypQQ743u1WcTV0CgFzbhJ5XClfHYd/EwZnHoYVDgiOfHKQNREAIfkEBQUAAAAsAAAPABkAEQAABGeQqUQruDjrW3vaYCZ5X2ie6EkcKaooTAsi7ytnTq046BBsNcTvItz4AotMwKZBIC6H6CVAJaCcT0CUBTgaTg5nTCu9GKiDEMPJg5YBBOpwlnVzLwtqyKnZagZWahoMB2M3GgsHSRsRACH5BAUFAAAALAEACAARABgAAARcMKR0gL34npkUyyCAcAmyhBijkGi2UW02VHFt33iu7yiDIDaD4/erEYGDlu/nuBAOJ9Dvc2EcDgFAYIuaXS3bbOh6MIC5IAP5Eh5fk2exC4tpgwZyiyFgvhEMBBEAIfkEBQUAAAAsAAACAA4AHQAABHMQyAnYoViSlFDGXBJ808Ep5KRwV8qEg+pRCOeoioKMwJK0Ekcu54h9AoghKgXIMZgAApQZcCCu2Ax2O6NUud2pmJcyHA4L0uDM/ljYDCnGfGakJQE5YH0wUBYBAUYfBIFkHwaBgxkDgX5lgXpHAXcpBIsRADs="></div>',t)},plus.hideLoading=function(){var e=dialogList.loading;e&&e.close().remove()},plus.hideDialog=function(e){e=root.KG_Dialog.list[e];e&&e.close().remove()},plus.showDialog=function(e,t){e=kingDialog(e,t);return e.show(),internationalization(),e},plus.template={sealTpl_noInput:'<div class="kg-dialog kg-dialog-runSignature" id="sealTpl-dialog"><% if(this.thirdConfig != null){%><div class="kg-postil" id="kg-postil" ><div class="kg-form"><div class="form-item clearfix i-postil"><div class="kg-sm kg-sm-1"></div><label class="kg-sm kg-sm-8 kg-postil-label" data-kgi18n-html="TextPostil">文字批注</label></div><div class="form-item clearfix"><div class="kg-sm kg-sm-1"></div><div class="kg-sm kg-sm-3" data-kgi18n-html="CommonLanguage">常用语：</div><div class="kg-sm kg-sm-5"><select id="i-kg-common-lang" style="width:90px;" ><option value=""></option><% for(var i = 0;this.thirdConfig != null && this.thirdConfig.commonlang != null && i<this.thirdConfig.commonlang.length;i++){ %><option value=""><% this.thirdConfig.commonlang[i]%></option><% }%></select></div><div class="kg-sm kg-sm-2"><a href="#" title="字体" class="kg-fontSet kg-fontSet-font" id="kg-fontSet"><i class="kg-font-text"></i></a><a href="#" title="编辑" class="kg-fontSet kg-fontSet-edit" id="kg-fontSet"><i class="kg-font-edit"></i></a></div></div></div><div class="kg-common-lang"><div class="kg-form"><div class="form-item clearfix"><div class="kg-sm kg-sm-1"></div><textarea id="kg-postil-value" class="kg-sm kg-sm-10 kg-postil-value" maxlength="140"></textarea></div></div></div></div><div class="kg-form"><div class="form-item clearfix i-postil"><div class="kg-sm kg-sm-1"></div><label class="kg-sm kg-sm-8 kg-postil-label" data-kgi18n-html="SignaturePicture">签章图片</label></div></div><% } %><div class=" kg-switcher" id="kg-switcher" ><a class="arrow-left arrow" href="#"><i class="kg-icon kg-icon-angle-left kg-primary-arrow-red"><</i></a><a class="arrow-right arrow" href="#"><i class="kg-icon kg-icon-angle-right kg-primary-arrow-red">></i></a><div class="kg-pagin"><d\tiv class="kg-guide"></div>\t</div><div class="kg-container"><div class="kg-wrapper"><% var seals = this.seals; %><% for(var i=0;i<seals.length;i++) {%><div class="kg-slide" title="<%seals[i].signname%>"><div class="kg-image"><div class="title"><%seals[i].signname%></div><a class="kg-img" href="#" ><img src="data:image/<%seals[i].imgext.substring(1)%>;base64,<%arguments[arguments.length-1](seals[i])%>"></a></div><div class="kg-shade" style="z-index:100;"><img width="100%" height="100%"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII="></div></div><%}%></div></div></div><div class="kg-form"><div class="kg-sm kg-sm-2"></div><div class="form-item clearfix i-addDate"><div class="kg-sm kg-sm-8"><% if(this.signDateIsCheck){ %><input type="checkbox" name="addDate" id="kg-addDate" class="<%this.isMobile?"":"kg-primary-check-red"%> id="<%this.isMobile%>" class="<%this.isMobile?"":"kg-primary-check-red"%>" checked="checked">&nbsp;<label for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;&nbsp;&nbsp;&nbsp;<%}else{%><input type="checkbox" name="addDate" id="kg-addDate" class="<%this.isMobile?"":"kg-primary-check-red"%> id="<%this.isMobile%>" class="<%this.isMobile?" ":"kg-primary-check-red"%>" >&nbsp;<label for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;&nbsp;&nbsp;&nbsp;<%}%><input type="button"  name="dateSet" id="kg-dateSet" class="kg-second-btn-red" data-kgi18n-value="Setting" value="设置"/><% if(this.showProtectedBtn){%>&nbsp;<input type="button"  name="proDataSet" class="kg-second-btn-red" id="kg-protectedDataSet" data-kgi18n-value="Protection" value="保护项"/><%}%></div></div></div></div></div>',sealTpl:'<div class="kg-dialog kg-dialog-runSignature" id="sealTpl-dialog"><%if(this.thirdConfig != null){%><div class="kg-postil" id="kg-postil"><div class="kg-form"><div class="form-item clearfix i-postil"><div class="kg-sm kg-sm-1"></div><label class="kg-sm kg-sm-8 kg-postil-label" data-kgi18n-html="TextPostil">文字批注</label></div><div class="form-item clearfix"><div class="kg-sm kg-sm-1"></div><div class="kg-sm kg-sm-3" data-kgi18n-html="CommonLanguage">常用语：</div><div class="kg-sm kg-sm-5"><select id="i-kg-common-lang" style="width:90px;" ><option value=""></option><% for(var i = 0;this.thirdConfig != null && this.thirdConfig.commonlang != null && i<this.thirdConfig.commonlang.length;i++){ %><option value=""><% this.thirdConfig.commonlang[i]%></option><% }%></select></div><div class="kg-sm kg-sm-2"><a href="#" title="字体" class="kg-fontSet kg-fontSet-font" id="kg-fontSet"><i class="kg-font-text"></i></a><a href="#" title="编辑" class="kg-fontSet kg-fontSet-edit" id="kg-fontSet"><i class="kg-font-edit"></i></a></div></div></div><div class="kg-common-lang"><div class="kg-form"><div class="form-item clearfix"><div class="kg-sm kg-sm-1"></div><textarea id="kg-postil-value" class="kg-sm kg-sm-10 kg-postil-value" maxlength="140"></textarea></div></div></div></div><div class="kg-form"><div class="form-item clearfix i-postil"><div class="kg-sm kg-sm-1"></div><label class="kg-sm kg-sm-8 kg-postil-label" data-kgi18n-html="SignaturePicture">签章图片</label></div></div><%} %><div class=" kg-switcher" id="kg-switcher" ><a class="arrow-left arrow" href="#"><i class="kg-icon kg-icon-angle-left kg-primary-arrow-red"><</i></a><a class="arrow-right arrow" href="#"><i class="kg-icon kg-icon-angle-right kg-primary-arrow-red">></i></a><div class="kg-pagin"><d\tiv class="kg-guide"></div></div><div class="kg-container" ><div class="kg-wrapper"><% var seals = this.seals; %><% for(var i=0;i<seals.length;i++) {%><div class="kg-slide" title="<%seals[i].signname%>"><div class="kg-image"><div class="title"><%seals[i].signname%></div><a class="kg-img" href="#" ><img src="data:image/<%seals[i].imgext.substring(1)%>;base64,<%arguments[arguments.length-1](seals[i])%>"></a></div><div class="kg-shade" style="z-index:100;"><img width="100%" height="100%"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII="></div></div><%}%></div></div></div><div class="kg-form"><% if(this.verification){%><div class="form-item clearfix i-password"><div class="kg-sm kg-sm-2"></div><div class="kg-sm kg-sm-8"><div style="position:relative"><input name="" style="text-indent:10px" id="kg-verification" class="form-control"/><span class="kg-verificationButton <%this.Global%>-verificationButton kg-second-btn-red" title="获取短信验证码" data-kgi18n-html="VerifyCode">验证码</span><span class="kg-tip <%this.Global%>-tip"></span><span class="kg-tipText"></span><span class="kg-verificationMark"/></div></div><div class="kg-sm kg-sm-2"></div></div><%}else{%><% if(!this.noPassWord){%><div class="form-item clearfix i-password"><div class="kg-sm kg-sm-2"></div><label class="<%this.Global%>-sm <%this.Global%>-password-l kg-label" data-kgi18n-html="PassWord">密码</label><div class="<%this.Global%>-sm <%this.Global%>-password-r"><input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div><div class="kg-sm kg-sm-2"></div></div><%}%><%}%><div class="kg-sm kg-sm-2"></div><div class="form-item clearfix i-password kg-pwd"><div class="<%this.Global%>-sm <%this.Global%>-remenberPwd"><% if(this.verification){%><% if(this.signDateIsCheck){ %><input type="checkbox" name="addDate" id="kg-addDate"   class="<%this.isMobile?"":"kg-primary-check-red"%>" checked="checked">&nbsp;<label style="display:inline;" for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;<%}else{%><input type="checkbox" name="addDate" id="kg-addDate" class="<%this.isMobile?"":"kg-primary-check-red"%>" >&nbsp;<label style="display:inline;" for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;<%}%><input type="button"  name="dateSet" id="kg-dateSet" class="kg-second-btn-red" data-kgi18n-value="Setting" value="设置"/><%}else{%><% if(this.showRememberPwd){%><input type="checkbox" name="remenberPwd" class="<%this.isMobile?"":"kg-primary-check-red"%>" id="kg-remenberPwd">&nbsp;<label style="display:inline;"  for="kg-remenberPwd" data-kgi18n-html="RememberMe">记住密码</label><%}%><%}%><% if(this.showProtectedBtn){%>&nbsp;<input type="button"  name="proDataSet" id="kg-protectedDataSet" class="kg-second-btn-red" data-kgi18n-value="Protection" value="保护项"/><%}%></div></div></div><div  id="rememberPwdAndNotShowSealTpl-container" class="kg-hide"><div class="kg-sm kg-sm-2"></div><div class="form-item clearfix i-password kg-pwd"><div class="<%this.Global%>-sm <%this.Global%>-remenberPwd"><input type="checkbox" name="rememberPwdAndNotShowSealTpl" class="<%this.isMobile?"":"kg-primary-check-red"%>" id="kg-rememberPwdAndNotShowSealTpl">&nbsp;<label style="display:inline;"  for="kg-rememberPwdAndNotShowSealTpl" data-kgi18n-html="RememberMeAndNotShowSealTpl">有效期内不显示签章选择框</label></div></div></div><div class="kg-sm kg-sm-2"></div><% if(this.verification){%><%}else{%><div class="form-item clearfix i-addDate"><div class="<%this.Global%>-sm <%this.Global%>-addDate"><% if(this.signDateIsCheck){ %><input type="checkbox" name="addDate" id="kg-addDate"   class="<%this.isMobile?"":"kg-primary-check-red"%>" checked="checked">&nbsp;<label style="display:inline;" for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;<%}else{%><input type="checkbox" name="addDate" id="kg-addDate" class="<%this.isMobile?"":"kg-primary-check-red"%>" >&nbsp;<label style="display:inline;" for="kg-addDate" data-kgi18n-html="AddData">附加时间</label>&nbsp;<%}%><input type="button"  name="dateSet" id="kg-dateSet" class="kg-second-btn-red" data-kgi18n-value="Setting" value="设置"/></div></div><%}%></div></div></div>',inputTpl:'<div id="kg-verifyPass" class="kg-dialog kg-dialog-password"><div class="kg-form"><div class="form-item clearfix i-password"><label class="kg-sm kg-sm-3 kg-label" data-kgi18n-html="PassWord">密码</label><div class="kg-sm kg-sm-8"><input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div></div><div class="kg-sm kg-sm-3"></div><div class="kg-sm kg-sm-8"><input type="checkbox" name="remenberPwd" class="<%this.isMobile?"":"kg-primary-check-red"%>" id="kg-remenberPwd" >&nbsp;<label for="kg-remenberPwd" data-kgi18n-html="RememberMe">记住密码</label></div></div></div></div>',prompt:'<div id="kg-verifyPass" class="kg-dialog kg-dialog-prompt"><div class="kg-promtInfo"></div></div>'}),font=plus.fontTemplate={fontFormat:["yyyy-M-d","yyyy.M.d","yyyy/M/d","yyyy年M月d日","yy/M/d","yy.M.d","yyyy-MM-dd","yyyy/MM/dd","yyyy.MM.dd","yyyy年M月d日*","yyyy年M月d日**","MM/dd","MM.dd","M/d","M.d","d-MMM-yyyy","d-MMM-yy","yyyy-M-d hh:mm:ss"],fontFamily:["@Arial Unicode MS","@Fixedsys","@Malgun Gothic","@Malgun Gothic Semilight","@Meiryo","@Meiryo UI","@Microsoft JhengHei","@Microsoft JhengHei Light","@Microsoft JhengHei UI","@Microsoft JhengHei UI Light","@Microsoft YaHei UI","@Microsoft YaHei UI Light","@MingLiU_HKSCS-ExtB","@MingLiU-ExtB","@MS Gothic","@MS PGothic","@MS UI Gothic","@PMingLiU-ExtB","@SimSun-ExtB","@System","@Terminal","@Yu Gothic","@Yu Gothic Light","@Yu Gothic Medium","@Yu Gothic UI","@Yu Gothic UI Light","@Yu Gothic UI Semibold","@Yu Gothic UI Semilight","@等线","@等线 Light","@方正兰亭超细黑简体","@方正舒体","@方正姚体","@仿宋","@黑体","@华文彩云","@华文仿宋","@华文行楷","@华文琥珀","@华文楷体","@华文隶书","@华文宋体","@华文细黑","@华文新魏","@华文中宋","@楷体","@隶书","@宋体","@微软雅黑","@微软雅黑 Light","@新宋体","@幼圆","ADMUI3Lg","ADMUI3Sm","Agency FB","Algerian","Arial","Arial Black","Arial Narrow","Arial Rounded MT Bold","Arial Unicode MS","Axure Handwriting","Baskerville Old Face","Bauhaus 93","Bell MT","Berlin Sans FB","Berlin Sans FB Demi","Bernard MT Condensed","Blackadder ITC","Bodoni MT","Bodoni MT Black","Bodoni MT Condensed","Bodoni MT Poster Compressed","Book Antiqua","Bookman Old Style","Bookshelf Symbol 7","Bradley Hand ITC","Britannic Bold","Broadway","Brush Script MT","Calibri","Calibri Light","Californian FB","Calisto MT","Cambria","Cambria Math","Candara","Castellar","Centaur","Century","Century Gothic","Century Schoolbook","Chiller","Colonna MT","Comic Sans MS","Consolas","Constantia","Cooper Black","Copperplate Gothic Bold","Copperplate Gothic Light","Corbel","Courier","Courier New","Curlz MT","Default","Ebrima","Edwardian Script ITC","Elephant","Engravers MT","Eras Bold ITC","Eras Demi ITC","Eras Light ITC","Eras Medium ITC","Euro Sign","Felix Titling","Fixedsys","Footlight MT Light","Forte","Franklin Gothic Book","Franklin Gothic Demi","Franklin Gothic Demi Cond","Franklin Gothic Heavy","Franklin Gothic Medium","Franklin Gothic Medium Cond","Freestyle Script","French Script MT","Gabriola","Gadugi","Garamond","Georgia","Gigi","Gill Sans MT","Gill Sans MT Condensed","Gill Sans MT Ext Condensed Bold","Gill Sans Ultra Bold","Gill Sans Ultra Bold Condensed","Gloucester MT Extra Condensed","Goudy Old Style","Goudy Stout","Haettenschweiler","Harlow Solid Italic","Harrington","High Tower Text","Impact","Imprint MT Shadow","Informal Roman","Javanese Text","Jokerman","Juice ITC","Kristen ITC","Kunstler Script","Leelawadee UI","Leelawadee UI Semilight","Lucida Bright","Lucida Calligraphy","Lucida Console","Lucida Fax","Lucida Handwriting","Lucida Sans","Lucida Sans Typewriter","Lucida Sans Unicode","Magneto","Maiandra GD","Malgun Gothic","Malgun Gothic Semilight","Marlett","Matura MT Script Capitals","Meiryo","Meiryo UI","Microsoft Himalaya","Microsoft JhengHei","Microsoft JhengHei Light","Microsoft JhengHei UI","Microsoft JhengHei UI Light","Microsoft New Tai Lue","Microsoft PhagsPa","Microsoft Sans Serif","Microsoft Tai Le","Microsoft YaHei UI","Microsoft YaHei UI Light","Microsoft Yi Baiti","MingLiU_HKSCS-ExtB","MingLiU-ExtB","Mistral","Modern","Modern No. 20","Mongolian Baiti","Monotype Corsiva","MS Gothic","MS Outlook","MS PGothic","MS Reference Sans Serif","MS Reference Specialty","MS Sans Serif","MS Serif","MS UI Gothic","MT Extra","MV Boli","Myanmar Text","Niagara Engraved","Niagara Solid","Nirmala UI","Nirmala UI Semilight","OCR A Extended","Old English Text MT","Onyx","Palace Script MT","Palatino Linotype","Papyrus","Parchment","Perpetua","Perpetua Titling MT","Playbill","PMingLiU-ExtB","Poor Richard","Pristina","Rage Italic","Ravie","Rockwell","Rockwell Condensed","Rockwell Extra Bold","Roman","Script","Script MT Bold","Segoe MDL2 Assets","Segoe Print","Segoe Script","Segoe UI","Segoe UI Black","Segoe UI Emoji","Segoe UI Historic","Segoe UI Light","Segoe UI Semibold","Segoe UI Semilight","Segoe UI Symbol","Showcard Gothic","SimSun-ExtB","Sitka Banner","Sitka Display","Sitka Heading","Sitka Small","Sitka Subheading","Sitka Text","Small Fonts","Snap ITC","Stencil","Sylfaen","Symbol","System","Tahoma","TeamViewer11","Tempus Sans ITC","Terminal","Times New Roman","Trebuchet MS","Tw Cen MT","Tw Cen MT Condensed","Tw Cen MT Condensed Extra Bold","Verdana","Viner Hand ITC","Vivaldi","Vladimir Script","Webdings","Wide Latin","Wingdings","Wingdings 2","Wingdings 3","Yu Gothic","Yu Gothic Light","Yu Gothic Medium","Yu Gothic UI","Yu Gothic UI Light","Yu Gothic UI Semibold","Yu Gothic UI Semilight","ZWAdobeF","等线","等线 Light","方正兰亭超细黑简体","方正舒体","方正姚体","仿宋","黑体","华文彩云","华文仿宋","华文行楷","华文琥珀","华文楷体","华文隶书","华文宋体","华文细黑","华文新魏","华文中宋","楷体","隶书","宋体","微软雅黑","微软雅黑 Light","新宋体","幼圆"],fontSize:[8,9,10,11,12,14,16,18,20,22,24,26,28,36,48,72],fontColor:["#000000","#800000","#008000","#808000","#000080","#800080","#008080","#808080","#C0C0C0","#FFFFFF","#FF0000","#00FF00","#FFFF00","#0000FF","#FF00FF","#00FFFF"],fontPosition:[["center","middle","inside","",""],["center","bottom","inside","",""],["right","middle","inside","",""],["right","bottom","inside","",""],["right","top","outside","left",""],["center","top","outside","","below"],["left","middle","outside","right",""],["right","top","outside","","below"],["left","bottom","outside","right",""],["left","top","outside","right","below"]],position:["居中","居中下(章内)","居右中(章内)","居右下(章内)","居左上(章外)","居中下(章外)","居右中(章外)","居右下(章下)","居右下(章右)","居右下(章右下)"]},fontFamily=plus.fontFamily=[{ename:"sans-serif",zname:"sans-serif"},{ename:"SimSun",zname:"宋体"},{ename:"SimHei",zname:"黑体"},{ename:"Microsoft Yahei",zname:"微软雅黑"},{ename:"Microsoft JhengHei",zname:"微软正黑体"},{ename:"KaiTi",zname:"楷体"},{ename:"NSimSun",zname:"新宋体"},{ename:"FangSong",zname:"仿宋"},{ename:"PingFang SC",zname:"苹方"}],dafaultDate=plus.dafaultDate="2017/01/01 12:00:00",defaultFont=plus.defaultFont={fontFormat:plus.fontTemplate.fontFormat[0],fontFamily:"宋体",fontSize:12,fontColor:"#000000",position:plus.fontTemplate.position[0]},formatArgs=(plus.kgFont=function(e){var t,i=new Object;return i.fontFormat=e.fontFormat||plus.defaultFont.fontFormat,i.fontFamily=e.fontFamily||plus.defaultFont.fontFamily,i.fontSize=e.fontSize||plus.defaultFont.fontSize,i.fontColor=e.fontColor||plus.defaultFont.fontColor,null!=e.position?(t=jQuery.inArray(e.position,plus.fontTemplate.position),i.fontPosition=plus.fontTemplate.fontPosition[t]):e.fontPositionIndex?i.fontPosition=plus.fontTemplate.fontPosition[e.fontPositionIndex]:(t=jQuery.inArray(plus.defaultFont.position,plus.fontTemplate.position),i.fontPosition=plus.fontTemplate.fontPosition[t]),i},function(e){var t,i,n=[e],a=Utils.slice(arguments,1);return 0<a.length&&(i=a[0],1<a.length&&(t=a.slice(1))),n.push(i),n.concat(t)}),noop=(plus.showTplDialog=function(e,t,i){var n=Utils.slice(arguments,2),a=Utils.extend({content:function(){return Utils.template.apply(null,[template[e]].concat(n))}},t);return plus.showDialog(e,a)},plus.showTemplateDialog=function(e){var t=formatArgs.apply(null,Utils.slice(arguments));return plus.showTplDialog.apply(plus,t)},plus.create=function(e){Utils.extend(this,plus),this.king=e},function(){return plus.hideLoading(),!0}),proto=plus.create.prototype,kingPlus=function(e){return 0==arguments.length?plus:new plus.create(e)},debug=(kingPlus.changeSkin=function(e){Utils.extend(kingDialog.prototype,e)},root.kingPlus=kingPlus,jQuery.kgi18n={},jQuery.kgi18n.map={},function(e){window.console&&console.log("i18n::"+e)}),xhr;function callbackIfComplete(e){e.debug&&(debug("callbackIfComplete()"),debug("totalFiles: "+e.totalFiles),debug("filesLoaded: "+e.filesLoaded)),e.async&&e.filesLoaded===e.totalFiles&&e.callback&&e.callback()}function loadAndParseFiles(e,t){t.debug&&debug("loadAndParseFiles"),null!==e&&0<e.length?loadAndParseFile(e[0],t,function(){e.shift(),loadAndParseFiles(e,t)}):callbackIfComplete(t)}if(Function.prototype.method=function(e,t){return this.prototype[e]=t,this},String.prototype.trim||(String.method("trim",function(){return this.replace(/^\s+|\s+$/g,"")}),String.method("ltrim",function(){return this.replace(/^\s+/g,"")}),String.method("rtrim",function(){return this.replace(/\s+$/g,"")})),jQuery.kgi18n.properties=function(n){(n=jQuery.extend({name:"Messages",language:"",path:"",namespace:null,mode:"vars",cache:!1,debug:!1,encoding:"UTF-8",async:!1,callback:null},n)).namespace&&"string"==typeof n.namespace&&(n.namespace.match(/^[a-z]*$/)?jQuery.kgi18n.map[n.namespace]={}:(debug("Namespaces can only be lower case letters, a - z"),n.namespace=null)),n.path.match(/\/$/)||(n.path+="/"),n.language=this.normaliseLanguageCode(n);var e=n.name&&n.name.constructor===Array?n.name:[n.name];n.totalFiles=2*e.length+(5<=n.language.length?e.length:0),n.debug&&debug("totalFiles: "+n.totalFiles),n.filesLoaded=0,e.forEach(function(e){n.path;var t,i=n.language.substring(0,2);n.path;5<=n.language.length&&(i=n.language.substring(0,5),t=n.path+e+"_"+i+".properties"),loadAndParseFiles([t],n)}),n.callback&&!n.async&&n.callback()},jQuery.kgi18n.prop=function(e){var t,i,n,a=[].slice.call(arguments),o=(2==a.length&&($.isArray(a[1])?t=a[1]:"object"==typeof a[1]&&(i=a[1].namespace,n=a[1].replacements,a.splice(-1,1),n&&Array.prototype.push.apply(a,n))),(i?jQuery.kgi18n.map[i]:jQuery.kgi18n.map)[e]);if(null===o)return"["+(i?i+"#"+e:e)+"]";if("string"==typeof o){for(g=0;-1!=(g=o.indexOf("\\",g));)o="t"==o.charAt(g+1)?o.substring(0,g)+"\t"+o.substring(2+g++):"r"==o.charAt(g+1)?o.substring(0,g)+"\r"+o.substring(2+g++):"n"==o.charAt(g+1)?o.substring(0,g)+"\n"+o.substring(2+g++):"f"==o.charAt(g+1)?o.substring(0,g)+"\f"+o.substring(2+g++):"\\"==o.charAt(g+1)?o.substring(0,g)+"\\"+o.substring(2+g++):o.substring(0,g)+o.substring(g+1);for(var s,r,l,c=[],g=0;g<o.length;)if("'"==o.charAt(g))if(g==o.length-1)o=o.substring(0,g);else if("'"==o.charAt(g+1))o=o.substring(0,g)+o.substring(++g);else{for(l=g+2;-1!=(l=o.indexOf("'",l));){if(l==o.length-1||"'"!=o.charAt(l+1)){o=o.substring(0,g)+o.substring(g+1,l)+o.substring(l+1),g=l-1;break}o=o.substring(0,l)+o.substring(++l)}-1==l&&(o=o.substring(0,g)+o.substring(g+1))}else"{"!=o.charAt(g)||-1==(l=o.indexOf("}",g+1))?g++:(r=parseInt(o.substring(g+1,l)),!isNaN(r)&&0<=r?(""!==(s=o.substring(0,g))&&c.push(s),c.push(r),g=0,o=o.substring(l+1)):g=l+1);""!==o&&c.push(o),o=c,i?jQuery.kgi18n.map[settings.namespace][e]=c:jQuery.kgi18n.map[e]=c}if(!o||0===o.length)return"";if(1==o.length&&"string"==typeof o[0])return o[0];var d="";for(g=0,l=o.length;g<l;g++)"string"==typeof o[g]?d+=o[g]:t&&o[g]<t.length?d+=t[o[g]]:!t&&o[g]+1<a.length?d+=a[o[g]+1]:d+="{"+o[g]+"}";return d},window.XMLHttpRequest)xhr=new XMLHttpRequest;else if(window.ActiveXObject)for(var activexName=["MSXML2.XMLHTTP","Microsoft.XMLHTTP"],i=0;i<activexName.length;i++)try{xhr=new ActiveXObject(activexName[i]);break}catch(e){}function loadAndParseFile(e,t,i){t.debug&&(debug("loadAndParseFile('"+e+"')"),debug("totalFiles: "+t.totalFiles),debug("filesLoaded: "+t.filesLoaded)),null!=e&&(xhr.onreadystatechange=function(){4==xhr.readyState&&200==xhr.status&&(t.debug&&(debug("Succeeded in downloading "+e+"."),debug(xhr.responseText)),parseData(xhr.responseText,t),i())},xhr.open("GET",e,t.cache),xhr.onerror=function(){t.debug&&debug("Failed to download or parse "+e+". errorThrown: "),404===jqXHR.status&&--t.totalFiles,i()},xhr.send())}function parseData(data,settings){for(var parsed="",lines=data.split(/\n/),regPlaceHolder=/(\{\d+})/g,regRepPlaceHolder=/\{(\d+)}/g,unicodeRE=/(\\u.{4})/gi,i=0,j=lines.length;i<j;i++){var line=lines[i],line=line.trim();if(0<line.length&&"#"!=line.match("^#")){var pair=line.split("=");if(0<pair.length){for(var name=decodeURI(pair[0]).trim(),value=1==pair.length?"":pair[1];-1!=value.search(/\\$/);)value=value.substring(0,value.length-1),value+=lines[++i].trimRight();for(var s=2,unicodeMatches,parts,first,fnArgs,usedArgs,fnExpr,value;s<pair.length;s++)value+="="+pair[s];value=value.trim(),"map"!=settings.mode&&"both"!=settings.mode||(unicodeMatches=value.match(unicodeRE),unicodeMatches&&unicodeMatches.forEach(function(e){value=value.replace(e,unescapeUnicode(e))}),settings.namespace?jQuery.kgi18n.map[settings.namespace][name]=value:jQuery.kgi18n.map[name]=value),"vars"!=settings.mode&&"both"!=settings.mode||(value=value.replace(/"/g,'\\"'),checkKeyNamespace(name),regPlaceHolder.test(value)?(parts=value.split(regPlaceHolder),first=!0,fnArgs="",usedArgs=[],parts.forEach(function(e){!regPlaceHolder.test(e)||0!==usedArgs.length&&-1!=usedArgs.indexOf(e)||(first||(fnArgs+=","),fnArgs+=e.replace(regRepPlaceHolder,"v$1"),usedArgs.push(e),first=!1)}),parsed+=name+"=function("+fnArgs+"){",fnExpr='"'+value.replace(regRepPlaceHolder,'"+v$1+"')+'"',parsed+="return "+fnExpr+";};"):parsed+=name+'="'+value+'";')}}}eval(parsed),settings.filesLoaded+=1}function checkKeyNamespace(key){var regDot=/\./;if(regDot.test(key))for(var fullname="",names=key.split(/\./),i=0,j=names.length;i<j;i++){var name=names[i];0<i&&(fullname+="."),fullname+=name,eval("typeof "+fullname+' == "undefined"')&&eval(fullname+"={};")}}function unescapeUnicode(e){var t=[],e=parseInt(e.substr(2),16);return 0<=e&&e<Math.pow(2,16)&&t.push(e),t.reduce(function(e,t){return e+String.fromCharCode(t)},"")}jQuery.kgi18n.normaliseLanguageCode=function(e){var t=e.language;return(!t||t.length<2)&&(e.debug&&debug("No language supplied. Pulling it from the browser ..."),t=navigator.languages&&0<navigator.languages.length?navigator.languages[0]:navigator.language||navigator.userLanguage||"en",e.debug&&debug("Language from browser: "+t)),t=3<(t=(t=t.toLowerCase()).replace(/-/,"_")).length?t.substring(0,3)+t.substring(3).toUpperCase():t};var CryptoJS=CryptoJS||function(c){var e={},t=e.lib={},i=t.Base={extend:function(e){n.prototype=this;var t=new n;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),(t.init.prototype=t).$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}};function n(){}var g=t.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||o).stringify(this)},concat:function(e){var t=this.words,i=e.words,n=this.sigBytes,a=e.sigBytes;if(this.clamp(),n%4)for(var o=0;o<a;o++){var s=i[o>>>2]>>>24-o%4*8&255;t[n+o>>>2]|=s<<24-(n+o)%4*8}else if(65535<i.length)for(o=0;o<a;o+=4)t[n+o>>>2]=i[o>>>2];else t.push.apply(t,i);return this.sigBytes+=a,this},clamp:function(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=c.ceil(t/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],i=0;i<e;i+=4)t.push(4294967296*c.random()|0);return new g.init(t,e)}}),a=e.enc={},o=a.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n+=2)i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new g.init(i,t/2)}},s=a.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n++)i[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new g.init(i,t)}},r=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(s.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return s.parse(unescape(encodeURIComponent(e)))}},l=t.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=r.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(e){var t=this._data,i=t.words,n=t.sigBytes,a=this.blockSize,o=n/(4*a),s=(o=e?c.ceil(o):c.max((0|o)-this._minBufferSize,0))*a,e=c.min(4*s,n);if(s){for(var r=0;r<s;r+=a)this._doProcessBlock(i,r);var l=i.splice(0,s);t.sigBytes-=e}return new g.init(l,e)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),d=(t.Hasher=l.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(i){return function(e,t){return new i.init(t).finalize(e)}},_createHmacHelper:function(i){return function(e,t){return new d.HMAC.init(i,t).finalize(e)}}}),e.algo={});return e}(Math),$=(!function(){var e=CryptoJS,t=e.lib,i=t.WordArray,n=t.Hasher,t=e.algo,g=[],t=t.SHA1=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],a=i[1],o=i[2],s=i[3],r=i[4],l=0;l<80;l++){l<16?g[l]=0|e[t+l]:(c=g[l-3]^g[l-8]^g[l-14]^g[l-16],g[l]=c<<1|c>>>31);var c=(n<<5|n>>>27)+r+g[l];c+=l<20?1518500249+(a&o|~a&s):l<40?1859775393+(a^o^s):l<60?(a&o|a&s|o&s)-1894007588:(a^o^s)-899497514,r=s,s=o,o=a<<30|a>>>2,a=n,n=c}i[0]=i[0]+n|0,i[1]=i[1]+a|0,i[2]=i[2]+o|0,i[3]=i[3]+s|0,i[4]=i[4]+r|0},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(64+n>>>9<<4)]=Math.floor(i/4294967296),t[15+(64+n>>>9<<4)]=i,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=n._createHelper(t),e.HmacSHA1=n._createHmacHelper(t)}(),!function(l){for(var e=CryptoJS,t=e.lib,i=t.WordArray,n=t.Hasher,t=e.algo,_=[],a=0;a<64;a++)_[a]=4294967296*l.abs(l.sin(a+1))|0;t=t.MD5=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var i=0;i<16;i++){var n=t+i,a=e[n];e[n]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}var o=this._hash.words,s=e[t+0],r=e[t+1],l=e[t+2],c=e[t+3],g=e[t+4],d=e[t+5],u=e[t+6],h=e[t+7],p=e[t+8],f=e[t+9],m=e[t+10],v=e[t+11],k=e[t+12],S=e[t+13],y=e[t+14],b=e[t+15],w=D(o[0],A=o[1],x=o[2],C=o[3],s,7,_[0]),C=D(C,w,A,x,r,12,_[1]),x=D(x,C,w,A,l,17,_[2]),A=D(A,x,C,w,c,22,_[3]);w=D(w,A,x,C,g,7,_[4]),C=D(C,w,A,x,d,12,_[5]),x=D(x,C,w,A,u,17,_[6]),A=D(A,x,C,w,h,22,_[7]),w=D(w,A,x,C,p,7,_[8]),C=D(C,w,A,x,f,12,_[9]),x=D(x,C,w,A,m,17,_[10]),A=D(A,x,C,w,v,22,_[11]),w=D(w,A,x,C,k,7,_[12]),C=D(C,w,A,x,S,12,_[13]),x=D(x,C,w,A,y,17,_[14]),w=T(w,A=D(A,x,C,w,b,22,_[15]),x,C,r,5,_[16]),C=T(C,w,A,x,u,9,_[17]),x=T(x,C,w,A,v,14,_[18]),A=T(A,x,C,w,s,20,_[19]),w=T(w,A,x,C,d,5,_[20]),C=T(C,w,A,x,m,9,_[21]),x=T(x,C,w,A,b,14,_[22]),A=T(A,x,C,w,g,20,_[23]),w=T(w,A,x,C,f,5,_[24]),C=T(C,w,A,x,y,9,_[25]),x=T(x,C,w,A,c,14,_[26]),A=T(A,x,C,w,p,20,_[27]),w=T(w,A,x,C,S,5,_[28]),C=T(C,w,A,x,l,9,_[29]),x=T(x,C,w,A,h,14,_[30]),w=I(w,A=T(A,x,C,w,k,20,_[31]),x,C,d,4,_[32]),C=I(C,w,A,x,p,11,_[33]),x=I(x,C,w,A,v,16,_[34]),A=I(A,x,C,w,y,23,_[35]),w=I(w,A,x,C,r,4,_[36]),C=I(C,w,A,x,g,11,_[37]),x=I(x,C,w,A,h,16,_[38]),A=I(A,x,C,w,m,23,_[39]),w=I(w,A,x,C,S,4,_[40]),C=I(C,w,A,x,s,11,_[41]),x=I(x,C,w,A,c,16,_[42]),A=I(A,x,C,w,u,23,_[43]),w=I(w,A,x,C,f,4,_[44]),C=I(C,w,A,x,k,11,_[45]),x=I(x,C,w,A,b,16,_[46]),w=B(w,A=I(A,x,C,w,l,23,_[47]),x,C,s,6,_[48]),C=B(C,w,A,x,h,10,_[49]),x=B(x,C,w,A,y,15,_[50]),A=B(A,x,C,w,d,21,_[51]),w=B(w,A,x,C,k,6,_[52]),C=B(C,w,A,x,c,10,_[53]),x=B(x,C,w,A,m,15,_[54]),A=B(A,x,C,w,r,21,_[55]),w=B(w,A,x,C,p,6,_[56]),C=B(C,w,A,x,b,10,_[57]),x=B(x,C,w,A,u,15,_[58]),A=B(A,x,C,w,S,21,_[59]),w=B(w,A,x,C,g,6,_[60]),C=B(C,w,A,x,v,10,_[61]),x=B(x,C,w,A,l,15,_[62]),A=B(A,x,C,w,f,21,_[63]),o[0]=o[0]+w|0,o[1]=o[1]+A|0,o[2]=o[2]+x|0,o[3]=o[3]+C|0},_doFinalize:function(){for(var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes,a=(t[n>>>5]|=128<<24-n%32,l.floor(i/4294967296)),a=(t[15+(64+n>>>9<<4)]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),t[14+(64+n>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),e.sigBytes=4*(t.length+1),this._process(),this._hash),o=a.words,s=0;s<4;s++){var r=o[s];o[s]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}return a},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});function D(e,t,i,n,a,o,s){e=e+(t&i|~t&n)+a+s;return(e<<o|e>>>32-o)+t}function T(e,t,i,n,a,o,s){e=e+(t&n|i&~n)+a+s;return(e<<o|e>>>32-o)+t}function I(e,t,i,n,a,o,s){e=e+(t^i^n)+a+s;return(e<<o|e>>>32-o)+t}function B(e,t,i,n,a,o,s){e=e+(i^(t|~n))+a+s;return(e<<o|e>>>32-o)+t}e.MD5=n._createHelper(t),e.HmacMD5=n._createHmacHelper(t)}(Math),!function(){var e=CryptoJS.lib.Base,r=CryptoJS.enc.Utf8;CryptoJS.algo.HMAC=e.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=r.parse(t));for(var i=e.blockSize,n=4*i,e=((t=t.sigBytes>n?e.finalize(t):t).clamp(),this._oKey=t.clone()),t=this._iKey=t.clone(),a=e.words,o=t.words,s=0;s<i;s++)a[s]^=1549556828,o[s]^=909522486;e.sigBytes=t.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),!function(){var e=CryptoJS,t=e.lib,i=t.Base,g=t.WordArray,t=e.algo,n=t.MD5,a=t.EvpKDF=i.extend({cfg:i.extend({keySize:4,hasher:n,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var i,n=this.cfg,a=n.hasher.create(),o=g.create(),s=o.words,r=n.keySize,l=n.iterations;s.length<r;){i&&a.update(i),i=a.update(e).finalize(t),a.reset();for(var c=1;c<l;c++)i=a.finalize(i),a.reset();o.concat(i)}return o.sigBytes=4*r,o}});e.EvpKDF=function(e,t,i){return a.create(i).compute(e,t)}}(),!function(){var e=CryptoJS,t=e.lib,i=t.Base,s=t.WordArray,n=t.BufferedBlockAlgorithm,a=e.enc,o=(a.Utf8,a.Base64),r=e.algo.EvpKDF,l=t.Cipher=n.extend({cfg:i.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,i){this.cfg=this.cfg.extend(i),this._xformMode=e,this._key=t,this.reset()},reset:function(){n.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(n){return{encrypt:function(e,t,i){return c(t).encrypt(n,e,t,i)},decrypt:function(e,t,i){return c(t).decrypt(n,e,t,i)}}}});function c(e){return"string"==typeof e?p:h}t.StreamCipher=l.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var a=e.mode={},g=t.BlockCipherMode=i.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),g=a.CBC=((a=g.extend()).Encryptor=a.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize;d.call(this,e,t,n),i.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),a.Decryptor=a.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize,a=e.slice(t,t+n);i.decryptBlock(e,t),d.call(this,e,t,n),this._prevBlock=a}}),a);function d(e,t,i){var n,a=this._iv;a?(n=a,this._iv=void 0):n=this._prevBlock;for(var o=0;o<i;o++)e[t+o]^=n[o]}var a=(e.pad={}).Pkcs7={pad:function(e,t){for(var t=4*t,i=t-e.sigBytes%t,n=i<<24|i<<16|i<<8|i,a=[],o=0;o<i;o+=4)a.push(n);t=s.create(a,i);e.concat(t)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},u=(t.BlockCipher=l.extend({cfg:l.cfg.extend({mode:g,padding:a}),reset:function(){l.reset.call(this);var e,t=this.cfg,i=t.iv,t=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=t.createEncryptor:(e=t.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,i&&i.words):(this._mode=e.call(t,this,i&&i.words),this._mode.__creator=e)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4}),t.CipherParams=i.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}})),g=(e.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,e=e.salt,e=e?s.create([1398893684,1701076831]).concat(e).concat(t):t;return e.toString(o)},parse:function(e){var t,e=o.parse(e),i=e.words;return 1398893684==i[0]&&1701076831==i[1]&&(t=s.create(i.slice(2,4)),i.splice(0,4),e.sigBytes-=16),u.create({ciphertext:e,salt:t})}},h=t.SerializableCipher=i.extend({cfg:i.extend({format:g}),encrypt:function(e,t,i,n){n=this.cfg.extend(n);var a=e.createEncryptor(i,n),t=a.finalize(t),a=a.cfg;return u.create({ciphertext:t,key:i,iv:a.iv,algorithm:e,mode:a.mode,padding:a.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,i,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(i,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),a=(e.kdf={}).OpenSSL={execute:function(e,t,i,n){n=n||s.random(8);e=r.create({keySize:t+i}).compute(e,n),i=s.create(e.words.slice(t),4*i);return e.sigBytes=4*t,u.create({key:e,iv:i,salt:n})}},p=t.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:a}),encrypt:function(e,t,i,n){i=(n=this.cfg.extend(n)).kdf.execute(i,e.keySize,e.ivSize),n.iv=i.iv,e=h.encrypt.call(this,e,t,i.key,n);return e.mixIn(i),e},decrypt:function(e,t,i,n){n=this.cfg.extend(n),t=this._parse(t,n.format);i=n.kdf.execute(i,e.keySize,e.ivSize,t.salt);return n.iv=i.iv,h.decrypt.call(this,e,t,i.key,n)}})}(),!function(){for(var e=CryptoJS,t=e.lib.BlockCipher,i=e.algo,c=[],n=[],a=[],o=[],s=[],r=[],g=[],d=[],u=[],h=[],l=[],p=0;p<256;p++)l[p]=p<128?p<<1:p<<1^283;for(var f=0,m=0,p=0;p<256;p++){var v=m^m<<1^m<<2^m<<3^m<<4,k=(c[f]=v=v>>>8^255&v^99,l[n[v]=f]),S=l[k],y=l[S],b=257*l[v]^16843008*v;a[f]=b<<24|b>>>8,o[f]=b<<16|b>>>16,s[f]=b<<8|b>>>24,r[f]=b,g[v]=(b=16843009*y^65537*S^257*k^16843008*f)<<24|b>>>8,d[v]=b<<16|b>>>16,u[v]=b<<8|b>>>24,h[v]=b,f?(f=k^l[l[l[y^k]]],m^=l[l[m]]):f=m=1}var w=[0,1,2,4,8,16,32,64,128,27,54],i=i.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,i=e.sigBytes/4,n=4*(1+(this._nRounds=6+i)),a=this._keySchedule=[],o=0;o<n;o++)o<i?a[o]=t[o]:(l=a[o-1],o%i?6<i&&o%i==4&&(l=c[l>>>24]<<24|c[l>>>16&255]<<16|c[l>>>8&255]<<8|c[255&l]):(l=c[(l=l<<8|l>>>24)>>>24]<<24|c[l>>>16&255]<<16|c[l>>>8&255]<<8|c[255&l],l^=w[o/i|0]<<24),a[o]=a[o-i]^l);for(var s=this._invKeySchedule=[],r=0;r<n;r++){var l,o=n-r;l=r%4?a[o]:a[o-4],s[r]=r<4||o<=4?l:g[c[l>>>24]]^d[c[l>>>16&255]]^u[c[l>>>8&255]]^h[c[255&l]]}}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,a,o,s,r,c)},decryptBlock:function(e,t){var i=e[t+1],i=(e[t+1]=e[t+3],e[t+3]=i,this._doCryptBlock(e,t,this._invKeySchedule,g,d,u,h,n),e[t+1]);e[t+1]=e[t+3],e[t+3]=i},_doCryptBlock:function(e,t,i,n,a,o,s,r){for(var l=this._nRounds,c=e[t]^i[0],g=e[t+1]^i[1],d=e[t+2]^i[2],u=e[t+3]^i[3],h=4,p=1;p<l;p++)var f=n[c>>>24]^a[g>>>16&255]^o[d>>>8&255]^s[255&u]^i[h++],m=n[g>>>24]^a[d>>>16&255]^o[u>>>8&255]^s[255&c]^i[h++],v=n[d>>>24]^a[u>>>16&255]^o[c>>>8&255]^s[255&g]^i[h++],k=n[u>>>24]^a[c>>>16&255]^o[g>>>8&255]^s[255&d]^i[h++],c=f,g=m,d=v,u=k;f=(r[c>>>24]<<24|r[g>>>16&255]<<16|r[d>>>8&255]<<8|r[255&u])^i[h++],m=(r[g>>>24]<<24|r[d>>>16&255]<<16|r[u>>>8&255]<<8|r[255&c])^i[h++],v=(r[d>>>24]<<24|r[u>>>16&255]<<16|r[c>>>8&255]<<8|r[255&g])^i[h++],k=(r[u>>>24]<<24|r[c>>>16&255]<<16|r[g>>>8&255]<<8|r[255&d])^i[h++];e[t]=f,e[t+1]=m,e[t+2]=v,e[t+3]=k},keySize:8});e.AES=t._createHelper(i)}(),window.jQuery),kingPlus=window.kingPlus,isIE8=!1,canCanvas=(root.JSON&&(isIE8='{"x":"中"}'!==root.JSON.stringify({x:"中"})),!0);try{root.document.createElement("canvas").getContext("2d")}catch(e){canCanvas=!1}function stringify(e){e=JSON.stringify(e);return isIE8?e.replace(/\\u([0-9a-fA-F]{2,4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}):e}var now=function(){return(new Date).getTime()};function rnd(e){return(e=(9301*e+49297)%233280)/233280}function rand(){var e=""+Math.ceil(99999*rnd((new Date).getTime())),t=5-e.length;if(0<t)for(var i=0;i<t;i++)e="0"+e;return e}var Utils=kinggrid.Utils,$window=$(window),$document=$(document),html=document.documentElement,isIE6=!("minWidth"in html.style),isLosecapture=!isIE6&&"onlosecapture"in html,isSetCapture="setCapture"in html,isTouch,EventTypes,getEvent=function(e){return e=isTouch?(e.originalEvent||e).touches.item(0):e},Drag=function(e){this.start=$.proxy(this.start,this),this.over=$.proxy(this.over,this),this.end=$.proxy(this.end,this),this.onstart=this.onover=this.onend=$.noop,EventTypes||(isTouch="mousedown"!=e.type,EventTypes={start:isTouch?"touchstart":"mousedown",over:isTouch?"touchmove":"mousemove",end:isTouch?"touchend":"mouseup"})},Listener=(Drag.prototype={start:function(e){return e=this.startFix(e),globalLisenter.trigger("dragStart",this,e),$document.on(EventTypes.over,this.over).on(EventTypes.end,this.end),this.onstart(e),!1},over:function(e){return e=this.overFix(e),globalLisenter.trigger("dragOver",this,e),this.onover(e),!1},end:function(e){return e=this.endFix(e),globalLisenter.trigger("dragEnd",this,e),$document.off(EventTypes.over,this.over).off(EventTypes.end,this.end),this.onend(e),!1},startFix:function(e){return e=getEvent(e),this.target=$(e.target),this.selectstart=function(){return!1},$document.on("selectstart",this.selectstart).on("dblclick",this.end),isLosecapture?this.target.on("losecapture",this.end):$window.on("blur",this.end),isSetCapture&&this.target[0].setCapture(),e},overFix:function(e){return e=getEvent(e)},endFix:function(e){return e=getEvent(e),$document.off("selectstart",this.selectstart).off("dblclick",this.end),isLosecapture?this.target.off("losecapture",this.end):$window.off("blur",this.end),isSetCapture&&this.target[0].releaseCapture(),e}},Drag.create=function(s,e,r,t){function i(){}var l,c,g,d,u=$(s),n=new Drag(e),a=EventTypes.start,h=s.className.replace(/^\s|\s.*/g,"")+"-drag-start",o=u[0].style,p=$document.scrollLeft(),f=$document.scrollTop(),m=0==t.left?0:t.left+u.width()-p,v=t.right-p,k=t.top-f,S=0==t.bottom?0:t.bottom-u.height()-f,y=0,b=0,w=parseInt(o.left),C=parseInt(o.top),x=w,A=C,_=w,D=C,T=(r&&(x=parseInt(o.marginLeft),A=parseInt(o.marginTop),_=x,D=A),{onstart:i,onover:i,onend:i,off:function(){u.off(a,n.start)}}),I=function(){var e,t=1,i=u.parents(".kg-translate");return null!=i&&null!=(i=i.css("transform"))&&(e=(i=i.split("(")[1].split(")")[0].split(","))[0],i=i[3],t=Math.max(Math.sqrt(e*e),Math.sqrt(i*i))),t};return n.onstart=function(e){var t="fixed"===u.css("position"),i=$document.scrollLeft(),n=$document.scrollTop(),a=u.width(),o=u.height(),a=(a*=I(),o*=I(),c=l=0,g=t?$window.width()-a+l:$document.width()-a,d=t?$window.height()-o+c:$document.height()-o,u.offset()),o=this.startLeft=t?a.left-i:a.left,t=this.startTop=t?a.top-n:a.top,a=(this.clientX=e.clientX,this.clientY=e.clientY,u.parent()),a=(a.is("body")||(y=a[0].getBoundingClientRect().left+i,b=a[0].getBoundingClientRect().top+n),e.clientX-u.offset().left+i-u.width()),i=e.clientY-u.offset().top+n;0!=m&&(m+=a),0!=v&&(v+=a),0!=k&&(k+=i),0!=S&&(S+=i),u.addClass(h),T.onstart.call(s,e,o,t)},n.onover=function(e){var t=e.clientX,i=e.clientY,t=(0!=m&&e.clientX<=m&&(t=m),0!=v&&e.clientX>=v&&(t=v),0!=k&&e.clientY<=k&&(i=k),0!=S&&e.clientY>=S&&(i=S),t-this.clientX+this.startLeft),i=i-this.clientY+this.startTop,n=u[0].style,t=Math.max(l,Math.min(g,t)),i=Math.max(c,Math.min(d,i)),a=0,o=0,o=r?(a=n.marginLeft=(t-y-w)/I()+"px",n.marginTop=(i-b-C)/I()+"px"):(a=n.left=(t-y)/I()+"px",n.top=(i-b)/I()+"px");_=parseInt(a),D=parseInt(o),T.onover.call(s,e,a,o)},n.onend=function(e){var t=u.position(),i=t.left,t=t.top,n=(u.removeClass(h),u[0].style),a=!0;Math.abs(_-x)<6&&Math.abs(D-A)<6&&(a=!1),r?T.onend.call(s,e,a,n.marginLeft,n.marginTop):T.onend.call(s,e,a,i,t)},n.off=function(){u.off(a,n.start)},e?n.start(e):u.on(a,n.start),T},kinggrid.Listener),Service=function(){},SealService=($.extend(Service.prototype,Listener.prototype),function(){}),CertService=(SealService.className=SealService.name||"SealService",Utils.inherit(SealService,Service),$.extend(SealService.prototype,{loadSeal:function(){throw new Error("must impl")},saveLog:function(){},verifyPwd:function(){throw new Error("must impl")}}),function(){}),KgObject=(CertService.className=CertService.name||"CertService",Utils.inherit(CertService,Service),$.extend(CertService.prototype,{sign:function(){throw new Error("must impl")},verifySign:function(){throw new Error("must impl")}}),function(){}),Signature=($.extend(KgObject.prototype,{getAttr:function(e){return this[e]},setAttr:function(e){var i=this;$.each(e,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t})},removeAttr:function(e){delete this[e]}}),function(e,t){var i,n=this;for(i in n.signatureid=e,n.setSignatureData(t),n.on("load",function(){Signature.list[e]=this}),n.on("remove",function(e){n.signatureData;e=n._getLogInfo(Utils.extend(e||{},{LOGTYPE:"00",LOGSORT:"14",LOGMEMO:"撤销签章成功"}));n.sealService.saveLog(e),delete Signature.list[n.signatureid]}),n.on("update",function(e){"signMeta"===n._item&&(n.signatureData,e=n._getLogInfo(Utils.extend(e||{},{LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"数字签名成功"})),n.sealService.saveLog(e))}),n.on("fireremove",function(){Signature.removeList.push(n.signatureid)}),n.on("fireupdate",function(){for(var e=!1,t=0;t<Signature.updateList.length;t++)if(Signature.updateList[t]===n){e=!0;break}e||Signature.updateList.push(n)}),Signature)Signature.hasOwnProperty(i)&&0==i.indexOf("on")&&(this[i]=Signature[i]);return this}),aseIV="#$~%kinggrid%~$#",aseKey="AaBbCcDdEeFfGgH1",blankImg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=",blackImg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mNoaGgAAAMEAYF1LgG8AAAAAElFTkSuQmCC",createImg=function(e,t,i){var n,a,o;return canCanvas?((n=root.document.createElement("canvas")).height=i,n.width=t,a=n.getContext("2d"),(o=new Image).src=e,o.onload=function(){a.drawImage(o,0,0,t,i)}):((n=root.document.createElement("img")).style.width=t+"px",n.style.height=i+"px",n.setAttribute("src",e)),n},plus=(Utils.inherit(Signature,KgObject),$.extend(Signature.prototype,Listener.prototype),$.extend(Signature.prototype,{hashAlg:"sha1",encryptAlg:"RSA",_init:function(){},_getLogInfo:function(e,t){var i=decodeURIComponent(window.location.href),t=this.signatureData||t;return Utils.extend(e||{},{KEYSN:t.gbOvalue&&""!=t.gbOvalue?t.gbOvalue:t.keysn,SIGNSN:t.seal.signsn,DOCUMENTID:t.documentid,DOCUMENTNAME:t.documentname,APPVERSION:version.name,APPTYPE:"HTML",APPCODE:this.appcode,EXTPARAM2:i})},error:function(e,t,i,n){var a=e,t=(a=(a=Utils.is("Object",e)?e.errcode&&"511"!=e.errcode?e.errcode:e.errmsg:a)||"-999",Utils.is("String",arguments[1])?t:"then");plus.hideLoading(),Signature.options.errorCall?Signature.options.errorCall.call(null,e,t):(a=e.errmsg||kinggrid.msg(a,t),plus.alert(a,function(){n&&n._beginDlgOkCall&&1==n._beginDlgOkCall||Signature.options.beginDlgOkCall&&Signature.options.beginDlgOkCall.call()},function(){Signature.options.beginDlgShowCall&&Signature.options.beginDlgShowCall.call()}))},load:function(e){var t=this,i=(this.trigger("beforeLoad"),this.setAttr(e),this.certService=new Signature.factory.cert[Signature.options.certType](e,this.signatureData),this.signatureData);if(void 0!==e.extra&&null!==e.extra&&void 0!==e.extra[t.signatureid]){if(void 0!==e.extra[t.signatureid].scaleImage&&null!==e.extra[t.signatureid].scaleImage&&(i.seal.height=i.seal.height*e.extra[t.signatureid].scaleImage,i.seal.width=i.seal.width*e.extra[t.signatureid].scaleImage),null!=e.extra[t.signatureid].position){var n,a=$.extend({},i.position),o="";for(n in a)o=n;this.removeItem(i.position),this.updatePos(e.extra[t.signatureid].position,{marginLeft:null==e.extra[t.signatureid].offsetX?a[o].marginLeft:e.extra[t.signatureid].offsetX,marginTop:null==e.extra[t.signatureid].offsetY?a[o].marginTop:e.extra[t.signatureid].offsetY})}}else void 0!==e.scaleImage&&null!==e.scaleImage&&(i.seal.height=i.seal.height*e.scaleImage,i.seal.width=i.seal.width*e.scaleImage);return this.sealService=new Signature.factory.seal[Signature.options.sealType](e,i),this._init(),this.trigger("load"),this},toBase64Img:function(e){var t=e.imgdata,i=t.indexOf(e.signsn);return-1==i?t:(t=e.imgdata.substring(i+65),Utils.Base64.of().encodeByte(Utils.Base64.of(e.signsn).decodeByte(t)))},clearImg:function(){var e=this;if(e.imgEles)for(var t in e.imgEles)this.trigger("removeAt",e.imgEles[t][0]),e.imgEles[t].remove();e.imgEles={}},repaint:function(){this.clearImg(),this.verify()},getUpdateType:function(){return this._item},updatePos:function(e,t){var i=this.signatureData.position[e];this._item="position",this.signatureData.position[e]=Utils.extend({},i,t)},updateItem:function(e,t){this._item=e,this.signatureData[e]=t},removeItem:function(e){for(var t in e)delete e[t]},fireUpdate:function(t){function e(e){t&&t(e),i[e?"update":"restore"](),delete i._item}var i=this;return Signature.asyn.update?Signature.asyn.update.call(i,e):(this.trigger("fireupdate"),e(!0)),this},restore:function(){this.setSignatureData(this.oriSignatureData),this.repaint()},update:function(){return this.setSignatureData(this.signatureData),this.repaint(),this.trigger("update"),this},remove:function(){for(var e in this.clearImg(),this.trigger("remove"),this)delete this[e];return this},fireRemove:function(t){function e(e){t&&t(e),e&&i.remove()}var i=this;return Signature.asyn.remove?Signature.asyn.remove.call(i,e):(this.trigger("fireremove"),e(!0)),this},hide:function(){if(this.imgEles)for(var e in this.imgEles)this.imgEles[e].hide()},createImg:function(){var e=this.signatureData,t=$(document.createElement("img")),i=0<e.appname.indexOf("H2TH5")?(e.seal.imgext=".png",e.seal.imgdata):this.toBase64Img(e.seal),n=blankImg;return this.broken||(n="data:image/"+e.seal.imgext+";base64,"+i),t.css({width:Math.ceil(9600*parseFloat(e.seal.width)/254),height:Math.ceil(9600*parseFloat(e.seal.height)/254)}).attr({src:n}),t},show:function(){var e,t=this.signatureData.position,i=this.imgEles=this.imgEles||{};for(e in t){var n="kg-img-div-"+this.signatureid+"-"+e,a=(a=i[n])||(i[n]=this.showAt(e,t[e]));this._handleImg(a)}this.trigger("show")},showAt:function(e,t){this.trigger("beforeShowAt",e,t);var i=this,n=Utils.$(e),a=i.signatureData.appname,o=i.signatureData.position,o=(-1!=a.indexOf("H2TH5")&&o.H2TH5&&(-1===o.H2TH5.marginTop.indexOf("px")&&(o.H2TH5.marginTop+="px",o.H2TH5.marginLeft+="px"),null===n&&(a=$("<div style='position:absolute;left:0;top:0;'></div>"),n=$("<div id='H2TH5'></div>"),a.append(n),$("body").append(a))),$(n));if(0==(o=i.extra&&i.extra[this.signatureid]&&(a=i.extra[this.signatureid].scopePosition)?(a instanceof Object?a:$(Utils.$(a))).find("#"+e):o).length){if(!Signature.options.defaultPos)throw new Error("no find position:"+e+" signatureid="+this.signatureid);e=Signature.options.defaultPos,o=$(Utils.$(e))}var s,r,n="kg-img",a=i.createImg(),l=(a.addClass(n).attr("id",n+"-"+i.signatureid),$(document.createElement("div")).addClass(n+"-div").addClass(n+"-div-"+e).attr({id:n+"-div-"+this.signatureid+"-"+e,elemid:e,signatureid:this.signatureid})),c=$(document.createElement("div")).css({position:"absolute"}),g=(c.append(a),l.append(c),l.css({width:a.width(),height:a.height()}),0),d=0,u=0,h=i.signatureData.dateTime,p=i.signatureData.postilFontSet,h=(null!=h&&h.isCheck&&h.fontDate&&(f=this.addDateToImg(h.fontDate,i.signatureData.timestamp.time,l,c),null!=this.imageAndDate&&this.imageAndDate&&"outside"==h.fontDate.fontPosition[2]&&("right"==h.fontDate.fontPosition[3]?g+=f.dateWidth:"left"==h.fontDate.fontPosition[3]&&(g+=f.dateWidth,u=f.dateWidth,c.css({right:0})),"below"==h.fontDate.fontPosition[4]&&(d+=f.dateHeight))),a.width()+g),f=(null!=p&&null!=p.fontValue&&""!=p.fontValue.trim()&&(h+=r=this.calWidth(p.fontValue,p),d+=this.calHeight(p.fontSize),c.css({left:r+u}),this.addPostilFontToImg(p,l)),a.height()+d),u=(null!=i.thirdConfig&&null!=i.thirdConfig.imgWh?(l.css({width:parseInt(i.thirdConfig.imgWh.width)>h?i.thirdConfig.imgWh.width:h,height:parseInt(i.thirdConfig.imgWh.height)>f?i.thirdConfig.imgWh.height:f}),c.css({left:Signature.isIE?"auto":"unset",right:g})):l.css({width:h,height:f}),l),p="kg-default",a=o.attr("display");return a?(o.addClass("display-"+a),p="kg-"+a,s=o,(d=document.getElementById(n+"-container-"+e))||(d=document.createElement("div")).setAttribute("id",n+"-container-"+e),(u=$(d).addClass(p+"-container")).append(l),l.attr("kg-display",!0)):"html"!=(s=o.offsetParent())[0].tagName.toLowerCase()&&"relative"!=s[0].style.position||(s=$("body")),l.addClass(p),s.append(u),a?"landscape"===a&&(i=u.children(),c=u.parent().width(),r=0,i.each(function(){r+=parseInt($(this).width())+1}),u.width(c<r?r:c)):this.calSealPos(o,l,u,t),this.trigger("showAt",l[0],e,t),l},calSealPos:function(e,t,i,n){var a,o=e.offsetParent(),i=i||t,e=("html"!=o[0].tagName.toLowerCase()&&"relative"!=o[0].style.position||(o=$("body")),e.offset()),s=o.offset();o.is("body")&&(s={top:0,left:0}),i.css({top:e.top-s.top,left:e.left-s.left}),o=n?(a=n.marginLeft,n.marginTop):(a=t.css("marginLeft"),t.css("marginTop")),t.css({marginLeft:a||0,marginTop:o||0})},addPostilFontToImg:function(e,t){var i=$(document.createElement("div")),n=(i.addClass("kg-font-positl-div"),$(document.createElement("span")));return n.css({color:e.fontColor,"font-family":e.fontFamily,"font-size":e.fontSize+"px"}).addClass("kg-font-positl-span"),n.html(e.fontValue),i.append(n),t.prepend(i),i},calWidth:function(e,t){var i=document.createElement("canvas").getContext("2d");return i.font=t.fontSize+"px arial,"+t.fontFamily,i.measureText(e).width+6},calHeight:function(e){return 1.5*parseInt(e)},getLength:function(e){return e.replace(/[\u0391-\uFFE5]/g,"aa").length},addDateToImg:function(e,t,i,n){var t=new Date(t),t=kinggrid.Utils.formatDate(t,e.fontFormat),a=$(document.createElement("div")).addClass("kg-date"),o=0,s=0;if(!e.fontPosition)for(var r=plus.fontTemplate.position.length,l=0;l<r;l++)if(plus.fontTemplate.position[l]==this.signdate.position){e.fontPosition=plus.fontTemplate.fontPosition[l];break}"outside"==e.fontPosition[2]&&("right"==e.fontPosition[3]?o+=i.width():"left"==e.fontPosition[3]&&(o-=i.width()),"below"==e.fontPosition[4]&&(s+=i.height())),a.css({width:i.width(),height:i.height(),top:s,left:o});s=$(document.createElement("div")).addClass("kg-date-tmb").css({width:i.width()}),o=$(document.createElement("div")).addClass("kg-date-lcr").css({"text-align":e.fontPosition[0],"font-family":e.fontFamily,"font-size":e.fontSize+"px",color:e.fontColor});return"bottom"==e.fontPosition[1]?s.css({bottom:0}):"middle"==e.fontPosition[1]&&o.css({"line-height":i.height()+"px"}),o.html(t),s.html(o),a.html(s),n.append(a),{dateWidth:this.calWidth(t,e),dateHeight:this.calHeight(e.fontSize)}},canSign:function(){return!this.modified&&!Signature.options.readonly&&Signature.options.signable&&!this.signatureData.signMeta},canMove:function(e){e=!Signature.options.readonly&&this.signatureData.moveable&&Signature.options.moveable&&!Boolean($(e).attr("kg-display"));return e=e&&Signature.options.moveable_self?this.signatureData.keysn==Signature.options.keysn:e},canDelete:function(){return!Signature.options.readonly},_handleImg:function(e){var t;e.show(),0==e.children(".kg-shade").length&&((t=$(document.createElement("div")).addClass("kg-shade")).append(createImg(blankImg,e.width(),e.height())),e.append(t)),this._invalid(e),this.trigger("handleImg",e[0])},setSignatureData:function(e){Utils.is("String",e)?this.signatureData=JSON.parse(Utils.Base64.of().decode(e)):this.signatureData=e,this.oriSignatureData=JSON.parse(JSON.stringify(this.signatureData))},getSignatureid:function(){return this.signatureid},getSignatureData:function(){var e=JSON.stringify(this.signatureData);return Utils.Base64.of().encode(e)},getBase64Image:function(t,i,e,n){var a="kg-img-div-",e=(a=(a+=t)+"-"+e,document.getElementById(a));null!=e&&(isIE8?n(this,"",t,i):html2canvas(e).then(function(e){e=e.toDataURL("image/png").split(",");n(this,e,t,i)}))},_invalid:function(e){var t=e.children(".kg-invalid");if(0==t.length){t=$(document.createElement("div")).addClass("kg-hide").addClass("kg-invalid"),e.append(t);for(var i=e.height()/3,n=(t.css({top:i,height:i}),i/3),a=e.width(),o=0;o<3;o++){var s=$(document.createElement("div")).height(n);o%2==0&&(s.addClass("kg-invalid-item"),s.append(createImg(blackImg,a,n))),t.append(s)}}if(this.modified){for(var r="",l=0;l<this.modifiedItems.length;l++){var c=this.modifiedItems[l];r+=c.desc+"["+c.field+"]由{"+c.orivalue+"}更改为{"+c.newvalue+"};"}e.attr("modified",r).addClass("error"),t.removeClass("kg-hide")}else e.removeAttr("modified").removeClass("error"),t.addClass("kg-hide")},_verify:function(e,t){this.trigger("before_verify");this.modified;e=this.verifyProtectedData(e);if(!t||t.batchVerify||null==this.oriSignatureData.timestamp.timestampInfo)return this.show(),this.trigger("_verify"),!e;this.modified;var i=this;this.getVerifyTimeStamp(this.oriSignatureData.timestamp.timestampInfo,function(e){i.timeVerify=e,i.show(),i.trigger("_verify"),t&&t.sucCall&&t.sucCall.call(i)})},verify:function(e,t){this.trigger("beforeVerify");e=this._verify(e,t);return this.trigger("verify"),e},getVerifyProtectedItems:function(e,t){for(var i in e)if(null!=e[i]&&null!=e[i]){i=e[i];if(i.field==t)return i}return null},getVerifyProtectedData:function(){for(var e,t,i,n,a=this.validatedData,o=this.signatureData.protectedData,s={},r=0;r<o.length;r++)null!=o[r]&&null!=o[r]&&(t=(e=o[r]).field,null==(i=a&&(a[t]||this.getVerifyProtectedItems(a,t)&&this.getVerifyProtectedItems(a,t).value))&&((n=Utils.$(t))?null==(i=n.getAttribute("kg-value")||n.value)&&(i=n.innerHTML||n.innerText):i=null!=e.name&&null!=e.name?document.getElementById(e.name).value:""),n=Utils.val(i,this),n=this._formatValue(n),s[t]=n);return s},getSignTimeStamp:function(e){for(var t={},i=0;i<e.length;i++)t[e[i].field]=e[i].value;return Utils.Base64.of().encode(stringify(t))},getValidatedTimeStamp:function(){var e=stringify(this.getVerifyProtectedData());return Utils.Base64.of().encode(e)},getVerifyTimeStamp:function(e,t){var i,n,a=this.getValidatedTimeStamp(),o=e.CertData;"client"==Signature.options.sealType?(i=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode)).invoke("SetParamByName","TSCERTDATA",Utils.Base64.of().encode(o)).ret(function(){i.invoke("KGVerifyTSWithReq",e.TimeStampResponse,e.TimeStampResult,"",a,e.TimeStr,"").ret(function(e){t.call(this,e.result)})}):(n=Signature.options.serverUrl+"_key_verifyTimeStamp",$.ajax({url:n,type:"POST",data:{verifyed:a,cert:o,tsResp:e.TimeStampResponse},async:!1,success:function(e){t.call(this,e.result)},error:function(e){t.call(this,e)}}))},getH5SignData:function(){return[{hashAlg:this.hashAlg,encryptAlg:this.encryptAlg,signdata:CryptoJS.SHA1(this.getSignData()).toString()}]},verifyProtectedData:function(e){e&&(this.validatedData=e);for(var t,i,e={},n=($.extend(!0,e,this.signatureData.protectedData),Signature.verifyData&&(this.validatedData=Signature.verifyData(e)),[]),a=this.getVerifyProtectedData(),o=this.signatureData.protectedData,s=0;s<o.length;s++)null!=o[s]&&null!=o[s]&&(i=o[s],(t=a[o[s].field])!==i.value&&(i={field:i.field,desc:i.desc,orivalue:i.value,newvalue:t},n.push(i)));return this.modified=0<n.length,this.modifiedItems=n,this.modified},verifySignData:function(i){var n=this,e=(plus.showLoading(),this.certService);if(this.signatureData.signMeta.html2sign){e instanceof ServerCert||((e=new ServerCert(Signature.options)).sData=n.signatureData);for(var t=n.getVerifyProtectedData(),a=this.signatureData.protectedData,o=[],s=0;s<a.length;s++){var r,l=a[s],c={};for(r in l)l.hasOwnProperty(r)&&(c[r]=l[r]);c.value=t[l.field],o.push(c)}t=stringify(o)}else t=this.getValidatedSignData();e.verifySign($.extend({seal:this.signatureData.seal,signeddata:this.signatureData.signMeta.signeddata,crtdata:this.signatureData.signMeta.certinfo.crtdata,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,signdata:t},{successCall:function(e){var t;plus.hideLoading(),e.errcode||(t=!e.result,n.signModified=t,t=n.verify(null,{sucCall:function(){i&&i(e)}})),null==t&&e.result||i&&i(e)}}))},_renderValue:function(e){return e.replace(/\r\n/gi,"<br>")},_formatValue:function(e,t){return e&&e.replace(/\r\n/gi,"\n").replace(/\n/gi,"\r\n")},getItemVal:function(e){var t,i=Utils.is("String",e)?Utils.$(e):e;if(i)return"input"===(t=i.tagName.toLowerCase())||"textarea"===t||"select"===t?i.getAttribute("kg-value")||i.value:i.getAttribute("kg-value")||(isIE8?i.innerText:i.textContent);throw new Error("No find protectedItem:"+e+" signatureid="+this.signatureid)},getProtectedData:function(e){function t(e){var t;if(Utils.is("String",e))t=a(e);else{if(!Utils.is("Object",e)||!e.field)throw new Error("Unsupported protectedItems:"+e.toString);t=e}return Utils.is("Function",t.value)&&(t.value=t.value.call(n,t.field,t.desc)),t.value=n._formatValue(t.value),t}var n=this,i=[],a=function(e){var t,i=Utils.$(e);if(i)return(t={field:e}).desc=i.getAttribute("kg-desc")||e,t.value=n.getItemVal(i),t;throw new Error("No find protectedItem:"+e+" signatureid="+this.signatureid)};if(e)if(Utils.is("Array",e))for(var o=0,s=e.length;o<s;o++)i.push(t(e[o]));else i.push(t(e));return i},__findSignedData:function(e){if(Utils.is("String",e))return e.split(";")[0];if(Utils.is("Array",e))return e[0];throw new Error("error signeddata: "+e)},getValidatedSignData:function(){var e=stringify(this.getVerifyProtectedData()),e=Utils.Base64.of().encode(e);return CryptoJS.SHA1(e).toString()},getSignData:function(e){for(var t=(e||this.signatureData).protectedData,i={},n=0;n<t.length;n++)i[t[n].field]=t[n].value;return Utils.Base64.of().encode(stringify(i))},showSignSignatureDialog:function(l){var c=this,g=Signature.options.verification,e={target:Utils.is("Array",l.target)?l.target:[l.target],title:kinggrid.msg("SignSignature","KG_TITLE"),onCancel:function(){$("#kg-password").blur(),Signature.options.dlgCancelCall&&Signature.options.dlgCancelCall.call()},onShow:function(){var t,i,a,o,s,e,n,r=this;Signature.editThemeColor(),Signature.repairInputEvent($("#kg-password")),g?(i=(t=c).signatureData.keysn,a="",o=r.find(".kg-tipText"),c.sealService.getTelphone({keysn:i,successCall:function(e){e.result?(o.html(e.phone),a=e.phone):c.errorCallback(e.massage,l.errorCall)}}),(o=r.find(".kg-tipText")).html(a),o.click(function(){o.hide(),r.find("#kg-revokeVerifyCode").focus()}),r.find("#kg-revokeVerifyCode").click(function(){o.hide(),r.find("#kg-revokeVerifyCode").focus()}),s=r.find(".kg-revokeMark"),r.find(".kg-revokeBtn").click(function(e){plus.showLoading();var n=$(this);t.sealService.applySMSCode({keysn:i,successCall:function(e){var t,i;e.result?(clearInterval(i),plus.hideLoading(),o.css({display:"block"}).html("已发送验证码"),s.css({display:"block"}),t=60,i=setInterval(function(){0<=t?(t<10&&(t="0"+t),n.html(t+"秒"),t--):(n.html("验证码"),s.css({display:"none"}),o.html(a),clearInterval(i))},1e3)):c.errorCallback(e.message,l.errorCall)}})}),r.find("#kg-revokeVerifyCode").keydown(function(e){13==e.keyCode&&r.options.onOk.call(r)})):(setTimeout(function(){r.find("#kg-password").focus()},40),r.find("#kg-password").keydown(function(e){13==e.keyCode&&r.options.onOk.call(r)}),e=Signature.options.pwdIsEncrypt,n=Signature.options.password,e&&n&&r.find("#kg-password").val(n))},onOk:function(){var t=this,i=t.find("#kg-password"),n=t.find("#kg-revokeVerifyCode");if(g){if(!n.val())return plus.alert(kinggrid.msg("in_verification_msg","KG_MSG"),function(){n.focus()}),!1}else if(!i.val())return plus.alert(kinggrid.msg("in_input_msg","KG_MSG"),function(){i.focus()}),!1;c.sealService.checkKeysn.call(c,{keysn:c.signatureData.keysn,usercode:c.signatureData.usercode},function(e){return e.result?g&&n.val()?(plus.showLoading(),void c.sealService.verifyPwd({verify:Signature.options.verification,pwd:n.val(),keysn:l.target.keysn,successCall:function(e){if(plus.hideLoading(),e.result)return l._onOk.call(t,n.val()),!1;c.error(e,null,null,{_beginDlgOkCall:!0})}})):(l._onOk.call(t,i.val()),!1):(c.error(e,null,null,{_beginDlgOkCall:!0}),!1)})}};return c.showDialog("signSignatureBtl",e)},changeMoveAble:function(e,t){this.signatureData.moveable=e,this.fireUpdate(),t&&t()},signSignature:function(n){var a=this,t={target:a,_onOk:function(e){var t=this,i=a.getH5SignData();a.runSign(i,e,null,function(e){e.result?a.fireUpdate(function(e){e&&t.remove()}):a.error(e,null,null,{_beginDlgOkCall:!0}),n&&n(e)})}};if(!a.signatureData.phoneshield)return a.showSignSignatureDialog(t);"client"==Signature.options.sealType&&a.sealService.getPhoneShieldLic({phoneshield:Signature.options.phoneshield},function(e){"1"==e.phoneshield||"3"==e.phoneshield?(kinggrid.options.timeout=1e3*(e.validatetime+10),t._onOk("")):"2"==e.phoneshield?a.error({errcode:"11110"},"then"):a.error({errcode:"11109"},"then")})},showRevokeSignatureDialog:function(l){var c=this,g=Signature.options.verification,e={target:Utils.is("Array",l.target)?l.target:[l.target],title:kinggrid.msg("RevokeSignature","KG_TITLE"),quickClose:null==Signature.options.quickClose||Signature.options.quickClose,onCancel:function(){Signature.options.dlgCancelCall&&Signature.options.dlgCancelCall.call()},onShow:function(){Signature.options.beginDlgShowCall&&Signature.options.beginDlgShowCall.call();var t,i,a,o,s,e,n,r=this;Signature.editThemeColor(),Signature.repairInputEvent($("#kg-password")),g?(i=(t=c).signatureData.keysn,a="",o=r.find(".kg-tipText"),c.sealService.getTelphone({keysn:i,successCall:function(e){e.result?(o.html(e.phone),a=e.phone):t.errorCallback(e.massage,l.errorCall)}}),(o=r.find(".kg-tipText")).html(a),o.click(function(){o.hide(),r.find("#kg-revokeVerifyCode").focus()}),r.find("#kg-revokeVerifyCode").click(function(){o.hide(),r.find("#kg-revokeVerifyCode").focus()}),s=r.find(".kg-revokeMark"),r.find(".kg-revokeBtn").click(function(e){plus.showLoading();var n=$(this);t.sealService.applySMSCode({keysn:i,successCall:function(e){var t,i;e.result?(clearInterval(i),plus.hideLoading(),o.css({display:"block"}).html($.kgi18n.prop("sentSMSCode")),s.css({display:"block"}),t=60,i=setInterval(function(){0<=t?(t<10&&(t="0"+t),n.html(t+"秒"),t--):(n.html("验证码"),s.css({display:"none"}),o.html(a),clearInterval(i))},1e3)):c.errorCallback(e.message,l.errorCall)}})}),r.find("#kg-revokeVerifyCode").keydown(function(e){13==e.keyCode&&r.options.onOk.call(r)})):(r.find("#kg-password").keydown(function(e){13==e.keyCode&&r.options.onOk.call(r)}),e=Signature.options.pwdIsEncrypt,n=Signature.options.password,e&&n&&r.find("#kg-password").val(n))},onOk:function(){var e=this.find("#kg-password"),t=this.find("#kg-revokeVerifyCode");if(g){if(!t.val())return plus.alert(kinggrid.msg("in_verification_msg","KG_MSG"),function(){t.focus()}),!1}else if(!e.val())return plus.alert(kinggrid.msg("in_input_msg","KG_MSG"),function(){e.focus()}),!1;return l._onOk.call(this,(g?t:e).val()),!1}};return c.showDialog("signSignatureBtl",e)},revokeSignature:function(o){function s(t){void 0!==Signature.options.delCallBack&&Signature.options.delCallBack?Signature.options.delCallBack(r.signatureid,r.signatureData)&&r.fireRemove(function(e){e&&(t.remove?t:r).remove()}):r.fireRemove(function(e){e&&(t.remove?t:r).remove()})}var r=this;if("scanStamp"!=r.signatureData.stampType||Signature.options.clientConfig){t={target:r,_onOk:function(e,t){var i=this,n=r.signatureData.seal.esid,a=r.signatureData.keysn;plus.showLoading(),n&&!a?(plus.hideLoading(),r.sealService.getRemoveAuthority(r.signatureid,r.signatureData,function(e){e?(s(i),o&&o({result:!0})):i.remove()})):r.sealService.verifyPwd({verify:Signature.options.verification,pwd:e,keysn:r.signatureData.keysn,successCall:function(e){plus.hideLoading(),!e.result||null!=e.delkeysn&&e.delkeysn!=r.signatureData.keysn?r.error(e,null,null,{_beginDlgOkCall:!0}):s(i),o&&o(e)},phoneshield:t})}};if(r.signatureData.phoneshield&&"client"==Signature.options.sealType)r.sealService.getPhoneShieldLic({phoneshield:"1"},function(e){"1"==e.phoneshield||"3"==e.phoneshield?(kinggrid.options.timeout=1e3*(e.validatetime+10),t._onOk("","1")):"2"==e.phoneshield?r.error({errcode:"11110"},"then"):r.error({errcode:"11109"},"then")});else{if(!Signature.options.showNoPW||"server"!=Signature.options.sealType)return r.showRevokeSignatureDialog(t);t._onOk(Signature.options.password)}}else{var t={title:kinggrid.msg("RevokeSignature","KG_TITLE"),target:r,onCancel:!1},i=Signature.ScanStamp.call(r,function(){return r.showDialog("scanStampdlg",t)},function(e){var t;e.result?(t=i.dialog,s(t)):r.error(e,null,null,{_beginDlgOkCall:!0}),o&&o(e)}),e=r.signatureData.esid;i.getQrCodeImageByDelete(e)}},showDialog:function(t,e){e.sucCall;var i,n,a,o,s,r,l=Utils.is("Array",e.target)?e.target:[e.target],c={title:kinggrid.msg("KinggridSignature","KG_TITLE"),onShow:function(){var t=this;Signature.editThemeColor(),setTimeout(function(){t.find("#kg-password").focus()},40),t.find("#kg-password").keydown(function(e){13==e.keyCode&&t.options.onOk.call(t)})},onCancel:e.errCall||function(){return plus.hideLoading(),!0},content:function(){var e=[Signature.options.template[t]].concat(l);return Utils.template.apply(null,e)}},c=Utils.extend(c,e),g=plus.showDialog(t,c);return"showSealsBtl"===t&&(i=g.find("#sealTpl-dialog"),n=!1,r=s=o=a=0,i.prevObject[0].onmousedown=function(e){n=!0,null!=(e=e||event)&&(a=e.clientX,o=e.clientY,s=parseInt(i.prevObject[0].style.top),r=parseInt(i.prevObject[0].style.left))},i.prevObject[0].onmousemove=function(e){var t;n&&null!=(e=e||event)&&(t=r+e.clientX-a,e=s+e.clientY-o,0<t&&0<e&&(i.prevObject[0].style.left=t+"px",i.prevObject[0].style.top=e+"px"))},i.prevObject[0].onmouseup=function(e){n&&(n=!1,r=s=o=a=0)}),"signatureInfoBtl"!=t&&"signInfoBtl"!=t||g.find(".ui-dialog-close").click(function(){g.close(),Signature.options.dlgCancelCall&&Signature.options.dlgCancelCall.call()}),g},runMove:function(e,t,i){var a,o=this,n=(globalLisenter.trigger("startMove",o,e,t),function(e){var t,i,n=e.moveableRange;if(!n){for(i in e.position){t=i;break}e=$("#"+t).attr("kg-mita");e&&(n=e)}if(n){e=$("#"+n);if(0<e.length)return{left:e.offset().left,right:e.offset().left+e.outerWidth(),top:e.offset().top,bottom:e.offset().top+e.outerHeight()}}return{left:0,right:0,top:0,bottom:0}});return"client"==Signature.options.sealType&&Signature.options.moveable_self&&o.keysn!=o.signatureData.keysn?(Signature.alert(kinggrid.msg("cannot_move","KG_MSG")),!1):(e=e,t=t,a=i,i=n(o.signatureData),(t=Drag.create(t,e,!0,i)).onend=function(e,t,i,n){a&&a(t,i,n),globalLisenter.trigger("endMove",o,e,i,n),t&&(e=$(this),o.updatePos(e.attr("elemid"),{marginLeft:i,marginTop:n}),o.fireUpdate())},e.preventDefault(),t)},runSign:function(i,e,t,n){var a=this,o=a.signatureData;if(Signature.options._clientHW)return Signature.options._clientHW=!1,n({result:!0});plus.showLoading(),a.certService.sign({seal:this.signatureData.seal,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,documentid:this.signatureData.documentid,documentname:this.signatureData.documentname,password:e,type:t,phoneshield:this.signatureData.phoneshield,signMeta:i,successCall:function(e){var t;plus.hideLoading(),e.result&&(e.signeddata?(e.certinfo.algName=e.certinfo.algName.toUpperCase(),t=Utils.is("Array",e.tsaInfo)?e.tsaInfo[0]:e.tsaInfo,a.updateItem("signMeta",{hashAlg:i[0].hashAlg,encryptAlg:i[0].encryptAlg,signdata:i[0].signdata,signeddata:a.__findSignedData(e.signeddata),certinfo:e.certinfo,tsaInfo:t})):(e.result=!1,e.errcode="signErr"),o.certType=Signature.options.certType),n&&n(e)}})}}),kingPlus()),aisleKing,signature=(Signature.options=$.extend({savelogFlg:!0,b64Url:"/iWebSignature_base64",imageUrl:"/iWebSignature_image",languagesPath:"../kinggrid/languages",pw_enc_save:!0,autoCertMode:!0,showSealsDlg:!0,encryptPwd:!0,showRememberPwd:!0,version:"iSignature_HTML5(V3.0)",verification:!1},kinggrid.options,{dialogConfig:{okValue:"确  定",cancelValue:"取  消",fixed:!0,backdropOpacity:.2,modal:!0},template:{},themeColor:{red:{"primary-background-color":"#C62929","primary-border-color":"#C62929","primary-color":"#ffffff","primary-hover-background-color":"#e45a5a","primary-hover-border-color":"#e45a5a","primary-hover-color":"#ffffff","default-background-color":"#ffffff","default-border-color":"#cccccc","default-color":"#333333","default-hover-background-color":"#ffffff","default-hover-border-color":"#C62929","default-hover-color":"#C62929","second-background-color":"#fff","second-color":"#C62929","second-hover-background-color":"#fff4f4","second-hover-color":"#C62929","primary-select-image":'url("image/select_red.png") no-repeat center white',"primary-box-shadow":"0px 2px 6px rgba(198, 41, 41,.2)"},blue:{"primary-background-color":"#1890ff","primary-border-color":"#1890ff","primary-color":"#ffffff","primary-hover-background-color":"#4eaaff","primary-hover-border-color":"#4eaaff","primary-hover-color":"#ffffff","default-background-color":"#ffffff","default-border-color":"#cccccc","default-color":"#333333","default-hover-background-color":"#ffffff","default-hover-border-color":"#1890ff","default-hover-color":"#1890ff","second-background-color":"#fff","second-color":"#1890ff","second-hover-background-color":"#eef7ff","second-hover-color":"#1890ff","primary-select-image":'url("image/select_blue.png") no-repeat center white',"primary-box-shadow":"0px 2px 6px rgba(0, 132, 255,.2)"}}},window.KGCONFIG),Signature.addProvider=function(e,t,i){Signature.factory[e][t]=i},Signature.init=function(e,t){this.Seals={},Utils.extend(Signature.options,e);var i=Signature.options,e=(t=t||e.okCall,i.serverUrl&&(i.b64Url="_signature_b64",i.imageUrl="_signature_image",0<i.serverUrl.indexOf("?")?i.serverUrl=i.serverUrl+"&action=rest":i.serverUrl=i.serverUrl+"?action=rest"),aisleKing="client"==i.sealType?(i.clientUrl=i.https,Signature.aisleKing=kinggrid.surry(i.clientUrl||"http://127.0.0.1:9581","IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode)):Signature.aisleKing=kinggrid.surry(i.serverUrl||i.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode),i.clientConfig),e=(e&&"client"===i.sealType?(i.LANGUAGE=i.clientConfig.LANGUAGE,Signature.AXI("SetParamByName",e,t)):t&&t.call(),jQuery.kgi18n.normaliseLanguageCode({}));i.isMobile=/phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone/i.test(navigator.userAgent),i.LANGUAGE?i.Global=i.LANGUAGE.substring(0,2):(i.LANGUAGE=e,2<jQuery.kgi18n.normaliseLanguageCode({}).length?i.Global=e.substring(0,2):i.Global=e),i.autoCertMode&&(i.icon_sign=!1,i.icon_signverify=!1),this.dynamicLoadCss(i.languagesPath+"/style/language_"+i.Global+".css"),this.loadProperties(),globalLisenter.trigger("init")},Signature.factory={cert:{},seal:{}},Signature.SealService=SealService,Signature.CertService=CertService,Signature.asyn={},Signature._create=function(e){var o=this;return o.setAttr(e),o.certService=new Signature.factory.cert[o.certType](e),o.sealService=new Signature.factory.seal[o.sealType](e),o.on("createSignature",function(e,t,i){var e=e.signatureData,n=[],a="盖章成功",e=(e.phone&&null!=e.phone&&""!=e.phone&&(a="盖章成功【手机短信验证"+e.phone+"】"),o._getLogInfo({LOGTYPE:"00",LOGSORT:"13",LOGMEMO:a,LOGSORTSUBCLASS:"1301"}));n.push(Utils.extend(t||{},e)),i&&n.push(o._getLogInfo({LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"数字签名成功"})),o.sealService.saveLog(n)}),this},function(){}),prototype=(signature.prototype=Signature.prototype,new signature),emptyInput="";function formartSignatureData(e,t,i){var n,a=[],o={};for(n in e){var s={},r=e[n];Utils.is("String",r)&&0!=r.indexOf("ey")?(s["b64_"+n]=e[n],a.push(s)):o[n]=r}var l,c=[],g=o;for(l in g)c.push(new Signature(l,g[l]).load(Signature.options));var d,u=a.length;if(u)for(var h=Signature.options.signSize||5,p=Math.ceil(u/h),f=1;f<=p;f++){var m=h*(f-1),v=u<h*f?u:h*f;(aisleKing=kinggrid.surry(Signature.options.serverUrl)).request(Signature.options.b64Url,a.slice(m,v)).ret(function(e){if(e.result)for(var t in e){var i;0==t.indexOf("b64_")&&(i=e[t],Utils.is("String",i)&&(i=JSON.parse(i)),c.push(new Signature(t.substring(4),i).load(Signature.options)))}else Signature.prototype.error.call(null,e)})}null!=aisleKing&&(d=function(){t&&t(1==c.length?c[0]:c)},u?aisleKing.fin(d):d(),i&&i())}Signature.scanCallBack=function(){},Signature._create.prototype=prototype,$.extend(prototype,{keyData:null,sealExpired:function(e,t,i,n,a){var o,s,r,l,c=this,g=!0;return void 0===Signature.options.valid||null===Signature.options.valid||!1===Signature.options.valid?c.certExpired(t,i,n):void 0===e.endata||null===e.endata?(r=Signature.options.serverUrl+"_key_sealIsExpired",l=parseInt(a),a=(l+=1).toString(),$.ajax({url:r,type:"POST",data:{keysn:c.keyData.keysn,year:(new Date).getFullYear(),month:(new Date).getMonth(),date:(new Date).getDate(),index:a},async:!1,success:function(e){return e.error?(c.errorCallback({errcode:"11105"},t.errorCall),!1):0==e.result?c.certExpired(t,i,n):(c.errorCallback({errcode:"11104"},t.errorCall),!1)},error:function(e){c.errorCallback({errcode:"11105"},t.errorCall)}}),!1):(l=e.endata,r=parseInt(i.substr(0,4)),a=parseInt(i.substr(5,2)),e=parseInt(i.substr(8,2)),o=parseInt(l.substr(0,4)),s=parseInt(l.substr(5,2)),l=parseInt(l.substr(8,2)),(g=o<r?(c.errorCallback({errcode:"11104"},t.errorCall),!1):r!=o||(s<a?(c.errorCallback({errcode:"11104"},t.errorCall),!1):a!=s||(!(l<e)||(c.errorCallback({errcode:"11104"},t.errorCall),!1))))?c.certExpired(t,i,n):g)},certExpired:function(r,l,c){var g=this,d=!1;return void 0===Signature.options.valid||null===Signature.options.valid||!1===Signature.options.valid||(kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode).invoke("KGGetCerInfo","").ret(function(e){var t,i,n,a=parseInt(l.substr(0,4)),o=parseInt(l.substr(5,2)),s=parseInt(l.substr(8,2));e.result?(e=e.certinfo.notAfter,t=parseInt(e.substr(0,4)),i=0==(i=parseInt(e.substr(4,1)))?parseInt(e.substr(5,1)):parseInt(e.substr(4,2)),n=0==(n=parseInt(e.substr(6,1)))?parseInt(e.substr(7,1)):parseInt(e.substr(6,2)),t<a||a==t&&(i<o||o==i&&n<s)?g.errorCallback({errcode:"11103"},r.errorCall):d=!0):g.errorCallback({errcode:"11106"},r.errorCall),null!=c&&c(d)}),d)},errorCallback:function(e,t,i,n){t?(plus.hideLoading(),t.call(null,e,i)):this.error(e,i,null,n)},runHW:function(n,a){var e,o=this;plus.showLoading(),void 0!==n.imageData&&null!=n.imageData?(void 0!==n.beginCall&&n.beginCall&&n.beginCall.call(o),o.sealService.loadSeal({data:n.imageData,successCall:function(e){if(plus.hideLoading(),e.result&&e.seals.length){for(var t in e.seals){var i=e.seals[t].sealTag||e.seals[t].sealtag,i=[{width:n.width,height:n.height,imgext:e.seals[t].imgext,signname:n.name,signsn:e.seals[t].signsn,username:e.seals[t].username,imgdata:n.imageData,sealTag:i,seSeal:e.seals[t].seSeal,headinfoex:e.seals[t].headinfoex}];e.seals=i;break}o.keyData=e,o.showSeals(a)}else o.errorCallback({errcode:"111000"},n.errorCall)},errorCall:function(e){o.errorCallback(e,n.errorCall)}})):n.qrCodeUserUid&&(plus.hideLoading(),(e={}).qrCodeUserUid=n.qrCodeUserUid,e.seals=n.sealData,e.reuslt=!0,e.ServerTime=new Date(+new Date+288e5).toJSON().substr(0,19).replace("T"," "),e.username=n.username,e.esid=n.esid,n.stampType&&(e.stampType=n.stampType),o.keyData=e,o.showSeals(a))},run:function(i){var n=this;n.showPromptDialog(function(){return n.keyData?n.showSeals(i):(plus.showLoading(),void 0!==i.beginCall&&i.beginCall&&i.beginCall.call(n),n.sealService.loadSeal({type:i.type,successCall:function(t){plus.hideLoading(),t.result?t.seals&&t.seals.length?(n.keyData=t,n.sealService.getKeysn({},function(e){Signature._getCookie("ksn")!=e&&Signature.clearRPW();var e=n.keyData.seals;Signature._showAndHideSealsDlg(e),Signature.options.clientConfig||void 0===Signature.options.imgtag||0===Signature.options.imgtag||void 0!==t.ServerTime?(n.curDate=t.ServerTime,n.showSeals(i)):void 0!==n.serverUrl&&null!==n.serverUrl?(e={usercode:n.usercode,keysn:n.keyData.keysn,signname:n.signname,authcode:Signature.authcode},kinggrid.surry(n.serverUrl).request("_key_load",e).ret(function(e){e.result?(n.curDate=e.ServerTime,n.keyData=e,n.showSeals(i)):n.errorCallback(e,i.errorCall)})):(n.curDate=(new Date).toLocaleString(),n.showSeals(i))})):n.errorCallback({errcode:"11100"+Signature.options.imgtag},i.errorCall):n.errorCallback(t,i.errorCall)},errorCall:function(e){n.errorCallback(e,i.errorCall)}})),this})},getSealsByKeysn:function(e,n,t){var a=this;a.sealService.loadSeal({successCall:function(e){if(e.result){var t=[];if(void 0!==n&&null!=n){for(var i=0;i<e.seals.length;++i)t[i]=a.toBase64Img(e.seals[i]);n(t)}}},errorCall:function(e){a.errorCallback(e,t.errorCall)}})},loadSeals:function(t,i){var n=this;n.sealService.loadSeal({successCall:function(e){null!=t&&null!==e&&void 0!==e.seals&&null!==e.seals&&t(e)},errorCall:function(e){n.errorCallback(e,i&&i.errorCall?i.errorCall:null)}})},runSS:function(t,e){var i,n=this;null!==e&&(null==(n.keyData=e).seals||0==e.seals.length?n.errorCallback({errcode:"11107"},t.errorCall):void 0!==Signature.options.imgtag&&0!==Signature.options.imgtag&&void 0===e.ServerTime?void 0!==n.serverUrl&&null!==n.serverUrl?(i={usercode:n.usercode,keysn:n.keyData.keysn,signname:n.signname,authcode:Signature.authcode},kinggrid.surry(n.serverUrl).request("_key_load",i).ret(function(e){e.result?(n.curDate=e.ServerTime,n.keyData=e,n.showSeals(t)):n.errorCallback(e,t.errorCall)})):(n.curDate=(new Date).toLocaleString(),n.showSeals(t)):(n.curDate=e.ServerTime,n.showSeals(t)))},formatPos:function(e,i,n){var a={};if(e){function t(e){var t=e.elemid||e[0].id;a[t=t||"body"]=null!=i&&null!=n?{marginLeft:i,marginTop:n}:Utils.filter(e,t)}if(Utils.is("Array",e))for(var o=0;o<e.length;o++)t(e[o]);else Utils.is("String",e)?a[e]=null!=i&&null!=n?{marginLeft:i,marginTop:n}:{}:t(e)}else a.body={};return a},exec:function(i,n,a,t,o,s){function r(t){var e=c.signatureData;if(!t||!t.position)throw new Error("no set position");t.offsetX&&t.offsetY?(t.changeOffsetXY&&t.changeOffsetXY(t),e.position=c.formatPos(t.position,t.offsetX,t.offsetY)):t.changeOffsetXY?(i={width:Math.ceil(9600*parseFloat(a.width)/254),height:Math.ceil(9600*parseFloat(a.height)/254)},i=t.changeOffsetXY(i),e.position=c.formatPos(t.position,i.offsetX,i.offsetY)):e.position=c.formatPos(t.position);var i=t.signatureid||c.genId(),n=(t&&t.scopePosition&&(null==Signature.options.extra&&(Signature.options.extra={}),Signature.options.extra[i]={scopePosition:t.scopePosition}),e.timeid=(new Date).getTime(),new Signature(i,e).load(Signature.options));t.okCall&&(i={name:a.signname,height:a.height,width:a.width,imgdata:c.toBase64Img(a)},t.isBatchSignature?t.okCall.call(n,function(e){},t.documentid):t.okCall.call(n,function(e){c.trigger("createSignature",n,t.logMeta,g),e&&n.show()},i)),plus.hideLoading()}var l,c=this,e=(delete c.signatureData,e=null!=i.protectedItemsType&&"1"==i.protectedItemsType?i.protectedItems:c.getProtectedData(i.protectedItems),{timestamp:{time:(null==i.signtime?new Date:new Date(Date.parse(i.signtime.replace(/-/g,"/")))).getTime(),signtime:null==i.showtime?i.signtime:i.showtime,timestampInfo:i.timestampInfo},appname:Signature.options.version,documentid:(null==i.documentid?c:i).documentid,documentname:(null==i.documentname?c:i).documentname,moveable:Utils.boolean(i,"moveable",Signature.options.moveable),keysn:c.keyData.keysn,orgname:c.keyData.orgname,usercode:c.keyData.usercode,username:c.keyData.username||a.username,phoneshield:!!Signature.options.phoneshield,gbOvalue:c.keyData.gbOvalue,seal:a,phone:Signature.options.verification?c.keyData.phone:null,moveableRange:i.moveableRange,protectedData:e,sealType:i.sealType||c.sealType,extparam:i.extparam,ver:Signature.version,postilFontSet:i.postilFontSet,dateTime:i.datetime}),g=(c.keyData.stampType&&(e.stampType=c.keyData.stampType),a.esid&&(e.esid=a.esid),c.keyData.qrCodeUserUid&&(e.qrCodeUserUid=c.keyData.qrCodeUserUid),c.signatureData=e,c.certService.sData=c.signatureData,c.sealService.sData=c.signatureData,plus.showLoading(),Signature.options.autoCertMode||i.autoCert||c.autoCert||Signature.options.phoneshield&&"1"!=Signature.options.fjrsIsphone);g||"scanStamp"===e.stampType?(i.hashAlg||c.hashAlg,i.encryptAlg||c.encryptAlg,c.getSignData(e),l=c.getH5SignData(),i.signMeta&&l[Utils.is("Array",i.signMeta)?"concat":"push"](i.signMeta),i.beforeSignCall&&i.beforeSignCall.call(c,l),o?"client"==Signature.options.sealType?c.runSign(l,t,i.type,function(e){e.result&&(r(i),s&&1<s.batchSignature.length&&(i.documentid=s.batchSignature[s.batchSignature.length-1].documentid,i.documentname=s.batchSignature[s.batchSignature.length-1].documentname,i.position=s.batchSignature[s.batchSignature.length-1].position,i.protectedItems=s.batchSignature[s.batchSignature.length-1].protectedItems,--s.batchSignature.length,c.exec(i,n,a,t,o,s))),n(e)}):c.sealService.verifyPwd({verify:Signature.options.verification,pwd:t,keysn:e.keysn,successCall:function(e){e.result?r(i):Signature.options.pwd_clear_flag&&c.onDeleteRPW&&c.onDeleteRPW(),n(e)},phoneshield:Signature.options.phoneshield}):c.keyData.noPassWord||c.signatureData.seal.esid?c.runSign(l,t,i.type,function(e){e.result?r(i):c.error(e,null,null,{_beginDlgOkCall:!0}),n({result:!0})}):c.sealService.checkKeysn.call(c,{keysn:c.signatureData.keysn,usercode:c.signatureData.usercode},function(e){e.result?c.runSign(l,t,i.type,function(e){var t;e.result&&(t=c.keyData.seals,setTimeout(function(){Signature._showAndHideSealsDlg(t)}),r(i)),n(e)}):c.error(e,null,null,{_beginDlgOkCall:!0})})):o?r(i):c.sealService.verifyPwd({verify:Signature.options.verification,pwd:t,keysn:e.keysn,successCall:function(e){var t;e.result?(t=c.keyData.seals,setTimeout(function(){Signature._showAndHideSealsDlg(t)}),r(i)):Signature.options.pwd_clear_flag&&c.onDeleteRPW&&c.onDeleteRPW(),n(e)},phoneshield:Signature.options.phoneshield})},runPwd:function(i){var n=this,e={cancelCall:i.cancelCall,_onOk:function(e){Signature.options.showNoPW=!0,Signature.options.password=e;var t=this.find("#kg-remenberPwd").is(":checked");n.trigger("execSuccess",this,e,t),n.run($.extend(i,{beginCancalCall:function(){Signature.options.showNoPW=!1,Signature.options.password=emptyInput}}))}};n.showPwdDialog(e)},showPwdDialog:function(e){var i=this,n=e._onOk;i.showDialog("inputTpl",{onCancel:function(){$("#kg-password").blur(),e.cancelCall()},onShow:function(){var t=this;i.trigger("showSealsDialog_PW",t),Signature.editThemeColor(),Signature.repairInputEvent($("#kg-password")),setTimeout(function(){t.find("#kg-password").focus()},40),t.find("#kg-password").keydown(function(e){13==e.keyCode&&t.options.onOk.call(t)})},onOk:function(){var e=this.find("#kg-password"),t=e.val();return t?(n.call(this,t),this.remove()):plus.alert(kinggrid.msg("in_input_msg","KG_MSG"),function(){e.focus()}),!1},content:function(){var e=[plus.template.inputTpl];return Utils.template.apply(null,e)}})},showPromptDialog:function(t){var o=this,a="kg-certValidaty-dontShow",s={},r="",l=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);function c(t,e){var i,n,a;e.result?(i=e.certinfo.notAfter,a=(a=new Date(+new Date+288e5).toISOString().replace(/T/g," ").replace(/\.[\d]{3}Z/,"")).replace(/-/g,"/"),t.days=(n=i,a=a,n=new Date(d(i)),a=new Date(d(a)),Math.floor((n-a)/864e5)),l.invoke("KGGetPublicParm","Customer","ValidateCertUpdateURL","").ret(function(e){e&&(r=e)}),l.invoke("KGGetPublicParm","Public","HintRemainingDays","").ret(function(e){t.days>e?g(!0):(t.days<=e&&0<t.days?t.certStatus=1:t.certStatus=0,g())})):(Signature.options.password=emptyInput,o.errorCallback({errmsg:e.errmsg}))}function g(e){e||"true"==function(){for(var e=document.cookie.split("; "),t=null,i=0;i<e.length;i++){var n=e[i].split("=");if(n[0]==a){t=n[1];break}}return t}()?t&&t():o.showDialog("prompt",n)}function i(){r?window.open(r):o.errorCallback({errmsg:"获取地址失败"})}o.clientConfig?l.invoke("KGGetPublicParm","Customer","ValidateCertExpireTime","").ret(function(e){typeof e==String&&"true"==e.toLowerCase()?Signature.options.password||Signature._getCookie("pwd")?(e=Signature._getCookie("pwd")||Signature.options.password,l.invoke("KGGetCerInfo",e).ret(function(e){c(s,e)})):o.showPwdDialog({cancelCall:function(){plus.hideLoading()},_onOk:function(t){var i=this,n=i.find("#kg-remenberPwd").is(":checked");l.invoke("KGGetCerInfo",t).ret(function(e){e.result?(Signature.options.password=t,o.trigger("execSuccess",i,t,n),c(s,e)):o.errorCallback({errmsg:e.errmsg})})}}):g(!0)}):t();var n={cancelCall:function(){},onShow:function(){Signature.editThemeColor();var e,t=Signature._color||"red";switch(setTimeout(function(){root.iframeDialog?($(window.top.document).find("[i-id=cancel]").html($.kgi18n.prop("GoToRenewal")),$(window.top.document).find("[data-kgi18n-html]").each(function(e){$(this).html($.kgi18n.prop($(this).data("kgi18n-html"))),$(this).addClass("kg-fontFamily")}),o.isMobile||$(window.top.document).find(".ui-dialog-button").css("float","right")):($("[i-id=cancel]").show(),$("[i-id=cancel]").html($.kgi18n.prop("GoToRenewal")),o.isMobile||$(".ui-dialog-button").css("float","right"))},100),$("[i-id=cancel]").click(i),e=(root.iframeDialog?$(window.top.document):this).find(".kg-promtInfo"),s.certStatus){case 0:return void e.html('<i class="kg-icon-prompt"/><span data-kgi18n-html="RenewalPastDue"></span>');case 1:return e.html('<i class="kg-icon-prompt"/><span data-kgi18n-html="RenewalInfoLeft"></span> <span id="kg-date">'+s.days+'</span> <span data-kgi18n-html="RenewalInfoRight"></span>'),void this.find(".ui-dialog-checkInput").html('<div class="kg-tipCheck"><input type="checkbox" name="noPrompt" class="kg-primary-check-'+t+'" id="kg-noPrompt" >&nbsp;<label for="kg-noPrompt" data-kgi18n-html="NoPrompt">不再提示</label></div>')}},onOk:function(){var e;this.find("#kg-noPrompt").is(":checked")&&((e=new Date).setTime(e.getTime()+864e5),document.cookie=a+"=true;expires=+"+e.toGMTString()),s.certStatus&&t&&t()},content:function(){var e=[plus.template.prompt];return Utils.template.apply(null,e)}};function d(e){return 0<e.indexOf("/")?e:e.slice(0,4)+"/"+e.slice(4,6)+"/"+e.slice(6,8)+" "+e.slice(8,10)+":"+e.slice(10,12)+":"+e.slice(12,14)}},getPassCheck:function(e,t,i){if(e&&1==e)return e;if(void 0===i||!0===i||"auto"===i)try{return t.find("#kg-remenberPwd").is(":checked")}catch(e){return!1}return!1},showSeals:function(c){var t,i,n,e,g=this,a={errorCall:c.errorCall,cancelCall:c.cancelCall,beginCancalCall:c.beginCancalCall,protectedItems:c.protectedItems,protectedItemsType:c.protectedItemsType,protectedItemsCheckedAll:null==c.protectedItemsCheckedAll||c.protectedItemsCheckedAll,_onOk:function(i,n,e,t,a,o){var s=this,r=new plus.kgFont(null==s.fontSel?null==g.signdate?{}:g.signdate:s.fontSel),l=s.isCheck,l=(!1!==Signature.options.showSealsDlg&&g.autoDlg||!Signature.options.signdate||!Signature.options.signdate.ischeck||(l=Signature.options.signdate.ischeck),c.protectedItems=null==s.proItems?0==c.protectedItemsCheckedAll?[]:c.protectedItems:s.proItems,c.datetime={isCheck:l,fontDate:r},new plus.kgFont(null==s.postilFontSet?null==g.thirdConfig||null==g.thirdConfig.postilFontSet?{}:g.thirdConfig.postilFontSet:s.postilFontSet,"0"));if(l.fontValue=null!=g.postilFontSet&&null!=g.postilFontSet.fontValue?g.postilFontSet.fontValue:"",c.postilFontSet=l,null!=t?(c.signtime=t,null!=a?(a.TimeExt?c.showtime=(t+" ("+a.TimeExt+")").replace(/-/g,"/"):c.showtime=t.replace(/-/g,"/"),c.showtime+=kinggrid.msg("timestamp_time","KG_MSG"),c.timestampInfo=a):(c.showtime=new Date(Date.parse(t.replace(/-/g,"/"))).toLocaleString(),c.showtime+=kinggrid.msg("server_time","KG_MSG"))):(c.signtime=void 0,c.showtime=(new Date).toLocaleString(),c.showtime+=kinggrid.msg("local_time","KG_MSG")),o=g.getPassCheck(o,s,Signature.options.showSealsDlg),void 0===Signature.options.valid||null===Signature.options.valid||!1===Signature.options.valid)c.batchSignature?g.sealService.verifyPwd({verify:Signature.options.verification,pwd:n,usercode:null==c.usercode?"":c.usercode,keysn:g.keyData.keysn,successCall:function(e){if(e.result){for(var t=0;t<c.batchSignature.length&&(c.batchSignature[t].signtime=c.signtime,c.batchSignature[t].showtime=c.showtime,null!=c.position&&(c.batchSignature[t].position=c.position),c.batchSignature[t].autoCert=c.autoCert,c.batchSignature[t].okCall=c.okCall,c.batchSignature[t].cancelCall=c.cancelCall,c.batchSignature[t].beginCall=c.beginCall,c.batchSignature[t].endCall=c.endCall,null!=c.protectedItems&&(c.batchSignature[t].protectedItems=c.protectedItems),c.batchSignature[t].protectedItemsType=c.protectedItemsType,c.batchSignature[t].datetime=c.datetime,c.batchSignature[t].offsetX=c.offsetX,c.batchSignature[t].offsetY=c.offsetY,c.batchSignature[t].changeOffsetXY=c.changeOffsetXY,c.batchSignature[t].isBatchSignature=!0,g.exec(c.batchSignature[t],function(e){e.result?void 0!==Signature.options.showNoPW||!0===Signature.options.showNoPW?void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g):void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||g.trigger("execSuccess",s,n,o):g.errorCallback(e,c.errorCall)},i,n,!0,c),void 0!==c.batchSignature[t].endCall&&c.batchSignature[t].endCall&&c.batchSignature[t].endCall.call(g),"client"!=Signature.options.sealType||!c.autoCert);++t);void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g),void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||s.remove()}else Signature.options.pwd_clear_flag&&g.onDeleteRPW&&g.onDeleteRPW(),g.errorCallback(e,c.errorCall)},phoneshield:Signature.options.phoneshield}):(g.exec(c,function(e){e.result?(void 0!==Signature.options.showNoPW||!0===Signature.options.showNoPW||Signature.options.phoneshield?void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g):void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||g.trigger("execSuccess",s,n,o),s.remove()):g.errorCallback(e,c.errorCall,null,{_beginDlgOkCall:!0})},i,n),void 0!==c.endCall&&c.endCall&&c.endCall.call(g));else if(void 0===g.curDate||null===g.curDate||!g.sealExpired(i,c,g.curDate,function(e){e?c.batchSignature?g.sealService.verifyPwd({verify:Signature.options.verification,pwd:n,keysn:g.keyData.keysn,successCall:function(e){if(e.result){for(var t=0;t<c.batchSignature.length&&(c.batchSignature[t].signtime=c.signtime,c.batchSignature[t].showtime=c.showtime,null!=c.position&&(c.batchSignature[t].position=c.position),c.batchSignature[t].autoCert=c.autoCert,c.batchSignature[t].okCall=c.okCall,c.batchSignature[t].cancelCall=c.cancelCall,c.batchSignature[t].beginCall=c.beginCall,c.batchSignature[t].endCall=c.endCall,null!=c.protectedItems&&(c.batchSignature[t].protectedItems=c.protectedItems),c.batchSignature[t].protectedItemsType=c.protectedItemsType,c.batchSignature[t].datetime=c.datetime,c.batchSignature[t].offsetX=c.offsetX,c.batchSignature[t].offsetY=c.offsetY,c.batchSignature[t].changeOffsetXY=c.changeOffsetXY,c.batchSignature[t].isBatchSignature=!0,g.exec(c.batchSignature[t],function(e){e.result?void 0!==Signature.options.showNoPW||!0===Signature.options.showNoPW||Signature.options.phoneshield?void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g):void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||g.trigger("execSuccess",s,n,o):g.errorCallback(e,c.errorCall)},i,n,!0),void 0!==c.batchSignature[t].endCall&&c.batchSignature[t].endCall&&c.batchSignature[t].endCall.call(g),"client"!=Signature.options.sealType||!c.autoCert);++t);void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g),void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||s.remove()}else g.errorCallback(e,c.errorCall)},phoneshield:Signature.options.phoneshield}):(g.exec(c,function(e){e.result?(void 0!==Signature.options.showNoPW||!0===Signature.options.showNoPW||Signature.options.phoneshield?void 0!==c.beginCancalCall&&c.beginCancalCall&&c.beginCancalCall.call(g):void 0!==Signature.options.showSealsDlg&&!0!==Signature.options.showSealsDlg&&!g.autoDlg||g.trigger("execSuccess",s,n,o),s.remove()):g.errorCallback(e,c.errorCall,null,{_beginDlgOkCall:!0})},i,n),void 0!==c.endCall&&c.endCall&&c.endCall.call(g)):g.errorCallback({errcode:"11103"},c.errorCall)},e))return}};void 0!==Signature.options.showSealsDlg?(e=!0,"auto"==Signature.options.showSealsDlg&&(t=g.keyData).seals&&1==t.seals.length&&(e=!1),g.autoDlg=e,!1!==Signature.options.showSealsDlg&&e?this.showSealsDialog(a):(void 0===Signature.options.password&&void 0!==g.password&&(Signature.options.password=g.password),e=Signature._getCookie("pwd"),e=e=Signature.options.pw_enc_save?Utils.Base64.of().decode(Signature._getCookie("pwd")):e,!Signature.options.remberPwdAndShowSealsDlg&&e?Signature.options.password=e:Signature.options.showSealsDlg&&(Signature.options.showSealsDlg=!0),void 0===Signature.options.password?g.errorCallback({errcode:"11108"},c.errorCall):(i=g.getSignTimeStamp(g.getProtectedData(c.protectedItems)),null!=Signature.options.timestamp&&1==Signature.options.timestamp?"client"==Signature.options.sealType?(n=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode)).invoke("KGGetTSURLInfo").ret(function(e){e.result?n.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,i,"").ret(function(e){e.result?a._onOk.call(g,g.keyData.seals[0],Signature.options.password,0,e.TimeStr,e):(g.errorCallback(e,c.errorCall,"KGGetTSWithDigest"),a._onOk.call(g,t.seals[0],pwdVal,0))}):(g.errorCallback(e,c.errorCall,"KGGetTSURLInfo"),a._onOk.call(g,t.seals[0],pwdVal,0))}):(e=Signature.options.serverUrl+"_key_getTimeStamp",$.ajax({url:e,type:"POST",data:{keysn:g.keyData.keysn,signTimeStamp:i},async:!1,success:function(e){e.result?a._onOk.call(g,g.keyData.seals[0],Signature.options.password,0,e.timestamp):a._onOk.call(g,g.keyData.seals[0],Signature.options.password,0)},error:function(e){a._onOk.call(g,g.keyData.seals[0],Signature.options.password,0)}})):a._onOk.call(g,g.keyData.seals[0],Signature.options.password,0)))):this.showSealsDialog(a)},showSealsDialog:function(u){for(var e,h=this,p=h.keyData,f=(null!=h.signdate&&(p.signDateIsCheck=h.signdate.ischeck),p.noPassWord=-1!=["scanStamp"].indexOf(p.stampType)),t=(p.isMobile=Signature.options.isMobile,p.showRememberPwd=Signature.options.showRememberPwd,e=null!=u.protectedItemsType&&"1"==u.protectedItemsType?u.protectedItems:h.getProtectedData(u.protectedItems),p.showProtectedBtn=e&&0<e.length&&Signature.options.showProtectedBtn,p.verification=h.verification,u.protectedItemsCheckedAll),i=new Array,n=0;e&&n<e.length;n++)i[n]=e[n],i[n].isChecked=t;null!=h.thirdConfig&&(p.thirdConfig=h.thirdConfig),p.newProItems=i,p.Global=Signature.options.Global;var a,o,s=[p],m=u._onOk,r=u.beginCancalCall,c=null,l={onCancel:function(){c&&c.blur(),u.cancelCall()},onShow:function(){var t,i=this,e=(i.find("#kg-remenberPwd").click(function(e){e.currentTarget.checked?i.find("#rememberPwdAndNotShowSealTpl-container")[0].className="kg-visible":i.find("#rememberPwdAndNotShowSealTpl-container")[0].className="kg-hide"}),Signature.editThemeColor(),"scanStamp"==p.stampType&&Signature.scanCallBack(),i.find(".kg-switcher")),o=(e.length&&(t=new Utils.Switcher(e[0],{}),e.find(".arrow-right").click(function(e){e.preventDefault(),t.swipeNext()}),e.find(".arrow-left").click(function(e){e.preventDefault(),t.swipePrev()}),e.find(".kg-guide span").click(function(e){e.preventDefault(),t.to(+this.getAttribute("index"))}),h.switcher=t),i.find("#kg-dateSet").click(function(e){h.showFontDialog(i)}),i.find("#kg-fontSet").click(function(e){h.showPostilFontDialog(i)}),null!=h.thirdConfig&&(null!=h.thirdConfig.commonlang&&i.find("#i-kg-common-lang").change(function(e){var t=this.options[this.selectedIndex].innerHTML;i.find("#kg-postil-value").val(t)}),null!=h.thirdConfig.fontEditCall&&i.find(".kg-fontSet-edit").click(function(){h.thirdConfig.fontEditCall(h.thirdConfig)}),h.thirdConfig.postilFontSet&&(e=i.find("#kg-postil-value"),h.thirdConfig.postilFontSet.fontFamily&&e.css({fontFamily:h.thirdConfig.postilFontSet.fontFamily}),h.thirdConfig.postilFontSet.fontSize&&e.css({fontSize:h.thirdConfig.postilFontSet.fontSize}),h.thirdConfig.postilFontSet.fontColor&&e.css({color:h.thirdConfig.postilFontSet.fontColor}))),c=Signature.options.verification?$("#kg-verification"):$("#kg-password"),Signature.repairInputEvent(c),h),s=Signature.options.keysn,r=h.keyData.phone,l=i.find(".kg-tipText");l.html(r),l.click(function(){l.hide(),i.find("#kg-verification").focus()}),i.find("#kg-verification").click(function(){l.hide(),i.find("#kg-verification").focus()}),i.find(".kg-verificationButton").click(function(e){plus.showLoading();var n=$(this),a=i.find(".kg-verificationMark");o.sealService.applySMSCode({keysn:s,successCall:function(e){var t,i;e.result?(clearInterval(i),plus.hideLoading(),l.css({display:"block"}).html($.kgi18n.prop("sentSMSCode")),a.css({display:"block"}),t=60,i=setInterval(function(){0<=t?(t<10&&(t="0"+t),n.html(t+"秒"),t--):(n.html("验证码"),a.css({display:"none"}),l.html(r),clearInterval(i))},1e3)):h.errorCallback(e.massage,u.errorCall)}})}),Signature.options.password&&i.find("#kg-password").val(Signature.options.password),h.trigger("showSealsDialog",i),Signature.options.showNoPW&&Signature.options.phoneshield||h.trigger("showSealsDialog_PW",i),i.find("#kg-remenberPwd")[0].checked&&(i.find("#rememberPwdAndNotShowSealTpl-container")[0].className="kg-visible"),i.find("#kg-password").keydown(function(e){13==e.keyCode&&i.options.onOk.call(i)}),i.find("#kg-verification").keydown(function(e){13==e.keyCode&&i.options.onOk.call(i)}),i.find("#kg-protectedDataSet").click(function(e){h.showProtectedDataDialog(i,u,p)})},onOk:function(){var i=this,e=i.find("#kg-password"),n=e.val()||Signature.options.password,t=i.find("#kg-verification").val(),a=i.find(".kg-wrapper .active"),o=(i.isCheck=i.find("#kg-addDate").is(":checked"),i.find("#kg-remenberPwd").is(":checked")),s=i.find("#kg-postil-value").val();if(h.postilFontSet=null==h.postilFontSet?{}:h.postilFontSet,h.postilFontSet.fontValue=s,i.find("#kg-rememberPwdAndNotShowSealTpl").is(":checked")&&(Signature.options.rememberPwdAndNotShowSealTpl=!0),Signature.options.verification){if(!t)return plus.alert(kinggrid.msg("in_verification_msg","KG_MSG"),function(){setTimeout(function(){e.focus()},100)}),!1;n=t}else if(!Signature.options.phoneshield&&!f&&!n)return plus.alert(kinggrid.msg("in_input_msg","KG_MSG"),function(){setTimeout(function(){e.focus()},100)}),!1;var r,l,s=h.keyData.seals[a.attr("index")].SealTag||h.keyData.seals[a.attr("index")].sealtag;if("client"==Signature.options.sealType&&s&&"GM"==s){var c=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode),t=h.keyData.seals[a.attr("index")].SealCert||h.keyData.seals[a.attr("index")].signercert,s=h.keyData.seals[a.attr("index")].ValidStart||h.keyData.seals[a.attr("index")].validstart,g=h.keyData.seals[a.attr("index")].ValidEnd||h.keyData.seals[a.attr("index")].validend,d=h.keyData.seals[a.attr("index")].CertList||h.keyData.seals[a.attr("index")].certlist;c.invoke("KGValidate_GM","",t,s,g,d,"").ret(function(e){if(!e.result)return h.errorCallback(e,u.errorCall,"KGValidate_GM"),!1;var t;null!=Signature.options.timestamp&&1==Signature.options.timestamp?(t=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode)).invoke("KGGetTSURLInfo").ret(function(e){e.result?t.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,h.getSignTimeStamp(h.getProtectedData(u.protectedItems)),"").ret(function(e){e.result?m.call(i,p.seals[a.attr("index")],n,a.attr("index"),e.TimeStr,e,!!o):(h.errorCallback(e,u.errorCall,"KGGetTSWithDigest"),m.call(i,p.seals[a.attr("index")],n,a.attr("index"),void 0,void 0,!!o))}):h.errorCallback(e,u.errorCall,"KGGetTSWithDigest")}):m.call(i,p.seals[a.attr("index")],n,a.attr("index"),void 0,void 0,!!o)})}else{if("client"!=Signature.options.sealType||!h.keyData.seals[a.attr("index")].sealtag||"GB"!=h.keyData.seals[a.attr("index")].sealtag)return a=i.find(".kg-wrapper .active"),i.isCheck=i.find("#kg-addDate").is(":checked"),l=h.getSignTimeStamp(h.getProtectedData(u.protectedItems)),null!=Signature.options.timestamp&&1==Signature.options.timestamp?"client"==Signature.options.sealType?(c=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode)).invoke("KGGetTSURLInfo").ret(function(e){e.result?c.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,l,"").ret(function(e){e.result?m.call(i,p.seals[a.attr("index")],n,a.attr("index"),e.TimeStr,e):(h.errorCallback(e,u.errorCall,"KGGetTSWithDigest"),m.call(i,p.seals[a.attr("index")],n,a.attr("index")))}):h.errorCallback(e,u.errorCall,"KGGetTSURLInfo")}):(t=Signature.options.serverUrl+"_key_getTimeStamp",$.ajax({url:t,type:"POST",data:{keysn:h.keyData.keysn,signTimeStamp:l},async:!1,success:function(e){var t;e.result?e.TimeStampResponse?(t=Utils.eosFormatTime(e.TimeStr),m.call(i,p.seals[a.attr("index")],n,a.attr("index"),t,e)):m.call(i,p.seals[a.attr("index")],n,a.attr("index"),e.timestamp):m.call(i,p.seals[a.attr("index")],n,a.attr("index"))},error:function(e){m.call(i,p.seals[a.attr("index")],n,a.attr("index"))}})):m.call(i,p.seals[a.attr("index")],n,a.attr("index")),!1;c=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode),s=(r=h.keyData.seals[a.attr("index")]).sesealinfo,c.invoke("KGVerifyGBSealAction",s,r.signsn).ret(function(e){if(!e.result)return h.errorCallback(e,u.errorCall,"KGVerifyGBSealAction"),!1;h.keyData.gbOvalue=e.ovalue,m.call(i,r,n,a.attr("index"),void 0,void 0,!!o)})}},content:function(){s.push(h.toBase64Img);var e=[Signature.options.template.showSealsBtl].concat(s);return(Signature.options.showNoPW||Signature.options.phoneshield)&&(e=[Signature.options.template.showSealsBtl_nopassword].concat(s)),Utils.template.apply(null,e)}};void 0!==r&&r&&(l=Utils.extend({onCancel:function(){void 0!==r&&r&&r.call(h),this.close()}},l)),Signature.options.showNoPW||Signature.options.phoneshield?h.showDialog("showSealsBtl_nopassword",l):h.showDialog("showSealsBtl",l),Signature.options.showSignExpirePrompt&&null!=p.currenttime&&null!=p.currenttime&&null!=p.overdate&&null!=p.overdate&&(l=new Date(p.currenttime),a=new Date(p.overdate),(a=Math.floor((a.getTime()-l.getTime())/864e5))<=p.hintdays&&0<=a&&(localStorage.getItem("lastAlertDate")&&null!=localStorage.getItem("lastAlertDate")&&""!=localStorage.getItem("lastAlertDate")?(o=localStorage.getItem("lastAlertDate"),o=new Date(o),0<l.getTime()-o.getTime()&&h.showExpirtDialog("当前用户还有"+a+"天过期，请及时更新！",p.currenttime)):h.showExpirtDialog("当前用户还有"+a+"天过期，请及时更新！",p.currenttime)))},showProtectedDataDialog:function(n,a,o){var t="protectedDataSetBtl",i=[{newProData:o.newProItems,proItemsCheckedAll:a.protectedItemsCheckedAll}],e={title:kinggrid.msg("ProtectedDataSet","KG_TITLE"),content:function(){i.push(Utils.html2Escape);var e=[Signature.options.template[t]].concat(i);return Utils.template.apply(null,e)},onShow:function(){Signature.editThemeColor()},onOk:function(){for(var i=o.newProItems.length;i--;)s.find("input[name='kg-proItem']").each(function(e,t){if(this.checked&&$(this).val()==o.newProItems[i].field)return!(o.newProItems[i].isChecked=!0);o.newProItems[i].isChecked=!1});var e=new Array;if(null!=a.protectedItemsType&&"1"==a.protectedItemsType)for(var t=0;t<o.newProItems.length;t++)o.newProItems[t].isChecked&&e.push(o.newProItems[t]);else for(t=0;t<o.newProItems.length;t++)o.newProItems[t].isChecked&&e.push(o.newProItems[t].field);n.proItems=e}},s=plus.showDialog(t,e);return s.find("#kg-proData-items").on("click",function(e){if("LABEL"==e.target.tagName&&s.find("#kg-selectedProData").text($(e.target).text().split("]")[1]),"checkbox"==e.target.type)if($(e.target).is(":checked")){for(var t=!0,i=s.find("input[name='kg-proItem']"),n=0;n<i.length;n++)if(!i[n].checked){t=!1;break}t&&(s.find("input[name='selectAll']")[0].checked=!0,a.protectedItemsCheckedAll=!0)}else s.find("input[name='selectAll']")[0].checked=!1,a.protectedItemsCheckedAll=!1}),s.find("#kg-selectBox").on("click",function(e){if($(e.target).is(":checked")){a.protectedItemsCheckedAll=!0;for(var t=s.find("input[name='kg-proItem']"),i=0;i<t.length;i++)t[i].checked=!0,o.newProItems[i].isChecked=!0}else{a.protectedItemsCheckedAll=!1;for(t=s.find("input[name='kg-proItem']"),i=0;i<t.length;i++)t[i].checked=!1,o.newProItems[i].isChecked=!1}}),s},showPostilFontDialog:function(e){plus.dafaultDate;var t=null==this.thirdConfig||null==this.thirdConfig.postilFontSet?{}:this.thirdConfig.postilFontSet,i=plus.defaultFont,n="fontSetBtl",a=(null==t.fontFamily?i:t).fontFamily,o=(null==t.fontSize?i:t).fontSize,i=i.fontColor,s=(null!=t.fontColor&&/^#([0-9a-fA-f]{6})$/.test(t.fontColor)&&(i=t.fontColor.toUpperCase()),null!=e.postilFontSet&&(a=e.postilFontSet.fontFamily,o=e.postilFontSet.fontSize,i=e.postilFontSet.fontColor),[{fontFamily:this.getArrayPush(Signature.options.fontTemplate.fontFamily,a),fontSize:this.getArrayPush(Signature.options.fontTemplate.fontSize,o),fontColor:this.getArrayPush(Signature.options.fontTemplate.fontColor,i),dFontFamily:a,dFontSize:o,dFontColor:i}]),t={title:$.kgi18n.prop("FontSetting"),content:function(){var e=[Signature.options.template[n]].concat(s);return Utils.template.apply(null,e)},onShow:function(){Signature.editThemeColor()},onOk:function(){e.postilFontSet={fontFamily:this.find("#kg-fontFamily").val(),fontSize:this.find("#kg-fontSize").val(),fontColor:kinggrid.Utils.colorHex(this.find("#kg-select-color").css("backgroundColor"))},e.find("#kg-postil-value").css("font-family",e.postilFontSet.fontFamily),e.find("#kg-postil-value").css("font-size",e.postilFontSet.fontSize+"px"),e.find("#kg-postil-value").css("color",e.postilFontSet.fontColor)}},r=plus.showDialog(n,t);return r.find("#kg-select-color").on("click",function(){r.find(".kg-color-div").css("display","block"),r.find("#kg-color-ul").css("display","block")}),r.find("#kg-color-ul li a").click(function(){$("#kg-select-color").css("backgroundColor",$(this).css("backgroundColor")),r.find(".kg-color-div").css("display","none"),r.find("#kg-color-ul").css("display","none")}),r.find(".kg-color-div").on("mouseover",function(e){e=e.fromElement||e.relatedTarget;this.contains(e)||$(this).show()}),r.find(".kg-color-div").on("mouseout",function(e){e=e.toElement||e.relatedTarget;this.contains(e)||$(this).hide()}),r},showFontDialog:function(i){var e=this,t=plus.dafaultDate,n=null==e.signdate?{}:e.signdate,a=plus.defaultFont,e=this,o="dateSetBtl",e=(null==n.fontFormat?a:n).fontFormat,s=(null==n.fontFamily?a:n).fontFamily,r=(null==n.fontSize?a:n).fontSize,l=a.fontColor,a=(null!=n.fontColor&&/^#([0-9a-fA-f]{6})$/.test(n.fontColor)&&(l=n.fontColor.toUpperCase()),(null==n.position?a:n).position),c=(null!=i.fontSel&&(e=i.fontSel.fontFormat,s=i.fontSel.fontFamily,r=i.fontSel.fontSize,l=i.fontSel.fontColor,a=plus.fontTemplate.position[i.fontSel.fontPositionIndex]),this.getArrayPush(Signature.options.fontTemplate.fontFormat,e)),g=[{fontFormat:this.getFormatDate(c,t),fontFamily:this.getArrayPush(Signature.options.fontTemplate.fontFamily,s),fontSize:this.getArrayPush(Signature.options.fontTemplate.fontSize,r),fontColor:this.getArrayPush(Signature.options.fontTemplate.fontColor,l),fontPosition:Signature.options.fontTemplate.position,dFontFormat:kinggrid.Utils.formatDate(new Date(t),e),dFontFamily:s,dFontSize:r,dFontColor:l,dFontPosition:a}],n={title:kinggrid.msg("DateSet","KG_TITLE"),content:function(){var e=[Signature.options.template[o]].concat(g);return Utils.template.apply(null,e)},onShow:function(){Signature.editThemeColor()},onOk:function(){var e=this,t=e.find("#kg-fontFormat").get(0).selectedIndex;i.fontSel={fontFormat:c[t],fontFamily:e.find("#kg-fontFamily").val(),fontSize:e.find("#kg-fontSize").val(),fontColor:kinggrid.Utils.colorHex(e.find("#kg-select-color").css("backgroundColor")),fontPositionIndex:e.find("#kg-fontPosition").get(0).selectedIndex}}},d=plus.showDialog(o,n);return d.find("#kg-select-color").on("click",function(){"block"==d.find(".kg-color-div").css("display")?(d.find(".kg-color-div").css("display","none"),d.find("#kg-color-ul").css("display","none")):(d.find(".kg-color-div").css("display","block"),d.find("#kg-color-ul").css("display","block"))}),d.find("#kg-color-ul li a").click(function(e){e.stopPropagation(),d.find("#kg-select-color").css("backgroundColor",$(this).css("backgroundColor")),d.find("#kg-select-color").css("borderColor",$(this).css("backgroundColor")),d.find(".kg-color-div").css("display","none"),d.find("#kg-color-ul").css("display","none")}),d.find(".kg-color-div").on("mouseover",function(e){e=e.fromElement||e.relatedTarget;this.contains(e)||$(this).show()}),d.find(".kg-color-div").on("mouseout",function(e){e=e.toElement||e.relatedTarget;this.contains(e)||$(this).hide()}),d},getArrayPush:function(e,t){return-1==jQuery.inArray(t,e)&&e.push(t),e},getFormatDate:function(e,t){for(var i=new Array,n=0;n<e.length;n++)i[n]=kinggrid.Utils.formatDate(new Date(t),e[n]);return i},genId:function(){return now()+rand()},getSeal:function(e){return this.keyData.seals[e]},saveSignature:function(e,t,i,n){var a,o,s=this;null!=e&&null!=t&&null!=i&&(o=Signature.options.clientCode||"",a=Signature.options.keysn,o=null!=Signature.options.cache_path&&null!=Signature.options.cache_path?{clientCode:o,keysn:a,documentId:e,signatureId:t,signaturedata:i,cachepath:Signature.options.cache_path}:{clientCode:o,keysn:a,documentId:e,signatureId:t,signaturedata:i,cachepath:""},kinggrid.surry(Signature.options.serverUrl).request("_signature_saveHtmlSignature",o).ret(function(e){null!=n&&n.call(s,e)}))},removeSignature:function(e,t,i){var n=this;null!=e&&null!=t&&(e={documentId:e,signatureId:t},kinggrid.surry(Signature.options.serverUrl).request("_signature_reomveHtmlSignature",e).ret(function(e){null!=i&&i.call(n,e)}))},getSaveSignatures:function(e,t,i){null!=e&&kinggrid.surry(Signature.options.serverUrl).request("_signature_getHtmlSignature",{documentId:e}).ret(function(e){Signature._verfiyInfotoServer=e.verfiyInfotoServer,e.result?t(e.sign):i&&i(e.result)})},showExpirtDialog:function(e,t){plus.showDialog("showExpirtDialog",{content:'<div class="kg-dialog kg-dialog-runSignature" id="sealExpirt-dialog"><div class="kg-dialog-content">'+e+'</div><div ><input type="checkbox" name="noMorePrompts" id="kg-noMorePrompts">&nbsp;<label for="kg-noMorePrompts">不再提示</label></div> </div>',onOk:function(){this.find("#kg-noMorePrompts").is(":checked")&&localStorage.setItem("lastAlertDate",t)},onCancel:function(){}})},getRPW:function(e){if(this.ongetRPW)return this.ongetRPW(e)}}),$.extend(Signature.options,{certType:"client",sealType:"client",clientUrl:"http://127.0.0.1:9581",moveable:!0,signable:!0,fontTemplate:plus.fontTemplate,template:{showSealsBtl:plus.template.sealTpl,showSealsBtl_nopassword:plus.template.sealTpl_noInput,signSignatureBtl:'<div id="kg-dialog-sign" class="kg-dialog kg-dialog-password kg-dialog-sign"><div class="kg-form"><div class="form-item clearfix"><% if(this.verification){%><label class="kg-sm kg-sm-3 kg-label" data-kgi18n-html="VerifyCode">验证码</label><div class="kg-sm kg-sm-7" style="position:relative"> <input type="password" style="text-indent:10px" name="kgpassword" autocomplete="new-password" id="kg-revokeVerifyCode" class="form-control"><span class="kg-verificationButton kg-revokeBtn kg-second-btn-red" style="width:70px;font-size:12px" title="获取短信验证码" data-kgi18n-title="SMSCodeTip" data-kgi18n-html="VerifyCode">验证码</span><span class="kg-tip" style="right:70px"></span><span class="kg-tipText"></span><span class="kg-verificationMark kg-revokeMark"/></div><%}else{%><label class="kg-sm kg-sm-3 kg-label" data-kgi18n-html="PassWord">密码</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div><%}%> </div></div></div>',protectedDataSetBtl:'<div id="kg-setProData" class="kg-dialog "><div id="kg-pro-data" class="kg-sm-13 kg-dialog-proData "><% var newProData = this.newProData; %><% var isAllChecked = this.proItemsCheckedAll; %><div id="kg-proData-items" class="kg-dialog-proData-items"><% for(var i=0;i<newProData.length;i++){%><div class="kg-dialog-proData-item"><% var proId = "proItem"+i; %><% var filedd = newProData[i].desc && newProData[i].desc != "" ? newProData[i].desc : newProData[i].field; %><% var content = "[" + filedd+"]" + arguments[0](newProData[i].value); %><% if(newProData[i].isChecked){ %><input type="checkbox" checked name="kg-proItem" id="<% proId%>" value="<% newProData[i].field%>" class="<%this.isMobile?"kg-dialog-checkbox ":"kg-primary-check-red kg-dialog-checkbox "%>">&nbsp;<label class="kg-dialog-label" custom="pro-value"><% content%></label>&nbsp;<% } %><% else{ isAllChecked = false; %><input type="checkbox" name="kg-proItem" id="<% proId%>" value="<% newProData[i].field%>" class="<%this.isMobile?"kg-dialog-checkbox ":"kg-primary-check-red kg-dialog-checkbox "%>">&nbsp;<label class="kg-dialog-label"  custom="pro-value"><% content%></label>&nbsp;<% } %></div><%}%></div><div class="kg-dialog-line"></div><div class="kg-dialog-proData-selProData"><label id="kg-selectedProData" class="kg-selProData"></label></div></div><div ><% if(isAllChecked){ %><input type="checkbox" checked  name="selectAll" id="kg-selectBox" class="<%this.isMobile?"kg-dialog-checkbox ":"kg-primary-check-red kg-dialog-checkbox "%>">&nbsp;<label class="kg-dialog-label" for="kg-selectBox" custom="pro-value" data-kgi18n-html="SelectAll">全部选中</label>&nbsp;<% } else{ %><input type="checkbox"  name="selectAll" id="kg-selectBox" class="<%this.isMobile?"kg-dialog-checkbox ":"kg-primary-check-red kg-dialog-checkbox "%>">&nbsp;<label class="kg-dialog-label" for="kg-selectBox" custom="pro-value" data-kgi18n-html="SelectAll">全部选中</label>&nbsp;<% } %></div></div>',dateSetBtl:'<div id="kg-setDate" class="kg-dialog kg-dialog-Date"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Format">格式</label><div class="kg-sm kg-sm-6"><select name="fontFormat" id="kg-fontFormat" class="kg-select kg-fontFormat"><% var fontFormat = this.fontFormat; %><% for(var i=0;i<fontFormat.length;i++) {%><% if(fontFormat[i] == this.dFontFormat){%><option class="kg-option" value="<% fontFormat[i]%>" selected><% fontFormat[i]%></option><%}else{%><option class="kg-option" value="<% fontFormat[i]%>"><% fontFormat[i]%></option><%}%><%}%></select></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Font">字体</label><div class="kg-sm kg-sm-6"><select name="fontFamily" id="kg-fontFamily" class="kg-select kg-fontFamily"><% var fontFamily = this.fontFamily; %><% for(var i=0;i<fontFamily.length;i++) {%><% if(fontFamily[i] == this.dFontFamily){%><option class="kg-option" value="<% fontFamily[i]%>" selected><% fontFamily[i]%></option><%}else{%><option class="kg-option" value="<% fontFamily[i]%>"><% fontFamily[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Size">尺寸</label><div class="kg-sm kg-sm-6"><select name="fontSize" id="kg-fontSize" class="kg-select kg-fontSize"><% var fontSize = this.fontSize; %><% for(var i=0;i<fontSize.length;i++) {%><% if(fontSize[i] == this.dFontSize){%><option class="kg-option" value="<% fontSize[i]%>" selected><% fontSize[i]%></option><%}else{%><option class="kg-option" value="<% fontSize[i]%>"><% fontSize[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Color">颜色</label><div class="kg-sm kg-sm-6"><% var fontColor = this.fontColor; %><div id="kg-select-color" class="kg-select-color" style="background-color:<% this.dFontColor%>"/><div class="kg-color-div"><ul class="kg-color-ul" id="kg-color-ul"><% for(var i=0;i<fontColor.length;i++){ %><li class="kg-color-li"><a href="javascript:;" style="background-color:<% fontColor[i]%>"></a></li><%}%></ul></div></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Location">位置</label><div class="kg-sm kg-sm-6"><select name="fontPosition" id="kg-fontPosition" class="kg-select kg-fontPosition"><% var fontPosition = this.fontPosition; %><% for(var i=0;i<fontPosition.length;i++) {%><% if(fontPosition[i] == this.dFontPosition){%><option class="kg-option" value="<% fontPosition[i]%>" selected ><% fontPosition[i]%></option><%}else{%><option class="kg-option" value="<% fontPosition[i]%>" ><% fontPosition[i]%></option><%}%><%}%></select></div> </div></div></div>',fontSetBtl:'<div id="kg-setFont" class="kg-dialog kg-dialog-font"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Font">字体：</label><div class="kg-sm kg-sm-6"><select name="fontFamily" id="kg-fontFamily" class="kg-select kg-fontFamily"><% var fontFamily = this.fontFamily; %><% for(var i=0;i<fontFamily.length;i++) {%><% if(fontFamily[i] == this.dFontFamily){%><option class="kg-option" value="<% fontFamily[i]%>" selected><% fontFamily[i]%></option><%}else{%><option class="kg-option" value="<% fontFamily[i]%>"><% fontFamily[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Size">尺寸：</label><div class="kg-sm kg-sm-6"><select name="fontSize" id="kg-fontSize" class="kg-select kg-fontSize"><% var fontSize = this.fontSize; %><% for(var i=0;i<fontSize.length;i++) {%><% if(fontSize[i] == this.dFontSize){%><option class="kg-option" value="<% fontSize[i]%>" selected><% fontSize[i]%></option><%}else{%><option class="kg-option" value="<% fontSize[i]%>"><% fontSize[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label kg-indent" data-kgi18n-html="Color">颜色：</label><div class="kg-sm kg-sm-6"><% var fontColor = this.fontColor; %><div id="kg-select-color" class="kg-select-color" style="background-color:<% this.dFontColor%>"/><div class="kg-color-div"><ul class="kg-color-ul" id="kg-color-ul"><% for(var i=0;i<fontColor.length;i++){ %><li class="kg-color-li"><a href="javascript:;" style="background-color:<% fontColor[i]%>"></a></li><%}%></ul></div></div></div></div></div>'}}),Signature.list={},Signature.updateList=[],Signature.removeList=[],Signature.loadSignature=function(e,t,i,n){var a={};null==Signature.options.extra&&(Signature.options.extra={}),a[e]=t,void 0!==a.extra&&null!==a.extra&&(Signature.options.extra[a.signatureid]=a.extra),formartSignatureData(a,i||function(e){Signature.verify()},n)},Signature.loadSignatures=function(e,t,i){var n={};if(null==Signature.options.extra&&(Signature.options.extra={}),Utils.is("Array",e))for(var a=0;a<e.length;a++){var o=e[a];n[o.signatureid]=o.signatureData,void 0!==o.extra&&null!==o.extra&&(Signature.options.extra[o.signatureid]=o.extra)}else for(var s in e){var r=e[s];n[s]=r}formartSignatureData(n,t||function(){Signature.verify()},i)},Signature.resetSignaturePos=function(e){if(null==Signature.options.extra&&(Signature.options.extra={}),Utils.is("Array",e))for(var t=0;t<e.length;t++){var i=e[t];void 0!==i.extra&&null!==i.extra&&(Signature.options.extra[i.signatureid]=i.extra)}else for(var n in e){var a=e[n];Signature.options.extra[n]=a}},Signature.clearRPW=function(){var e=Signature.create();e.onDeleteRPW&&e.onDeleteRPW()};var globalLisenter=new Listener("Signature"),ClientSeal=(Signature.addLiseter=function(e,t){globalLisenter.on(e,t)},Signature.verify=function(){var e,t=Signature.list,i=[];for(e in globalLisenter.trigger("beforeVerify",void 0),t){var n=t[e];n._verify(null,{batchVerify:!0})||i.push(n),globalLisenter.trigger("eachVerify",n)}return globalLisenter.trigger("verify",n),i},Signature._aesEncrypt=function(e){return CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(e),CryptoJS.enc.Utf8.parse(aseKey),{iv:CryptoJS.enc.Utf8.parse(aseIV),mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString()},Signature._getCookie=function(e){return getCookie(e)},Signature._showAndHideSealsDlg=function(e){Signature.options.showSealsDlg&&(Signature._getCookie("pwd")&&Signature._getCookie("SST")&&!Signature.options.remberPwdAndShowSealsDlg?Signature.options.showSealsDlg=!1:Signature.options.showSealsDlg=!0)},Signature.verifySignByList=function(e){var t,i=[];for(t in globalLisenter.trigger("beforeVerify",void 0),e){var n=e[t],a=n._verify(null,{batchVerify:!0}),o=n.signatureData,s=new Object;s.appname=o.appname,s.documentid=o.documentid,s.documentname=o.documentname,s.keysn=o.keysn,s.orgname=o.orgname,s.timestamp=o.timestamp,s.usercode=o.usercode,s.username=o.username,s.signname=o.seal.signname,s.signsn=o.seal.signsn,a||(s.modifiedItems=n.modifiedItems),i.push(s),globalLisenter.trigger("eachVerify",n)}return globalLisenter.trigger("verify",n),i},Signature.bind=function(e){Utils.extend(Signature.asyn,e)},Signature.loadProperties=function(){jQuery.kgi18n.properties({name:"language",path:Signature.options.languagesPath+"/lang/",mode:"map",language:Signature.options.LANGUAGE||jQuery.kgi18n.normaliseLanguageCode({}),cache:!1,encoding:"UTF-8",callback:function(){for(var e in kinggrid.errCode)if(Utils.is("Object",kinggrid.errCode[e]))for(var t in kinggrid.errCode[e])kinggrid.errCode[e][t]=$.kgi18n.prop(e+t);else kinggrid.errCode[e]=$.kgi18n.prop("errCode"+e);for(var e in plus.fontTemplate.position)plus.fontTemplate.position[e]=$.kgi18n.prop("position"+e);plus.dialogConfig.okValue=$.kgi18n.prop("Confirm"),plus.dialogConfig.cancelValue=$.kgi18n.prop("Close"),plus.defaultFont.position=$.kgi18n.prop("position0");for(var i=$(".kgImgIcons").find(".kg-img-icon"),n=0;n<i.length;n++){var a=$(i[n]).attr("id"),o=a.indexOf("-","kg-img-icon".length)+1,s=a.indexOf("-",o),a=a.substring(o,s);$(i[n]).attr("title",$.kgi18n.prop("Title"+a))}}})},Signature.dynamicLoadCss=function(e){for(var t=document.getElementsByTagName("head")[0],i=(t=root.iframeDialog?window.top.document.getElementsByTagName("head")[0]:t).getElementsByTagName("link"),n=0;n<i.length;n++)0<i[n].href.indexOf("/languages/")&&t.removeChild(i[n]);var a=document.createElement("link");a.type="text/css",a.rel="stylesheet",a.href=e,t.appendChild(a)},Signature.show=function(){var e,t=Signature.list;for(e in t)t[e].show()},Signature.hide=function(){var e,t=Signature.list;for(e in t)t[e].hide()},Signature.isIE=!!(window.ActiveXObject||"ActiveXObject"in window),Signature.setRequestHeader=function(e){if(!this.options.clientConfig){var t,i=this.options.RequestHeaderList;for(t in i)e.setRequestHeader(t,i[t])}},Signature.getAuthCode=function(t,i){window.OnecodeJSBridge?window.OnecodeJSBridge.call("getAuthCode",{},function(e){e.status?t(e.authCode):i(e.errorMsg)}):i("OnecodeJSBridge初始化失败, 请在码上办事小程序或者是APP中打开")},Signature.ScanStamp=function(e,s,r){var l,c,i,g,n,a,t,d,u,o,h,p,f,m,v,k,S,y,b,w=this,C="1",L="=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",x=[];function A(){k=document.getElementById("kg-exitSessionContainer"),S=document.getElementById("kg-exitSessionClick"),k.style.display="flex",S.addEventListener("click",G)}function G(){w.sealService.exitSession(Signature.userToken,function(e){e.result&&(Signature.userToken=usetToken=null,F(),E())})}function N(){m=document.getElementById("kg-companySelectContainer"),v=document.getElementById("kg-companySelect"),m.style.display="block",v.addEventListener("change",O),v.innerHTML="",h.forEach(function(e,t){var i=document.createElement("option");i.value=e.entityCode,i.innerText=e.entityName,v.appendChild(i)})}function O(e){D(e.target.value)}function _(){var e=Signature.userToken;w.sealService.queryUserCompany(e,function(e){var t=e.data.data,i=e.data.code,e=e.data.message;0==i?(t=Array.prototype.slice.call(t.companys),(h=t).length||h.push({entityName:"授权印章",entityCode:1}),D(h[0].entityCode)):6===i?(Signature.userToken=null,I(c,r)):Signature.alert(e)})}function D(e){var t={userToken:Signature.userToken};0==e?t.category=3:(t.entityCode=e,t.category=r,"delete"==c&&""==t.category&&(t.category=3)),w.sealService.getUserSeals(t.userToken,t.category,t.entityCode,function(e){var t,i=[],n=e.data.data,a=e.data.code,o=e.data.message;0==a?(t=n.userInfo,n=n.seals,d=t.userId,u=t.userName,"stamp"==c&&(0<n.length?(i=n.map(function(e){e.imgdata=e.imageData,delete e.imageData;var t=1/(720/254);return e.height=Utils.pxConversionMm(Math.round(.15*e.height/t)),e.width=Utils.pxConversionMm(Math.round(.15*e.width/t)),e.version=4,"1"==C&&(e.scanId=g),e.imgext=".png",e}),e={qrCodeUserUid:d,username:u,stampType:"scanStamp",sealData:i},E(),s(e)):1<h.length?D(h[0].entityCode):(Signature.alert("该用户没有可用印章！"),E())),"delete"==c&&w.sealService.getSealauthority(g,l,Signature.userToken,function(e){e.result?(g=null,s(e)):(E(),Signature.alert(e.errmsg))})):6===a?(Signature.userToken=null,I(c,r)):Signature.alert(o)})}function T(t){w.sealService.getQrCodeToken(function(e){o=e.stampSystemUrl+"/qr";e=Utils.Base64.of(L).decode(e.requestParameters);i=decodeURIComponent(e.split("&")[0]),n=decodeURIComponent(e.split("&")[1]),f="?token="+i+"&checkCode="+n,t&&t()})}function I(e,t){b.classList.add("hide"),w.sealService.getQRCodeImage(e,t,function(e){e.result?(1==(C=e.session?e.session:C)&&(Signature.userToken=null,a=e.image,y.src="data:image/png;base64,"+a,g=e.qrcodeId,T(B)),2==C&&(Signature.userToken?(a="data:image/png;base64,"+e.image,y.src=a,1==t?(Signature.scanCallBack=A,D()):(Signature.scanCallBack=function(){N(),A()},_())):Signature.options.isMobile?new Promise(function(e,t){Signature.getAuthCode(e,t)}).then(function(e){w.sealService.establishSession(e,function(e){var t=e.data.data,i=(e.data.code,e.message);e.result?(Signature.userToken=t.token,(1==r?D:_)()):Signature.alert(i)})}):(a="data:image/png;base64,"+e.image,y.src=a,g=e.qrcodeId,T(B)))):(b.classList.remove("hide"),g=null,w.errorCallback(e,Signature.options.errorCall))})}function B(){p=$.ajax({type:"get",url:o+"/user/get/"+g+f,timeout:75e3,success:function(e){var i,t,n;e?(i=e.data,t=e.code,e=e.message,0==t?(1==C&&(Signature.userToken=null,g=i.scanId,d=i.userInfo?i.userInfo.userId:void 0,u=i.userInfo?i.userInfo.userName:void 0,n=[],i.seals&&0<i.seals.length&&(n=i.seals.map(function(e){delete e.isGmSeal,delete e.isPersonal,e.imgdata=e.imageData,e.imgext=".png",e.qrcodeId=g,e.scanId=i.scanId,e.scanSealType=r,e.signname=e.sealName,e.sealData&&(e.sealTag="GM"),delete e.sealName,delete e.imageData;var t=1/(720/254);return e.height=Utils.pxConversionMm(Math.round(.15*e.height/t)),e.width=Utils.pxConversionMm(Math.round(.15*e.width/t)),e.version=4,e})),M({code:t,message:e,scanId:i.scanId,qrCodeUserUid:i.userInfo?i.userInfo.userId:void 0,qrCodeUserName:i.userInfo?i.userInfo.userName:void 0,seals:n,status:0==t})),2==C&&(Signature.userToken=i.userToken,(1==r?D:_)())):M({code:t,message:e})):b.classList.remove("hide")},error:function(){b.classList.remove("hide")}})}function M(e){1==e.status&&0==e.code?e.scanId&&e.qrCodeUserUid&&(e.scanId,d=e.qrCodeUserUid,u=e.qrCodeUserName,"stamp"==c&&(0<e.seals.length?(x=e.seals,E(),s({qrCodeUserUid:d,username:u,stampType:"scanStamp",sealData:x})):(E(),Signature.alert("该用户没有可用印章！"))),"delete"==c&&w.sealService.getSealauthority(g,l,Signature.userToken,function(e){e.result?(g=null,s(e)):(E(),Signature.alert(e.errmsg))})):801==e.code?setTimeout(function(){T(B)},3e3):802==e.code?b.classList.remove("hide"):803==e.code?E():Signature.alert(e.message)}function P(){p&&p.abort()}function E(){P(),t.close()}function U(){t.show()}function F(){x=[]}return t=e(),b=t.find("#kg-qrCodeImgForeground")[0],y=t.find("#kg-qrcodeImg")[0],t.find("#kg-qrCodeExpires")[0],t.find(".ui-dialog-close").click(P),U(),b.addEventListener("click",function(){I(c,r)}),{open:U,close:E,sealData:x,dialog:t,clearSealData:F,getQrCodeImageByStamp:function(){I(c="stamp",r)},getQrCodeImageByDelete:function(e){l=e,I(c="delete")}}},Signature.editThemeColor=function(e){if(Signature._color!=e)if(Signature._color=e||Signature._color,Signature.isIE)Signature._color&&i(["kg-primary-arrow-","kg-primary-btn-","kg-default-btn-","kg-second-btn-","kg-title-","kg-primary-check-"]);else{var t=Signature.options.themeColor[e];for(k in t)document.documentElement.style.setProperty("--"+k,t[k]);i(["kg-primary-check-"])}function i(e){for(var t="red"==Signature._color?"blue":"red",i=0;i<e.length;i++)for(var n=$("."+e[i]+t),a=0;a<n.length;a++)"red"==Signature._color?($(n[a]).toggleClass(e[i]+"red"),$(n[a]).toggleClass(e[i]+"blue")):"blue"==Signature._color&&($(n[a]).toggleClass(e[i]+"blue"),$(n[a]).toggleClass(e[i]+"red"))}},Signature.repairInputEvent=function(e){var t;/(iPhone|iPad|iPod|IOS)/i.test(navigator.userAgent)&&(t=$("body").width(),(e=$(e)).focus(function(){$("body").width("90%")}),e.blur(function(){setTimeout(function(){$("body").width(t)})}))},Signature._verfiyInfotoServer=!1,Signature.AXI=function(e,t,i){Signature.authcode=void 0;var n,a=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);for(n in t){var o=t[n];""!==n&&""!==o?a.invoke(e,n,o):null!==n&&""!==n?a.invoke(e,n):a.invoke(e)}return a.ret(function(t){t.result&&(Signature.options.moveable_self?(Signature.options.fjrsIsphone&&a.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),a.invoke("KGGetKeyOtherInfo","0").ret(function(e){e.result&&(e=e.Res.substring(1,e.Res.length-1),Signature.options.keysn=e),null!=i&&i(t)})):null!=i&&i(t))}),a},Signature.showAndHideBySignatureId=function(e,t){var i,n=Signature.list;for(i in n)0<=i.indexOf(e)&&(t?n[i].show():n[i].hide())},Signature.addIcon=function(e){var t=Signature.options.icons||[];t.push(e),Signature.options.icons=t},Signature.create=function(e){var t=$.extend({},Signature.options,e);return void 0!==e&&void 0!==e.imgtag&&(Signature.options.imgtag=e.imgtag),void 0!==e&&void 0!==e.password&&(Signature.options.password=e.password),new Signature._create(t)},$.extend(Signature.prototype,{saveSignatures:function(){},getSignatures:function(){}}),function(e){var i=this;$.each(e,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t})}),ClientCert=(Utils.inherit(ClientSeal,Signature.SealService),function(e){var i=this;$.each(e,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t})}),ServerSeal=(Utils.inherit(ClientCert,Signature.CertService),$.extend(ClientSeal.prototype,{saveLog:function(e){var t=[];Utils.is("Object",e)?t.push(e):t=e;e=stringify({MSG:t});Signature.options.savelogFlg&&kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode).invoke("SetParamByName","SAVEMSG",e)},loadSeal:function(c){var g=this,d=c.successCall,u=c.errorCall,e=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);g.appcode?e.invoke("SetParamByName","APPCODE",g.appcode):g.appcode="",void 0!==Signature.options.imgtag&&e.invoke("SetParamByName","SIGNTYPE",Signature.options.imgtag),Signature.options.fjrsIsphone&&e.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),e.invoke("KGGetKeyInfo").ret(function(e){if(e.result){if(Signature.options.fjrsIsphone&&localStorage.setItem("fjrsToken",e.fjrs_token),Signature.options.phoneshield=!(!e.phoneshield||"1"!=e.phoneshield&&"3"!=e.phoneshield),Signature.options.phoneshield&&(kinggrid.options.timeout=1e3*(e.validatetime+10)),""==e.seals){if(null==c.data)return void u.call(g,{result:!1,errcode:"11"});e.seals={};var t={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"};e.seals[0]=t}else{if(Signature.options.signname||Signature.options.signindex){Signature.options.signname=Utils.is("Array",Signature.options.signname)?Signature.options.signname:[Signature.options.signname];for(var i=new Array,n=0;n<e.seals.length;n++){void 0!==(s=e.seals[n])&&n==Signature.options.signindex&&i.push(e.seals[n]);for(var a=0,o=Signature.options.signname.length;a<o;a++)void 0!==s&&s.signname==Signature.options.signname[a]&&e.seals[Signature.options.signindex]!=s&&i.push(e.seals[n])}0==i.length?(e.result=!1,e.errcode="11101"):e.seals=i}for(n=0;n<e.seals.length;n++){var s,r=(s=e.seals[n]).imgdata.substring(0,65),l=s.imgdata.substring(65);e.seals[n].imgdata=Utils.Base64.of().encodeByte(Utils.Base64.of(r).decodeByte(l))}}c.isHW&&!e.seals.length&&(e.seals[0]=t={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"},Signature.options._clientHW=!0),d.call(g,e)}else u.call(g,e)})},verifyPwd:function(e){var t=this,i=e.pwd,n=e.phoneshield?"1":"0",a=e.successCall,o=(null==i&&(i=""),kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode));o.invoke("SetParamByName","ISPHONE",n),o.invoke("SetParamByName","FJRSISPHONE",e.phoneshield||"0"),n&&o.invoke("SetParamByName","FJRSDELKEYSN",e.keysn),o.invoke("KGVerifyPin",i,e.keysn).ret(function(e){a.call(t,e)})},getKeysn:function(e,i){var t=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode),n=e&&e.key?e.key:"0",a=Signature.options.getKeysnCallBack;Signature.options.fjrsIsphone&&(t.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),t.invoke("SetParamByName","FJRSTOKEN",localStorage.getItem("fjrsToken"))),t.invoke("KGGetKeyOtherInfo",n).ret(function(e){if(e.result){var t;"0"==n?(t=e.Res.substring(1,e.Res.length-1),i(t)):i(e)}else{if(a)return a(e.result,e.errcode);plus.alert(kinggrid.msg(e.errcode,"then"),function(){Signature.options.beginDlgOkCall&&Signature.options.beginDlgOkCall.call()},function(){Signature.options.beginDlgShowCall&&Signature.options.beginDlgShowCall.call()})}})},getPhoneShieldLic:function(e,t){var i=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);Signature.options.fjrsIsphone&&i.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),i.invoke("KGPhoneShieldLic").ret(function(e){t(e)})},checkKeysn:function(t,i){this.sealService.getKeysn({},function(e){t.keysn==e?i({result:!0}):i({result:!1,errcode:"11114"})})},getRemoveAuthority:function(e,t,i){i(!0)}}),$.extend(ClientCert.prototype,{verifySign:function(i){var n=this,a=i.successCall,o=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);i.seal&&i.seal.sealtag&&"GB"==i.seal.sealtag&&o.invoke("SetParamByName","GBSIGNSN",i.seal.signsn),Signature.options.fjrsIsphone&&o.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),o.invoke("SetParamByName","KEYSN",i.keysn),o.invoke("SetParamByName","SIGNSN",i.signsn),o.invoke("KGVerifySignMessage","123456",i.signdata,i.signeddata).ret(function(e){var t=e.result||"-8"!==e.errcode?e:{result:!1};t.result&&i.seal&&"GB"==i.seal.sealtag?o.invoke("KGVerifyGBStampAction",i.signeddata).ret(function(e){e.result||(t={result:!1}),a.call(n,t)}):a.call(n,t)}),i.seal&&i.seal.sealtag&&"GB"==i.seal.sealtag&&o.invoke("SetParamByName","GBSIGNSN","")},parseDate:function(e){var t=new Date;return t.setFullYear(e.substring(0,4),+e.substring(4,6)-1,e.substring(6,8)),t.setHours(e.substring(8,10),e.substring(10,12),e.substring(12,14),0),t.getTime()},sign:function(e){var t=this,i=e.successCall,n=e.signMeta,a=[],o=[],s=e.seal,r=e.phoneshield?"1":"0",l=e.password;null==l&&(l="");for(var c=0;c<n.length;c++){var g=n[c];a.push(g.signdata),o.push(""+g.signdata.length)}var d=kinggrid.surry(Signature.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",Signature.options.clientCode);d.invoke("SetParamByName","ISPHONE",r),s&&s.sealtag&&("GB"==s.sealtag&&(r=s.sesealinfo,d.invoke("SetParamByName","CLEARGBSESEALINFO",""),d.invoke("SetParamByName","GBSESEALINFO",r),d.invoke("SetParamByName","GBSIGNSN",s.signsn)),"GM"==s.sealtag&&d.invoke("SetParamByName","ISGM","1")),Signature.options.fjrsIsphone&&(d.invoke("SetParamByName","FJRSISPHONE",Signature.options.fjrsIsphone),d.invoke("SetParamByName","FJRSTOKEN",localStorage.getItem("fjrsToken"))),d.invoke("SetParamByName","KEYSN",e.keysn),d.invoke("SetParamByName","SIGNSN",e.signsn),d.invoke("KGCrySignMessage",l,a.join(";"),+o[0]).ret(function(e){e=$.extend({},e);e.result&&(e.certinfo.notAfter=t.parseDate(e.certinfo.notAfter),e.certinfo.notBefore=t.parseDate(e.certinfo.notBefore)),i.call(t,e)}),s&&s.sealtag&&"GB"==s.sealtag&&(d.invoke("SetParamByName","CLEARGBSESEALINFO",""),d.invoke("SetParamByName","GBSIGNSN",""))}}),Signature.addProvider("cert","client",ClientCert),Signature.addProvider("seal","client",ClientSeal),function(e,t){var i=this;i.sData=t,$.each(e,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t})}),ServerCert=(Utils.inherit(ServerSeal,Signature.SealService),function(e,t){var i=this;i.sData=t,$.each(e,function(e,t){"function"==typeof i[e]?i[e](t):i[e]=t})}),version=(Utils.inherit(ServerCert,Signature.CertService),$.extend(ServerSeal.prototype,{getSealsUrl:"_key_load",verifyInputUrl:"_key_verify",saveLogUrl:"_signature_saveLog",applySMSCodeUrl:"_sms_applySMSCode",checkSMSCodeUrl:"_sms_checkSMSCode",telphoneUrl:"_sms_telphone",getQRCodeUrl:"_scan_getQrCodeImage",sealAuthorityUrl:"_scan_sealAuthority",getQRCodeTokenUrl:"_scan_getQrCodeToken",queryUserCompanyUrl:"_scan_queryUserCompany",getUserSealsUrl:"_scan_getUserSeals",establishSessionUrl:"_scan_establishSession",exitSessionUrl:"_scan_exitSession",saveLog:function(e){e=stringify(e);Signature.options.savelogFlg&&kinggrid.surry(this.serverUrl).request(this.saveLogUrl,{loginfo:e}).ret(function(e){e.result||Signature.prototype.error.call(null,e)})},getPwdSaveTime:function(t,i){kinggrid.surry(Signature.options.serverUrl).request("_signature_getPwdSaveTime").ret(function(e){t(e.result?e.pwdTime:i)})},loadSeal:function(r){var l=this,c=r.successCall,g=r.errorCall,e=(l.clientUrl,l.getSealsUrl,{usercode:l.usercode,keysn:l.keysn,authcode:l.authcode,appcode:Signature.options.appcode,sealTag:Signature.options.sealTag,certContext:Signature.options.cert});r.type&&(e.type=r.type),kinggrid.surry(l.serverUrl).request(l.getSealsUrl,e).ret(function(e){if(e.result){if(void 0!==Signature.options.imgtag&&null!==Signature.options.imgtag){var t=new Array;e.seals.length;for(i in e.seals)void 0!==(n=e.seals[i])&&parseInt(n.imgtag)==Signature.options.imgtag&&(t[t.length]=e.seals[i]);e.seals=t}if(Signature.options.signname||Signature.options.signindex){Signature.options.signname=Utils.is("Array",Signature.options.signname)?Signature.options.signname:[Signature.options.signname];var i,n,t=new Array;for(i in e.seals){void 0!==(n=e.seals[i])&&i==Signature.options.signindex&&t.push(e.seals[i]);for(var a=0,o=Signature.options.signname.length;a<o;a++)void 0!==n&&n.signname==Signature.options.signname[a]&&e.seals[Signature.options.signindex]!=n&&t.push(e.seals[i])}0==t.length?(e.result=!1,e.errcode="11101"):e.seals=t}if(!e.seals.length){var s;if(!r.isHW)return s="11101",Signature.options.imgtag&&(s="11100"+Signature.options.imgtag),void g.call(l,{result:!1,errcode:s});e.seals=[],e.seals[0]={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"}}c.call(l,e)}else g.call(l,e)})},verifyPwd:function(e){var t,i=this,n=Signature.options.encryptPwd,a=Signature.options.pwdIsEncrypt&&!!Signature.options.password,o=n?Signature._aesEncrypt(e.pwd):e.pwd,s=e.successCall,r=kinggrid.surry(i.serverUrl);e.verify?(t={keysn:e.keysn,verifyCode:e.pwd},r.request(i.checkSMSCodeUrl,t).ret(function(e){s.call(i,e)})):(t={usercode:(null==i.sData?e:i.sData).usercode,keysn:(null==i.sData?e:i.sData).keysn,password:o,isEncrypt:n,pwdIsEncrypt:a},r.request(i.verifyInputUrl,t).ret(function(e){s.call(i,e)}))},applySMSCode:function(t){var e={keysn:t.keysn};kinggrid.surry(this.serverUrl).request(this.applySMSCodeUrl,e).ret(function(e){t.successCall&&t.successCall(e)})},getTelphone:function(t){var e={keysn:t.keysn};kinggrid.surry(this.serverUrl).request(this.telphoneUrl,e).ret(function(e){t.successCall&&t.successCall(e)})},checkKeysn:function(e,t){e.keysn==Signature.options.keysn||e.usercode==Signature.options.usercode?t({result:!0}):t({result:!1,errcode:"11115"})},getKeysn:function(e,t){t(Signature.options.keysn)},getQRCodeImage:function(e,t,i){var n={},a=kinggrid.surry(this.serverUrl);n.way={stamp:"1",delete:"2"}[e],n.scanSealType=t,a.request(this.getQRCodeUrl,n).ret(function(e){i(e)})},getSealauthority:function(e,t,i,n){e={scanId:e,esid:t,userToken:i};kinggrid.surry(this.serverUrl).request(this.sealAuthorityUrl,e).ret(function(e){n(e)})},getRemoveAuthority:function(e,t,i){Signature.options.clientConfig&&i(!0),t.seal.esid&&"scanStamp"!=t.stampType?(t={documentId:t.documentid,documentName:t.documentname,esid:t.seal.esid,signeddata:t.signMeta.signeddata},kinggrid.surry(Signature.options.serverUrl).request("_signature_authentication",t).ret(function(e){e.result?i(!0):(Signature.prototype.error.call(null,e),i(!1))})):i(!0)},getQrCodeToken:function(t){kinggrid.surry(this.serverUrl).request(this.getQRCodeTokenUrl).ret(function(e){t(e)})},queryUserCompany:function(e,t){kinggrid.surry(this.serverUrl).request(this.queryUserCompanyUrl,{userToken:e}).ret(function(e){t(e)})},getUserSeals:function(e,t,i,n){kinggrid.surry(this.serverUrl).request(this.getUserSealsUrl,{userToken:e,category:t,entityCode:i}).ret(function(e){n(e)})},establishSession:function(e,t){kinggrid.surry(this.serverUrl).request(this.establishSessionUrl,{authCode:e}).ret(function(e){t(e)})},exitSession:function(e,t){kinggrid.surry(this.serverUrl).request(this.exitSessionUrl,{userToken:e}).ret(function(e){t(e)})}}),$.extend(ServerCert.prototype,{signUrl:"_sign",verifySignUrl:"_sign_verify",verifySign:function(e){var t=this,i=t.sData,n=e.successCall,a=!!i.stampType,o=kinggrid.surry(t.serverUrl),a={certType:i.certType,isUTF8:i.isUTF8,signsn:i.seal.signsn,html2sign:i.signMeta.html2sign,keysn:i.keysn,isScan:a,signdata:e.signdata,signeddata:i.signMeta.signeddata,crtdata:i.signMeta.certinfo.crtdata,sealTag:i.seal.sealTag||i.seal.sealtag};o.request(t.verifySignUrl,a).ret(function(e){n.call(t,e)})},sign:function(e){var t,i=this,n=e.signMeta[0],a=e.successCall,o=e.seal.sealTag,s=("GM"!=o&&"SM2"!=Signature.options.certAlgorithm||(n.encryptAlg="SM2"),Signature.options.encryptPwd),r=Signature.options.pwdIsEncrypt&&!!Signature.options.password,l=s?Signature._aesEncrypt(e.password):e.password;t="scanStamp"===i.sData.stampType?(t=e.seal.sealData,{keysn:e.keysn,scanSealType:e.seal.scanSealType,scanId:e.seal.scanId,esid:e.seal.esid,documentId:e.documentid,documentName:e.documentname,signdata:n.signdata,signsn:e.signsn,encryptAlg:n.encryptAlg,scanStamp:!0,userToken:Signature.userToken,sealData:t}):Signature.options.verification?{keysn:e.keysn,signdata:n.signdata,encryptAlg:n.encryptAlg,signsn:e.signsn,sealTag:o}:{keysn:e.keysn,isEncrypt:s,pwdIsEncrypt:r,password:l,signsn:e.signsn,sealTag:o,encryptAlg:n.encryptAlg,signdata:n.signdata},e.seal.esid&&(t.esid=e.seal.esid,t.documentId=e.documentid,t.documentName=e.documentname),e.seal.seSeal&&(t.seSeal=e.seal.seSeal,t.version=e.seal.version),e.type&&(t.type=e.type),kinggrid.surry(i.serverUrl).request(i.signUrl,t).ret(function(e){e.result&&(e.certinfo.algName=e.certinfo.algName.replace("with","")),a.call(i,e)})}}),Signature.addProvider("cert","server",ServerCert),Signature.addProvider("seal","server",ServerSeal),Signature.alert=plus.alert,Signature.version={name:"1.0.20",code:100});function getLen(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function dot(e,t){return e.x*t.x+e.y*t.y}function getAngle(e,t){var i=getLen(e)*getLen(t);if(0==i)return 0;e=dot(e,t)/i;return 1<e&&(e=1),Math.acos(e)}function cross(e,t){return e.x*t.y-t.x*e.y}function getRotateAngle(e,t){var i=getAngle(e,t);return 0<cross(e,t)&&(i*=-1),180*i/Math.PI}root.Signature=Signature;var AlloyFinger=function(e,t){this.preV={x:null,y:null},this.pinchStartLen=null,this.scale=1,this.isDoubleTap=!1,this.rotate=t.rotate||function(){},this.pointStart=t.pointStart||function(){},this.multipointStart=t.multipointStart||function(){},this.multipointEnd=t.multipointEnd||function(){},this.pinch=t.pinch||function(){},this.swipe=t.swipe||function(){},this.tap=t.tap||function(){},this.doubleTap=t.doubleTap||function(){},this.longTap=t.longTap||function(){},this.singleTap=t.singleTap||function(){},this.pressMove=t.pressMove||function(){},this.delta=null,this.last=null,this.now=null,this.tapTimeout=null,this.touchTimeout=null,this.longTapTimeout=null,this.swipeTimeout=null,this.x1=this.x2=this.y1=this.y2=null,this.preTapPosition={x:null,y:null},e.addEventListener("touchstart",this.start.bind(this),!1),e.addEventListener("touchmove",this.move.bind(this),!1),e.addEventListener("touchend",this.end.bind(this),!1),e.addEventListener("touchcancel",this.cancel.bind(this),!1)},Utils=(AlloyFinger.prototype={start:function(e){var t,i;e.touches&&(this.now=Date.now(),this.x1=e.touches[0].pageX,this.y1=e.touches[0].pageY,this.delta=this.now-(this.last||this.now),this.pointStart(e),null!==this.preTapPosition.x&&(this.isDoubleTap=0<this.delta&&this.delta<=250&&Math.abs(this.preTapPosition.x-this.x1)<30&&Math.abs(this.preTapPosition.y-this.y1)<30),this.preTapPosition.x=this.x1,this.preTapPosition.y=this.y1,this.last=this.now,t=this.preV,1<e.touches.length&&(i={x:e.touches[1].pageX-this.x1,y:e.touches[1].pageY-this.y1},t.x=i.x,t.y=i.y,this.pinchStartLen=getLen(t),this.multipointStart(e)),this.longTapTimeout=setTimeout(function(){this.longTap(e)}.bind(this),750))},move:function(e){var t,i,n,a;e.touches&&(t=this.preV,a=e.touches.length,i=e.touches[0].pageX,n=e.touches[0].pageY,this.isDoubleTap=!1,1<a?(a={x:e.touches[1].pageX-i,y:e.touches[1].pageY-n},null!==t.x&&(0<this.pinchStartLen&&(e.scale=getLen(a)/this.pinchStartLen,this.pinch(e)),e.angle=getRotateAngle(a,t),this.rotate(e)),t.x=a.x,t.y=a.y):null!==this.x2&&(e.deltaX=i-this.x2,e.deltaY=n-this.y2,this.pressMove(e)),this._cancelLongTap(),this.x2=i,this.y2=n,e.preventDefault())},end:function(e){var t;e.changedTouches&&(this._cancelLongTap(),t=this,e.touches.length<2&&this.multipointEnd(e),this.x2&&30<Math.abs(this.x1-this.x2)||this.y2&&30<Math.abs(this.preV.y-this.y2)?(e.direction=this._swipeDirection(this.x1,this.x2,this.y1,this.y2),this.swipeTimeout=setTimeout(function(){t.swipe(e)},0)):this.tapTimeout=setTimeout(function(){t.isDoubleTap?(t.doubleTap(e),clearTimeout(t.touchTimeout),t.isDoubleTap=!1):t.touchTimeout=setTimeout(function(){t.singleTap(e)},250)},0),this.preV.x=0,this.preV.y=0,this.scale=1,this.pinchStartLen=null,this.x1=this.x2=this.y1=this.y2=null)},cancel:function(){clearTimeout(this.touchTimeout),clearInterval(this.tapTimeout),clearInterval(this.longTapTimeout),clearInterval(this.swipeTimeout)},_cancelLongTap:function(){clearTimeout(this.longTapTimeout)},_swipeDirection:function(e,t,i,n){return Math.abs(e-t)>=Math.abs(i-n)?0<e-t?"Left":"Right":0<i-n?"Up":"Down"}},kinggrid.Utils);Utils.extend(Signature.options.template,{infoBtl:'<div class="kg-dialog kg-dialog-info" id="kg-info"><%var autoCertMode = Signature.options.autoCertMode; %><%var modified = this.modified;%><%var timeVerify = this.timeVerify;%><%var tsaInfo = !!this.signatureData.signMeta?this.signatureData.signMeta.tsaInfo:0; %><%var canSign = this.signatureData.signMeta || this.canSign(); %><div class="kg-title success <%modified?"kg-hide":""%>" style="padding:0 0 15px 0"><i class="kg-icon"></i><div><span a="<%canSign%>" data-kgi18n-html="VerifyNormal">检测结果：保护数据正常！</span><%if(timeVerify!=null){%><span class="timestamp <%timeVerify==true?"green":"red"%>"><span data-kgi18n-html="<%timeVerify==true?"Trusted":"UnTrusted"%>"></span></span><%}%></div></div><div class="kg-title danger  <%modified?"":"kg-hide"%> "  style="padding:20px 0"><i class="kg-icon"></i><div><span data-kgi18n-html="VerifyTamper">检测结果：保护数据被篡改！</span><%if(timeVerify!=null){%><span class="timestamp <%timeVerify==true?"green":"red"%>"><span data-kgi18n-html="<%timeVerify==true?"Trusted":"UnTrusted"%>"></span></span><%}%></div></div><div class="kg-content"><div class="kg-tab"><ul class="kg-nav clearfix"><li class=" <% modified?"":"active"%> "><a href="#" class="kg-title-red" kg-target="signatureinfo" data-kgi18n-html="SignInfo">签章信息</a></li><%if(autoCertMode){%><%if(canSign){%><li class=""><a href="#" class="kg-title-red" kg-target="certinfo" data-kgi18n-html="CertInfo">证书信息</a></li><%if(!!tsaInfo){%><li class=""><a href="#" class="kg-title-red" kg-target="tsaInfo"  data-kgi18n-html="tStampInfo">时间戳信息</a></li><%}%><%}%><%}{%><%if(this.icon_sign == null || this.icon_sign == true){%><%if(canSign){%><li class="" ><a href="#" class="kg-title-red" kg-target="certinfo" data-kgi18n-html="CertInfo">证书信息</a></li><%if(!!tsaInfo){%><li class=""><a href="#" class="kg-title-red" kg-target="tsaInfo"  data-kgi18n-html="tStampInfo">时间戳信息</a></li><%}%><%}%><%}%><%}%></ul><div class="kg-tab-content"><div class="kg-tab-pane active signatureinfo"><% var SDATA = this.signatureData; %><% var modifiedItems = this.modifiedItems; %><% var scanStamp = this.signatureData.stampType;%><div class="kg-meta"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Application">应用程序：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.appname%></span></div><%if(SDATA.orgname){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="AuthorizedUnit">授权单位：</label><span class="kg-value  <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.orgname%></span></div><%}%><%if(SDATA.username){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="UserName">用户名称：</label><span class="kg-value  <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.username%></span></div><%}%><%if(SDATA.keysn){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="KeySequence">密钥序列：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.keysn%></span></div><%}%><%if(SDATA.esid){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" >esid</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.esid%></span></div><%}%><%if(SDATA.seal.signname){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureName">签章名称：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.seal.signname%></span></div><%}%><%if(SDATA.seal.signsn){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureSequence">签章序列：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%SDATA.seal.signsn%></span></div><%}%><%if(SDATA.timestamp.signtime){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureDate">签章日期：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%SDATA.timestamp.signtime%></span></div><%}%></div><%if(this.icon_remove == null || this.icon_remove == true){%><div><button type="button" id="revoke_<%this.signatureid%>" class="kg-button" i-id="revoke" data-kgi18n-html="RevokeSign" >撤销签章</button></div><%}%></div><%if(canSign){%><div class="kg-tab-pane certinfo"><%var noCertInfo = !this.signatureData.signMeta; %><%if(!noCertInfo){%><%var certinfo = this.signatureData.signMeta.certinfo; %><div class="kg-meta" style="padding-bottom:20px;"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Version">版本：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>">V<%certinfo.version%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SerialNumber">序号：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%certinfo.serialNumber%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureAlgorithm">签名算法：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%certinfo.algName%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Issuer">颁发者：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height: 17px;margin-top:5px;"><%certinfo.issuerDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="User">使用者：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height: 17px;margin-top:5px;"><%certinfo.subjectDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="ValidFrom">有效期从：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(new Date(certinfo.notBefore) , "yyyy-MM-dd hh:mm:ss")%></span><label  class="kg-to-sm">~</label><span class="<%this.Global%>-value mf-0 <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(new Date(certinfo.notAfter) , "yyyy-MM-dd hh:mm:ss")%></span></div></div><%}else{%><div class="kg-meta"><div class="clearfix kg-item kg-visble "><label class="kg-label"></label><span class="kg-value">----------------------------------------------------------------------------------------------------------------------</span></div><div class="clearfix kg-item kg-nosign">当前文档未做数字签名</div><div class="clearfix kg-item kg-visble"><label class="kg-label"></label><span class="kg-value">--------------------------------------------------------------------</span></div></div><%}%><%if(noCertInfo){%><div><button type="button" id="sign_<%this.signatureid%>" class="kg-button" data-kgi18n-html="DigitalSign">数字签名</button></div><%}else{%><%}%></div><%if(!!tsaInfo){%><div class="kg-tab-pane tsaInfo"><div class="kg-meta"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaTime">时间戳时间：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaTime%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSubject" >证书使用者：</label><span class="kg-value <%this.Global%>-value" <%this.isMobile?"mobile-value":""%>"> <%tsaInfo.tsaCert.subjectDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSerialNumber">证书序列号：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.serialNumber%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaIssuerDN">时间戳机构：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.issuerDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSigAlg">签名算法：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.oid%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="ValidFrom">有效期从：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(kinggrid.Utils.getDate(tsaInfo.tsaCert.startDate) , "yyyy-MM-dd hh:mm:ss")%></span><label  class="kg-to-sm">~</label><span class="<%this.Global%>-value mf-0 <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(kinggrid.Utils.getDate(tsaInfo.tsaCert.endDate) , "yyyy-MM-dd hh:mm:ss")%></span></div></div></div><%}%><%}%></div></div></div></div>',handwritedlg:'<div class="kg-dialog kg-dialog-info" id="kg-handwrite"><div class="kg-hw-content"><div class="kg-hw-info kg-hw-model"><span data-kgi18n-html="Model">模式</span><select id="hw_model" ><option value="0" <%this.mode == 0?"selected":""%> data-kgi18n-html="HWSignatrue" >手写签名</option><option value="1" <%this.mode == 1?"selected":""%> data-kgi18n-html="TextApproval">文字签批</option></select></div><div class="kg-hw-info kg-hw-name"><span data-kgi18n-html="Name">名称</span><input type="text" data-kgi18n-value="HWApproval" value="手写签批" id="nameid" style="margin-left:1px;width:76px;height:16px;"/></div><div class="kg-hw-info kg-hw-color"><span data-kgi18n-html="Color">颜色</span><select id="hw_color"><option value="black" data-kgi18n-html="KGfontColor黑">黑</option><option value="red" data-kgi18n-html="KGfontColor红">红</option><option value="blue" data-kgi18n-html="KGfontColor蓝">蓝</option><option value="green" data-kgi18n-html="KGfontColor绿">绿</option></select></div><div class="kg-hw-info kg-hw-linewidth kg-hw-handwrite"><span data-kgi18n-html="PenWidth">笔宽</span><select id="hw_width"><% for(var i=1;i<=8;i++) {%><option value="<%i%>"><%i%></option><%}%></select></div><div class="kg-hw-info kg-hw-fontFamily kg-hw-written"><span data-kgi18n-html="Font">字体</span><select id="hw_fontFamily"><% for(var i=0;i<this.fontFamily.length;i++) {%><option value="<%this.fontFamily[i].ename%>"><%this.fontFamily[i].zname%></option><%}%></select></div><div class="kg-hw-info kg-hw-fontSize kg-hw-written"><span data-kgi18n-html="FontSize">字号</span><select id="hw_fontSize"><% for(var i=16;i<=80;i+=4) {%><option value="<%i%>"<%i==this.fontSize?"selected":""%>><%i%></option><%}%></select></div></div><div class="kg-hw-canvas"><div id="kg-hw-tip">请手写签批</div><div id="kg-hw-span" class="kg-hw-written kg-hw-text-span"></div><textarea class="kg-hw-written kg-hw-text-edit" spellcheck="false"></textarea><canvas id="canvasId" style="position:relative" width=700px height=300px></canvas></div><div id="div-judge" class="kg-tab-content" align="center"><button type="button" id="clearid" class="kg-button" data-kgi18n-html="Clear">清除</button><button type="button" id="okid" class="kg-button" data-kgi18n-html="Sign">签名</button></div></div>',barcodedlg:'<div class="kg-dialog kg-dialog-info" id="kg-barcode"><label class="kg-label" data-kgi18n-html="QrCodeContent">二维码内容</label><textarea id="bcId" align="center" rows="3" cols="25"></textarea><br/><br/><div id="output"><br /></div><div id="div-judge" class="kg-tab-content"><button type="button" id="bc_clearid" class="kg-button" data-kgi18n-html="Clear">清除</button><button type="button" id="bc_okid" class="kg-button" data-kgi18n-html="Confirm">确认</button></div></div>',scanbarcodedlg:'<div class="kg-dialog kg-dialog-info" id="kg-scanBC"><div id="contentHolder" style="width:320px;height:320px; background:red;"><video id="html5_qrcode_video" height="320px" width="320px" autoplay></video><canvas id="qr-canvas" width="320px" height="320px" style="display:none;"></canvas> <br/></div></div>',scanStampdlg:'<div class="kg-dialog" id="kg-scanStampdlg"><div id="support"></div><div id="scanStampContent"><div id="kg-qrCodeImgForeground" class="hide" data-kgi18n-html="QrcodeInvalid">二维码已失效，点击刷新</div><img id="kg-qrcodeImg" width="320px" height="320px"/></div></div>'}),Signature._create.prototype.onshowSealsDialog=function(e){var t=this,e=(e.find(".arrow").hide(),e.find("#kg-switcher")),i={swipe:function(e){t.switcher["Left"===e.direction?"swipePrev":"swipeNext"]()},tap:function(){t.switcher.swipeNext()}};t.switcher.animate=!1,new AlloyFinger(e[0],i)},Signature.prototype.onhandleImg=function(t){var n=this,i=function(e){var t,i=n.verify();Signature._verfiyInfotoServer&&(n.signatureData,t=[],i=n._getLogInfo({LOGTYPE:"00",LOGSORT:"33",LOGMEMO:i?"文档验证成功":"文档验证失败"}),t.push(i),n.sealService.saveLog(t)),n.signatureInfo()},e=function(){if(void 0!==Signature.options.extra){var e=t.attributes.signatureid.nodeValue;if(e){e=Signature.options.extra[e];if(null!=e&&void 0!==e&&e.icon_move)return e.icon_move()}}}(),e=null==e||e;n.canMove(t)&&e?Utils.addEvent(t,"mousedown touchstart",function(e){e.originalEvent=e;n.runMove(e,t,function(e){e||i()});e.preventDefault(),e.stopPropagation()}):Signature.options.verifyResType?Utils.addEvent(t,Signature.options.verifyResType,i):Utils.addEvent(t,"click",i)},Signature.prototype.signatureInfo=function(){var i=this;return i.showDialog("infoBtl",{target:i,onShow:function(){var t=this,e=t.find(".kg-tab"),e=(t.tab=Utils.tab(e),t.find("#verifysign_"+i.signatureid)[0]),e=(e&&(e.onclick=function(){i.verifySignData(function(e){e.result?Signature.alert(kinggrid.msg("normal_signdata","KG_MSG")):e.errcode?i.error(e):Signature.alert(kinggrid.msg("modify_signdata","KG_MSG"))})}),t.find("#sign_"+i.signatureid)[0]);e&&(e.onclick=function(){i.signSignature(function(e){e.result&&(Signature.alert(kinggrid.msg("success_signdata","KG_MSG")),t.remove())})}),null!=i.icon_remove&&1!=i.icon_remove||(t.find("#revoke_"+i.signatureid)[0].onclick=function(){i.revokeSignature(function(e){e.result&&t.remove()})})}})};class Dlg{constructor(){}find(e){return document.querySelectorAll(e)}}function rotateBase64Img(e,t,i){var n,a,o,s=document.createElement("canvas"),r=s.getContext("2d");if(t%90!=0)throw console.error("旋转角度必须是90的倍数!"),"旋转角度必须是90的倍数!";var l=t/90%4,c={sx:0,sy:0,ex:0,ey:0},g=new Image;g.crossOrigin="anonymous",g.src=e,g.onload=function(){switch(n=g.width,a=g.height,o=a<n?n:a,s.width=2*o,s.height=2*o,l){case 0:c.sx=o,c.sy=o,c.ex=o+n,c.ey=o+a;break;case 1:c.sx=o-a,c.sy=o,c.ex=o,c.ey=o+n;break;case 2:c.sx=o-n,c.sy=o-a,c.ex=o,c.ey=o;break;case 3:c.sx=o,c.sy=o-n,c.ex=o+a,c.ey=o+n}r.translate(o,o),r.rotate(t*Math.PI/180),r.drawImage(g,0,0);var e=r.getImageData(c.sx,c.sy,c.ex,c.ey);l%2==0?(s.width=n,s.height=a):(s.width=a,s.height=n),r.putImageData(e,0,0),i&&i(s.toDataURL())}}class KG_Mobile_Pad{constructor(e,t){this.createPad=this.createPad.bind(this),this.createPad(),this.container=document.getElementById("hwm-container"),this.canvas=document.getElementById("hwm-canvas"),this.times=1;var i=new Dlg,i=(i[0]={},Object.assign(i[0],e),i.options={},Object.assign(i.options,e),{dlg:i,toolBarHeight:0,notYTop:!0});Object.assign(i,e),this.painting=new Painting("hwm-canvas",i),this.isSign=!1,this.initCanvas=this.initCanvas.bind(this),this.initCanvas(i),this.touchStart=this.touchStart.bind(this),this.touchEnd=this.touchEnd.bind(this),this.painting.touchendCallback=this.touchEnd,this.painting.touchmoveCallback=this.touchStart,this.context=this.canvas.getContext("2d"),this.applyBtn=document.getElementById("hwm-sign"),this.cancelBtn=document.getElementById("hwm-cancel"),this.cancelBtn.onclick=this.close.bind(this),this.clearBtn=document.getElementById("hwm-clear"),this.clearBtn.onclick=this.clear.bind(this),this.blackBtn=document.getElementById("hwm-color-black"),this.blackBtn.onclick=this.setColor.bind(this),this.greenBtn=document.getElementById("hwm-color-green"),this.greenBtn.onclick=this.setColor.bind(this),this.blueBtn=document.getElementById("hwm-color-blue"),this.blueBtn.onclick=this.setColor.bind(this),this.redBtn=document.getElementById("hwm-color-red"),this.redBtn.onclick=this.setColor.bind(this),this.show=this.show.bind(this),this.ticksBtn=document.getElementById("hwm-tick"),this.tickList=document.getElementById("hwm-ticks-list"),this.tickList.ontouchmove=this.ignoreTouchMove,this.tickList.onmousemove=this.ignoreTouchMove,this.showTick=this.showTick.bind(this),this.hideTick=this.hideTick.bind(this),this.tickBtnClick=this.tickBtnClick.bind(this),this.painting.touchstartCallback=this.hideTick,this.ticksBtn.onclick=this.tickBtnClick,this.changeSize=this.changeSize.bind(this);document.querySelectorAll("div[data-type]").forEach(e=>{e.addEventListener("click",this.changeSize),e.addEventListener("touch",this.changeSize)}),this.lineMax=i.lineMax||4,this.painting.setLineMax(this.lineMax),this.lineMin=i.lineMin||.5,this.painting.setLineMin(this.lineMin),this.smoothness=i.smoothness||100,this.painting.setSmoothness(this.smoothness);e=i.fontColor||"red",this[e+"Btn"].click(),e=i.lineSize||"5";this.painting.setLineSize(e),document.getElementById("size-radiu-"+e).classList.add("size-selected"),this.toDataURL=this.toDataURL.bind(this),this.applyBtn.onclick=t}createPad(){if(!document.getElementById("hwm-container")){var n=document.createElement("div"),e=(n.classList.add("KG_OverlayContainer","hidden"),n.setAttribute("id","hwm-container"),window.screen.width),t=window.screen.height,i=document.createElement("canvas"),e=(i.setAttribute("id","hwm-canvas"),i.width=e,i.height=t,i.style.width=e+"px",i.style.height=t+"px",i.style.position="relative",n.appendChild(i),document.createElement("div")),t=(e.setAttribute("id","hwm-tick"),e.classList.add("tick-btn"),n.appendChild(e),document.createElement("div")),a=(t.setAttribute("id","hwm-ticks-list"),t.classList.add("ticks-list"),document.createElement("div")),i=document.createElement("div");a.classList.add("tick-column"),i.classList.add("tick-column");for(var o=1;o<=8;o++){var s=document.createElement("div"),r=document.createElement("div");r.dataset.type="sizeBtn",r.setAttribute("id","size-"+o),r.dataset.size=o,r.classList.add("size-container"),s.dataset.size=o,s.setAttribute("id","size-radiu-"+o),s.dataset.type="sizeRadiu",s.classList.add("size-btn"),r.appendChild(s),a.appendChild(r)}t.appendChild(a);e=document.createElement("span"),i=(e.classList.add("tick-title"),e.innerHTML="请选择线宽",i.appendChild(e),n.appendChild(t),["red","blue","green","black"].forEach(function(e,t){var i=document.createElement("div");i.classList.add("color-btn"),i.setAttribute("id","hwm-color-"+e),i.setAttribute("data-color",""+e),i.style.top=114+50*t+"px",i.style.backgroundColor=e,0===t&&i.classList.add("selected"),n.appendChild(i)}),document.createElement("div")),e=(i.setAttribute("id","hwm-clear"),i.classList.add("clear-btn"),n.appendChild(i),document.createElement("div")),t=(e.setAttribute("id","hwm-cancel"),e.classList.add("cancel-btn"),n.appendChild(e),document.createElement("div"));t.setAttribute("id","hwm-sign"),t.classList.add("sign-btn","hidden"),n.appendChild(t),document.body.appendChild(n)}}initCanvas(e){var t=e.canvas_width,e=e.canvas_height;this.painting.init(t,e,t*this.times,e*this.times),this.canvas.getContext("2d").fillStyle="rgba(0,0,0,0)"}touchStart(){this.isSign=!0,this.applyBtn.classList.remove("hidden"),this.hideTick()}touchEnd(){this.isSign=!1}init(e){}changeSize(e){e.preventDefault(),e.stopPropagation();var e=e.target,t=e.getAttribute("data-size");"sizeBtn"===e.getAttribute("data-type")?(e.parentNode.parentNode.querySelector('div[data-size][class="size-btn size-selected"]').classList.remove("size-selected"),e.firstChild.classList.add("size-selected"),this.painting.setLineSize(t)):"sizeRadiu"===e.getAttribute("data-type")&&(e.parentNode.parentNode.querySelector('div[data-size][class="size-btn size-selected"]').classList.remove("size-selected"),e.classList.add("size-selected"),this.painting.setLineSize(t))}ignoreTouchMove(e){e.preventDefault(),e.stopPropagation()}setColor(e){e.preventDefault(),e.stopPropagation(),this.hideTick();var e=e.target,t=e.getAttribute("data-color");e.parentNode.querySelector('div[data-color][class="color-btn selected"]').classList.remove("selected"),e.classList.add("selected"),this.painting.setLineColor(t)}hide(){this.container.classList.add("hidden")}show(){this.container.classList.remove("hidden")}clear(e){e&&(e.preventDefault(),e.stopPropagation()),this.painting.clearCanvasAndData(),this.isSign=!1,this.hideTick(),this.applyBtn.classList.add("hidden")}close(e){this.redBtn.click(),this.clear(),this.hide(),this.container.parentElement.removeChild(this.container)}tickBtnClick(){1!==this.tickList.classList.length?this.hideTick():this.showTick()}showTick(){this.tickList.classList.add("show-list")}hideTick(){this.tickList.classList.remove("show-list")}toDataURL(i,e){this.hideTick();for(var t=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height),n=t.data,a=t.width,o=0,s=t.height,r=0,l=0;l<this.canvas.width;l++)for(var c=0;c<t.height;c++){var g=4*(l+t.width*c);(0<n[g]||0<n[1+g]||n[2+g]||0<n[3+g])&&(r=Math.max(c,r),o=Math.max(l,o),s=Math.min(c,s),a=Math.min(l,a))}a++,o++,s++,r++;var d=this.painting.saveImage(),u=new Image;u.src=d,u.onload=function(){var e=document.createElement("canvas");e.width=o-a,e.height=r-s;e.getContext("2d").drawImage(u,a,s,e.width,e.height,0,0,e.width,e.height);var t={};t.imageData=e.toDataURL(),t.width=e.width,t.height=e.height,i(t)}}}function getsec(e){var t=+e.substring(1,e.length),e=e.substring(0,1);return"s"==e?1e3*t:"h"==e?60*t*60*1e3:"d"==e?24*t*60*60*1e3:void 0}Signature.prototype.handWriteMobile=function(l,c){l.canvas_height=window.screen.height,l.canvas_width=window.screen.width,l.noCutting=!0,l.needResizeImage=!0;var g=l.canvas_height,d=l.canvas_width,u=Number(l.image_width)||8,h=Number(l.image_height)||8;Signature.create({}).sealService.getKeysn({},function(e){0;var r=new KG_Mobile_Pad(l,function(){Signature.hideToolBar=null,r.toDataURL(function(s){Utils.rotateBase64Img(s.imageData,270,e=>{s.imageData=e,r.hide();l.canvas_height,l.canvas_width;var e=s.imageData,o=new Image;o.onload=function(){g=s.height,d=s.width,g>window.screen.width?((t=document.createElement("canvas")).width=window.screen.width,t.height=window.screen.width*d/g,t.getContext("2d").drawImage(o,0,0,t.width,t.height),e=t.toDataURL(),g=t.width,d=t.height):(t=o,a=g,n=d,(i=document.createElement("canvas")).width=a,i.height=n,i.getContext("2d").drawImage(t,0,0,t.width,t.height),e=i.toDataURL()),s.imageData=e.replace(/^data:image\/\w+;base64,/,""),s.name=l.name||"",s.width=Utils.pxConversionMm(g/10),s.height=Utils.pxConversionMm(d/10);var e,t,i,n,a=s.width/s.height;n=s,parseFloat(n.width)>parseFloat(n.height)?(s.width,s.width=u,s.height=s.width/a):(s.height,s.height=h,s.width=s.height*a),c(s),r.close()},o.src=e})},{mode:0,noCutting:l.noCutting,display_width:l.canvas_width,display_height:l.canvas_height})});r.show()})},Signature.prototype.handWriteDlg=function(d,u){var h,p=this,f=0,m=0,e=Signature.create({}),v=!1,k=Number(d.image_width)||8,S=Number(d.image_height)||8,y=JSON.parse(localStorage.getItem("kg-hw-fontSize"))||Object.create(null),b=d.canvas_width,w=d.canvas_height,f=Math.max(parseInt(d.canvas_width),300)-30,m=parseInt(d.canvas_height);p.mode=d.mode||0,e.sealService.getKeysn({},function(e){y[h=e]?p.fontSize=y[h]:p.fontSize=d.fontSize||"20",p.fontFamily=plus.fontFamily,Utils.extend(d,{title:kinggrid.msg("HWSignature","KG_TITLE"),target:p,onCancel:function(){$("#nameid").blur()}});var i,s=p.showDialog("handwritedlg",d),e=(Signature.repairInputEvent($("#nameid")),s.find("#canvasId")[0]),n=(f<screen.availWidth&&540<screen.availWidth?(e.width=f,e.height=m):screen.availWidth>screen.availHeight?700<screen.availWidth?(e.width=f=670,m=e.height=.9*(screen.availHeight-210),d.noCutting&&(v=!0,e.width=f=screen.availWidth-30,e.height=m=d.canvas_height)):(e.width=.95*screen.availWidth,m=e.height=.9*(screen.availHeight-210)):d.noCutting&&d.canvas_width&&d.canvas_height&&d.canvas_width<screen.availWidth?(e.width=f=d.canvas_width,e.height=m=d.canvas_height):(d.noCutting&&(v=!0,e.height=m=d.canvas_height),f=e.width=.83*(screen.availWidth-190)+190),d.dlg=s,d.canvas_height=e.height,d.canvas_width=e.width,d.hideToolBar&&(d.canvas_height+=$(".kg-hw-content").height(),Signature.hideToolBar=d.hideToolBar),s.find(".kg-hw-text-span").css({height:e.height,width:e.width})),a=s.find(".kg-hw-text-edit").css({height:e.height,width:e.width}),t=(s.find(".kg-hw-content").width(f),$(".kg-dialog-info").width("auto"),s.find("#hw_width").val(d.lineSize||5),s[0].reset(),d.toolBarHeight=$(".kg-hw-content").height(),new SignaturePad(e,d));if(d.fontColor)if(0==d.fontColor.indexOf("#"))s.find("#hw_color").val(d.fontColor),t.setColor(d.fontColor),n.css({color:d.fontColor}),a.css({color:d.fontColor});else for(var o=["black","red","blue","green"],r=0;r<4;r++)if(o[r]==d.fontColor){s.find("#hw_color").val(d.fontColor),t.setColor(d.fontColor),n.css({color:d.fontColor}),a.css({color:d.fontColor});break}function l(e){"0"==e?(p.mode=0,s.find(".kg-hw-written").css({display:"none"}),s.find(".kg-hw-handwrite").css({display:"block"}),s.find("#kg-hw-tip").css({display:"inline-block"}),t.setWebHandWrite(i,{fontStyle:"normal",fontSize:n.css("font-size"),fontFamily:n.css("font-family"),fontColor:n.css("color")}),i=new Array,n.html(""),a.val("")):"1"==e&&(p.mode=1,s.find(".kg-hw-handwrite").css({display:"none"}),s.find(".kg-hw-written").css({display:"block"}),s.find("#kg-hw-tip").css({display:"none"}))}function c(e){n.css({"font-size":e+"px","line-height":6+1.2*e+"px"}),a.css({"font-size":e+"px","line-height":6+1.2*e+"px"}).attr("rows",1)}d.buttonText&&s.find("#okid").html(d.buttonText),d.hideToolBar&&s.find(".kg-hw-content").css("display","none"),s.find("#hw_color").change(function(){var e=s.find("#hw_color").val();t.setColor(e),n.css({color:e}),a.css({color:e})}),s.find("#hw_width").change(function(){var e=s.find("#hw_width").val();t.setSize(e)}),s.find("#hw_model").change(function(e){l(e.target.value)}),a.keyup(function(e){var t=Utils.convertText(this.value);parseFloat(a.css("line-height"))*t.split("<br>").length>parseFloat(a.css("height"))?console.warn("文字超过限制"):n.html(t),i=Utils.handleEdittable(n,t)}),s.find("#hw_fontFamily").change(function(e){n.css({"font-family":this.value}),a.css({"font-family":this.value})}),c(p.fontSize),s.find("#hw_fontSize").change(function(e){c(this.value),i=Utils.handleEdittable(n,n.html()),y[h]=this.value,localStorage.setItem("kg-hw-fontSize",JSON.stringify(y))});var e=s.find("#clearid"),g=s.find("#okid"),e=(e&&e.click(function(){i=new Array,n.html(""),a.val(""),t.clear()}),g&&g.click(function(){s.close(),Signature.hideToolBar=null,t.setWebHandWrite(i,{fontStyle:"normal",fontSize:n.css("font-size"),fontFamily:n.css("font-family"),fontColor:n.css("color")}),t.toDataURL(function(a){var e,o,t=d.canvas_height/d.canvas_width,i=a.imageData;v?((o=new Image).onload=function(){e=o,n=b,t=w,(i=document.createElement("canvas")).width=n,i.height=t,i.getContext("2d").drawImage(e,0,0,e.width,e.height);var e,t,i,n=i.toDataURL();a.imageData=n.replace(/^data:image\/\w+;base64,/,""),a.name=d.name||s.find("#nameid").val(),a.width=Utils.pxConversionMm(b/10),a.height=Utils.pxConversionMm(w/10),u(a),s.remove()},o.src=i):(a.imageData=a.imageData.replace(/^data:image\/\w+;base64,/,""),a.name=d.name||s.find("#nameid").val(),a.height=Utils.pxConversionMm(a.height)/d.canvas_height,a.width=Utils.pxConversionMm(a.width)/d.canvas_width,d.noCutting?(a.width=Utils.pxConversionMm(d.canvas_width/10),a.height=Utils.pxConversionMm(d.canvas_height/10)):(a.height=Utils.pxConversionMm(a.height)/d.canvas_height,a.width=Utils.pxConversionMm(a.width)/d.canvas_width,i=a,parseFloat(i.width)>parseFloat(i.height)?(e=k/a.width,a.width=k,a.height=a.height*e*t):(e=S/a.height,a.height=S,a.width=a.width*e/t)),u(a),s.remove())},{mode:p.mode,noCutting:d.noCutting,display_width:d.canvas_width,display_height:d.canvas_height})}),l(p.mode),(d.canvas_width-144)/2),g=(d.canvas_height-58)/2+25;s.find("#kg-hw-tip").css({left:e+"px",top:g+"px"})})},Signature.prototype.handWriteDlg=function(d,u){var h,p=this,f=0,m=0,e=Signature.create({}),v=!1,k=Number(d.image_width)||8,S=Number(d.image_height)||8,y=JSON.parse(localStorage.getItem("kg-hw-fontSize"))||Object.create(null),b=d.canvas_width,w=d.canvas_height,f=Math.max(parseInt(d.canvas_width),300)-30,m=parseInt(d.canvas_height);p.mode=d.mode||0,e.sealService.getKeysn({},function(e){y[h=e]?p.fontSize=y[h]:p.fontSize=d.fontSize||"20",p.fontFamily=plus.fontFamily,Utils.extend(d,{title:kinggrid.msg("HWSignature","KG_TITLE"),target:p,onCancel:function(){$("#nameid").blur()}});var i,s=p.showDialog("handwritedlg",d),e=(Signature.repairInputEvent($("#nameid")),s.find("#canvasId")[0]),n=(f<screen.availWidth&&540<screen.availWidth?(e.width=f,e.height=m):screen.availWidth>screen.availHeight?700<screen.availWidth?(e.width=f=670,m=e.height=.9*(screen.availHeight-210),d.noCutting&&(v=!0,e.width=f=screen.availWidth-30,e.height=m=d.canvas_height)):(e.width=.95*screen.availWidth,m=e.height=.9*(screen.availHeight-210)):d.noCutting&&d.canvas_width&&d.canvas_height&&d.canvas_width<screen.availWidth?(e.width=f=d.canvas_width,e.height=m=d.canvas_height):(d.noCutting&&(v=!0,e.height=m=d.canvas_height),f=e.width=.83*(screen.availWidth-190)+190),d.dlg=s,d.canvas_height=e.height,d.canvas_width=e.width,d.hideToolBar&&(d.canvas_height+=$(".kg-hw-content").height(),Signature.hideToolBar=d.hideToolBar),s.find(".kg-hw-text-span").css({height:e.height,width:e.width})),a=s.find(".kg-hw-text-edit").css({height:e.height,width:e.width}),t=(s.find(".kg-hw-content").width(f),$(".kg-dialog-info").width("auto"),s.find("#hw_width").val(d.lineSize||5),s[0].reset(),d.toolBarHeight=$(".kg-hw-content").height(),new SignaturePad(e,d));if(d.fontColor)if(0==d.fontColor.indexOf("#"))s.find("#hw_color").val(d.fontColor),t.setColor(d.fontColor),n.css({color:d.fontColor}),a.css({color:d.fontColor});else for(var o=["black","red","blue","green"],r=0;r<4;r++)if(o[r]==d.fontColor){s.find("#hw_color").val(d.fontColor),t.setColor(d.fontColor),n.css({color:d.fontColor}),a.css({color:d.fontColor});break}function l(e){"0"==e?(p.mode=0,s.find(".kg-hw-written").css({display:"none"}),s.find(".kg-hw-handwrite").css({display:"block"}),s.find("#kg-hw-tip").css({display:"inline-block"}),t.setWebHandWrite(i,{fontStyle:"normal",fontSize:n.css("font-size"),fontFamily:n.css("font-family"),fontColor:n.css("color")}),i=new Array,n.html(""),a.val("")):"1"==e&&(p.mode=1,s.find(".kg-hw-handwrite").css({display:"none"}),s.find(".kg-hw-written").css({display:"block"}),s.find("#kg-hw-tip").css({display:"none"}))}function c(e){n.css({"font-size":e+"px","line-height":6+1.2*e+"px"}),a.css({"font-size":e+"px","line-height":6+1.2*e+"px"}).attr("rows",1)}d.buttonText&&s.find("#okid").html(d.buttonText),d.hideToolBar&&s.find(".kg-hw-content").css("display","none"),s.find("#hw_color").change(function(){var e=s.find("#hw_color").val();t.setColor(e),n.css({color:e}),a.css({color:e})}),s.find("#hw_width").change(function(){var e=s.find("#hw_width").val();t.setSize(e)}),s.find("#hw_model").change(function(e){l(e.target.value)}),a.keyup(function(e){var t=Utils.convertText(this.value);parseFloat(a.css("line-height"))*t.split("<br>").length>parseFloat(a.css("height"))?console.warn("文字超过限制"):n.html(t),i=Utils.handleEdittable(n,t)}),s.find("#hw_fontFamily").change(function(e){n.css({"font-family":this.value}),a.css({"font-family":this.value})}),c(p.fontSize),s.find("#hw_fontSize").change(function(e){c(this.value),i=Utils.handleEdittable(n,n.html()),y[h]=this.value,localStorage.setItem("kg-hw-fontSize",JSON.stringify(y))});var e=s.find("#clearid"),g=s.find("#okid"),e=(e&&e.click(function(){i=new Array,n.html(""),a.val(""),t.clear()}),g&&g.click(function(){s.close(),Signature.hideToolBar=null,t.setWebHandWrite(i,{fontStyle:"normal",fontSize:n.css("font-size"),fontFamily:n.css("font-family"),fontColor:n.css("color")}),t.toDataURL(function(a){var e,o,t=d.canvas_height/d.canvas_width,i=a.imageData;v?((o=new Image).onload=function(){e=o,n=b,t=w,(i=document.createElement("canvas")).width=n,i.height=t,i.getContext("2d").drawImage(e,0,0,e.width,e.height);var e,t,i,n=i.toDataURL();a.imageData=n.replace(/^data:image\/\w+;base64,/,""),a.name=d.name||s.find("#nameid").val(),a.width=Utils.pxConversionMm(b/10),a.height=Utils.pxConversionMm(w/10),u(a),s.remove()},o.src=i):(a.imageData=a.imageData.replace(/^data:image\/\w+;base64,/,""),a.name=d.name||s.find("#nameid").val(),a.height=Utils.pxConversionMm(a.height)/d.canvas_height,a.width=Utils.pxConversionMm(a.width)/d.canvas_width,d.noCutting?(a.width=Utils.pxConversionMm(d.canvas_width/10),a.height=Utils.pxConversionMm(d.canvas_height/10)):(a.height=Utils.pxConversionMm(a.height)/d.canvas_height,a.width=Utils.pxConversionMm(a.width)/d.canvas_width,i=a,parseFloat(i.width)>parseFloat(i.height)?(e=k/a.width,a.width=k,a.height=a.height*e*t):(e=S/a.height,a.height=S,a.width=a.width*e/t)),u(a),s.remove())},{mode:p.mode,noCutting:d.noCutting,display_width:d.canvas_width,display_height:d.canvas_height})}),l(p.mode),(d.canvas_width-144)/2),g=(d.canvas_height-58)/2+25;s.find("#kg-hw-tip").css({left:e+"px",top:g+"px"})})},Signature.prototype.barCodeDlg=function(t,i){var e={title:$.kgi18n.prop("OtherInfoQrCode"),target:this,onCancel:function(){$("#bcId").blur()}},n=this.showDialog("barcodedlg",e),e=(Signature.repairInputEvent($("#bcId")),n.find("#bc_clearid")),a=n.find("#bc_okid"),o=n.find("#bcId");e&&e.click(function(){o.val("")}),a&&a.click(function(){n.close();var e=n.find("#output").qrcode(o.val()),e={height:t.image_height||"5",width:t.image_width||"5",imageData:e,name:$.kgi18n.prop("OtherInfoQrCode")};i(e)})},Signature.prototype.scanStampDlg=function(e,t){var i,n;Signature.options.clientConfig||(i=this,n={title:kinggrid.msg("scanBCSignature","KG_TITLE"),target:i,onCancel:!1},e=e.type,Signature.ScanStamp.call(i,function(){return i.showDialog("scanStampdlg",n)},function(e){t(e)},e).getQrCodeImageByStamp())},Signature.prototype.scanBCDlg=function(t,i){var e={title:kinggrid.msg("scanBCSignature","KG_TITLE"),target:this,onCancel:!1},n=this.showDialog("scanbarcodedlg",e);try{var a=document.getElementById("qr-canvas").getContext("2d"),o=document.getElementById("html5_qrcode_video"),s=(window.navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL||window.oURL,window.navigator.getUserMedia&&window.navigator.getUserMedia({video:!0,audio:!1},function(e){o.src=window.URL.createObjectURL(e),o.play()},function(e){alert("出错信息: "+e.name)}),setInterval(function(){var e;a&&(a.drawImage(o,0,0,640,480),e=a.getImageData(0,0,640,480),(e=jsQR.decodeQRFromImage(e.data,e.width,e.height))&&(n.close(),window.clearInterval(s),t.content=e,e={height:t.image_height||"5",width:t.image_width||"5",imageData:$("#output").qrcode(e),name:$.kgi18n.prop("OtherInfoQrCode")},i(e)))},2e3))}catch(e){printHtml("浏览器不支持HTML5 CANVAS")}};var plus=kingPlus(),getsec=(Utils.extend(plus.alertConfig,{cancelDisplay:!0,quickClose:!1,backdropOpacity:.1}),Utils.extend(plus.loadingConfig,{cancelDisplay:!0,quickClose:!1,backdropOpacity:.1}),Utils.extend(plus.dialogConfig,{cancelDisplay:!1,quickClose:!0}),function(e){var t=+e.substring(1,e.length),e=e.substring(0,1);return"s"==e?1e3*t:"h"==e?60*t*60*1e3:"d"==e?24*t*60*60*1e3:void 0}),whiteList=/[0-9A-Za-z]/,whiteListExp=new RegExp(whiteList),setCookie=function(e,t,i,n=!1){var a,o=escape(t);n?whiteListExp.test(o)&&(document.cookie=e+"="+t+";expires="+i):(n=getsec(i),(a=new Date).setTime(a.getTime()+ +n),whiteListExp.test(o)&&(document.cookie=e+"="+o+";expires="+a.toGMTString())),"pwd"===e&&(Signature.CookiePWD=a.toGMTString())},getCookie=function(e){var e=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(e=document.cookie.match(e))?unescape(e[2]):null},delCookie=function(e){var t=new Date,i=(t.setTime(t.getTime()-1),getCookie(e));null!=i&&(document.cookie=e+"="+i+";expires="+t.toGMTString())},SignaturePad=(Signature.prototype.onshowSealsDialog_PW=function(i){var n,a=this;a.sealService.getKeysn({},function(e){var t;a.keysn=n=e,"true"==getCookie("ck")&&i.find("#kg-remenberPwd").attr("checked","checked"),i.find("#kg-remenberPwd").is(":checked")&&(e=getCookie("ksn"),n==e&&(e=i.find("#kg-password"),t=getCookie("pwd"),null!=(t=Signature.options.pw_enc_save?Utils.Base64.of().decode(t):t)?e.val(t):e.val("123")))})},Signature.prototype.onexecSuccess=function(e,n,a,o){var s,r=this;o=o||Signature.options.rememberPwdAndNotShowSealTpl,r.sealService.getKeysn({},function(e){var t,i;r.keysn=s=e,a?(t=getCookie("ksn"),e=Signature.options.pw_timeout,i=function(e){s!=t?((void 0===e||e.indexOf("s")<0&&e.indexOf("h")<0&&e.indexOf("d")<0)&&(e="s1800"),Signature.options.pw_enc_save&&(n=Utils.Base64.of().encode(n)),setCookie("ksn",s,e),setCookie("pwd",n,e),setCookie("ck","true",e),o&&setCookie("SST","true",e)):o&&setCookie("SST","true",Signature.CookiePWD,!0)},Signature.options.pw_server_timeout?r.sealService.getPwdSaveTime(i,e):i(e)):Signature.options.pwd_clear_flag||Signature.options.remberPwdAndShowSealsDlg&&(delCookie("ksn"),delCookie("pwd"),delCookie("ck"),delCookie("SST"))})},Signature.prototype.ongetRPW=function(e){if(getCookie("ksn")==e)return e=getCookie("pwd"),Signature.options.pw_enc_save?Utils.Base64.of().decode(e):e},Signature.prototype.onDeleteRPW=function(){delCookie("ksn"),delCookie("pwd"),delCookie("ck"),delCookie("SST")},function(P){function e(e,t){this.times=2,this.canvas=e,this.isSign=!1,t.isMobile=/phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone/i.test(navigator.userAgent),this.painting=new i("canvasId",t),this.initCanvas(t),this.painting.touchstartCallback=t.onBegin,this.painting.touchendCallback=t.onEnd,this.lineSize=t.lineSize||5,this.setSize(this.lineSize),this.lineMax=t.lineMax||4,this.painting.setLineMax(this.lineMax),this.lineMin=t.lineMin||.5,this.painting.setLineMin(this.lineMin),this.smoothness=t.smoothness||100,this.painting.setSmoothness(this.smoothness)}function i(e,o,t){var i,n=!1;function a(e){return e.type.indexOf("mouse")<0&&(i=!0),e}function s(e){return(e=a(e||window.event)).stopPropagation(),"mousedown"!=e.type&&"touchstart"!=e.type||$(e.target)[0].id!=D.canvasName||i&&1<e.touches.length?0:((1===e.which||i&&1==e.touches.length)&&(n=!0,"svg"!=D.writeType&&(g.fillStyle=k,g.globalAlpha=1),e=I(i?e.touches[0]:e),S=e,y.unshift({time:(new Date).getTime(),dis:0,x:e.x,y:e.y}),C&&(x={top:e.y,right:e.x,bottom:e.y,left:e.x},C=!1),B(y)),void("function"==typeof D.touchstartCallback&&D.touchstartCallback()))}function r(e){if(!(e.length<=1)){var t,i,n,a,o,s,r,l,c;e.length<=2?(t=e[1].x,a=e[1].y,i=t+.5*((n=e[1].x+.5*(e[0].x-e[1].x))-t),o=a+.5*((s=e[1].y+.5*(e[0].y-e[1].y))-a),l=.5*((r=e[1].r)+(c=e[1].r+.5*(e[0].r-e[1].r)))):(t=e[2].x+.5*(e[1].x-e[2].x),a=e[2].y+.5*(e[1].y-e[2].y),i=e[1].x,o=e[1].y,n=i+.5*(e[0].x-i),s=o+.5*(e[0].y-o),r=e[2].r+.5*(e[1].r-e[2].r),c=(l=e[1].r)+.5*(e[0].r-l));for(var g=[],d=0;d<5;d++){var u,h=d/4,p=(1-h)*(1-h)*t+2*h*(1-h)*i+h*h*n,h=(1-h)*(1-h)*a+2*h*(1-h)*o+h*h*s,f=r+(c-r)/5*d;g.push({x:p,y:h,r:f}),3==g.length&&((u=function(e,t,i,n,a,o,s,r){var l,c,g,d,u,h,p,f=[];l=n-e,c=a-t,p=2*Math.sqrt(l*l+c*c+1e-4),g=c=c/p*i,i=-(l=l/p*i),d=n-o,u=a-s,p=2*Math.sqrt(d*d+u*u+1e-4),h=-(u=u/p*r),p=d=d/p*r,f.push({mx:e+g,my:t+i,color:"#1A1A1A"}),f.push({c1x:n+g,c1y:a+i,c2x:n+h,c2y:a+p,ex:o+h,ey:s+p}),f.push({c1x:o+h-d,c1y:s+p-u,c2x:o-h-d,c2y:s-p-u,ex:o-h,ey:s-p}),f.push({c1x:n-h,c1y:a-p,c2x:n-g,c2y:a-i,ex:e-g,ey:t-i}),f.push({c1x:e-g-l,c1y:t-i-c,c2x:e+g-l,c2y:t+i-c,ex:e+g,ey:t+i}),f[0].mx=f[0].mx.toFixed(1),f[0].mx=parseFloat(f[0].mx),f[0].my=f[0].my.toFixed(1),f[0].my=parseFloat(f[0].my);for(var m=1;m<f.length;m++)f[m].c1x=f[m].c1x.toFixed(1),f[m].c1x=parseFloat(f[m].c1x),f[m].c1y=f[m].c1y.toFixed(1),f[m].c1y=parseFloat(f[m].c1y),f[m].c2x=f[m].c2x.toFixed(1),f[m].c2x=parseFloat(f[m].c2x),f[m].c2y=f[m].c2y.toFixed(1),f[m].c2y=parseFloat(f[m].c2y),f[m].ex=f[m].ex.toFixed(1),f[m].ex=parseFloat(f[m].ex),f[m].ey=f[m].ey.toFixed(1),f[m].ey=parseFloat(f[m].ey);return f}(g[0].x,g[0].y,g[0].r,g[1].x,g[1].y,(g[1].r,g[2].x),g[2].y,g[2].r))[0].color=k,D.bethelPoint.push(u),M(u,1),g=[{x:p,y:h,r:f}])}}}function m(e){return e=e.toFixed(4),parseFloat(e)}function v(e){if(/^(rgb|RGB)/.test(e)){for(var t=e.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),i="#",n=0;n<t.length;n++){var a=Number(t[n]).toString(16);i+=a=a.length<2?"0"+a:a}return i=7!==i.length?e:i}if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(e)){var o=e.replace(/#/,"").split("");if(6===o.length)return e;if(3===o.length){for(var s="#",n=0;n<o.length;n+=1)s+=o[n]+o[n];return s}}return e}this.writeType="canvas",this.canvasName=e,this.lineMin=.5,this.lineMax=2,this.pressure=1,this.linePrack=[],this.chirography=[],this.currentChirography={},this.transformpdfData=[],this.canvasWidth=0,this.canvasHeight=0,this.currentBethelLinePoint=[],this.bethelPoint=[];function d(e,t,i,n,a){return{x:e*Math.cos(i)-t*Math.sin(i)+n,y:e*Math.sin(i)+t*Math.cos(i)+a}}var l=null,c=null,g=null,u=null,k="#1A1A1A",h=1.5,p=100,f=0,S={},y=[],b=2,w=2,C=!0,x={top:0,right:0,bottom:0,left:0},D=this,A=(this.touchstartCallback="",this.touchmoveCallback="",this.touchendCallback="",this.clearCanvasCallback="",this.init=function(e,t,i,n){D.writeType="canvas",D.canvas=o.dlg.find("#"+D.canvasName)[0],(g=D.canvas.getContext("2d")).rotate(45*Math.PI/180),g.fillStyle="rgba(0,0,0,1)";var a=D.canvas;b=(i=null==i?720:i)/(e=null==e?720:e),w=(n=null==n?1280:n)/(t=null==t?1280:t),$(a).width(e),$(a).attr("width",i),$(a).height(t),$(a).attr("height",n),D.canvasWidth=i,D.canvasHeight=n,o.dlg.find("#"+D.canvasName)[0].addEventListener("mousedown",s,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mousemove",A,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mouseup",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mouseout",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchstart",s,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchmove",A,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchend",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchcancel",T,!1)},this.initSVG=function(e,t,i,n){D.writeType="svg",b=(i=null==i?720:i)/(e=null==e?720:e),w=(n=null==n?1280:n)/(t=null==t?1280:t),D.canvas=P.getElementById(D.canvasName),(u=new Snap(D.canvas)).attr({width:e,height:t,viewBox:"0, 0, "+i+", "+n}),o.dlg.find("#"+D.canvasName)[0].addEventListener("mousedown",s,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mousemove",A,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mouseup",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("mouseout",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchstart",s,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchmove",A,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchend",_,!1),o.dlg.find("#"+D.canvasName)[0].addEventListener("touchcancel",T,!1)},this.newCanvas=function(e,t,i,n,a){var o=this.canvas,s=$(o)[0].id,s=P.getElementById(s).getContext("2d"),r=s.getImageData(0,0,o.width,o.height),e=(b=(i=null==i?720:i)/(e=null==e?720:e),w=(n=null==n?1280:n)/(t=null==t?1280:t),$(o).width(e),$(o).attr("width",i),$(o).height(t),$(o).attr("height",n),D.canvasWidth=i,D.canvasHeight=n,parseInt(o.width*(1-1/a)));o.height,console.log(e),s.putImageData(r,parseInt(e),0)},this.setCanvasSize=function(e,t,i,n,a,o){var s=this,r=(null==e&&(e=s.width),null==t&&(t=s.height),null==innerWidth&&(innerWidth=s.innverWidth),null==innerHeight&&(innerHeight=s.innerheight),g.getImageData(0,0,s.innerWidth,s.innerHeight));b=innerWidth/e,w=innerHeight/t,$(s.canvas).width(e),$(s.canvas).attr("width",innerWidth),$(s.canvas).height(t),$(s.canvas).attr("height",innerHeight),s.canvasWidth=innerWidth,s.canvasHeight=innerHeight,g.putImageData(r,0,0)},this.setLineColor=function(e){k=e},this.setLineSize=function(e){h=e},this.setSmoothness=function(e){p=e},this.setLineMin=function(e){this.lineMin=e},this.setLineMax=function(e){this.lineMax=e},this.showAllSign=function(e){var t=this.canvas,t=$(t)[0].id,t=P.getElementById(t),i=t.getContext("2d"),e=parseFloat(1/e),i=(i.scale(e,e),new Image);return i.src=t.toDataURL("image/png"),i},function(e){var e=e||window.event;return D.touchmoveCallback&&D.touchmoveCallback(),"mousemove"!=e.type&&"touchmove"!=e.type||$(e.target)[0].id!=D.canvasName?0:i&&1<e.touches.length?(e.stopPropagation(),e.preventDefault(),!e.cancelable||e.defaultPrevented||e.preventDefault(),0):((n||i&&1==e.touches.length)&&(e.cancelable&&!e.defaultPrevented&&e.preventDefault(),(e=I(i?e.touches[0]:e)).y<x.top&&(x.top=e.y),e.y<0&&(x.top=0),e.x>x.right&&(x.right=e.x),D.canvasWidth-e.x<=0&&(x.right=D.canvasWidth),e.y>x.bottom&&(x.bottom=e.y),D.canvasHeight-e.y<=0&&(x.bottom=D.canvasHeight),e.x<x.left&&(x.left=e.x),e.x<0&&(x.left=0),f=S,S=e,y.unshift({time:(new Date).getTime(),dis:D.distance(S,f),x:e.x,y:e.y}),B(y)),void("function"==typeof D.touchmoveCallback&&D.touchmoveCallback()))}),_=function(e){return(e=a(e||window.event)).stopPropagation(),"mouseup"!=e.type&&"touchend"!=e.type||$(e.target)[0].id!=D.canvasName?0:void((1===e.which&&n||i&&!(1<e.touches.length))&&(n=!1,e=I(i?e.changedTouches[0]:e),f=S,S=e,y.unshift({time:(new Date).getTime(),dis:D.distance(S,f),x:e.x,y:e.y}),2<y.length&&(y[0].time,y[y.length-1].time,y.length),y=("canvas"==D.writeType?(B(y),e={lineSize:h,lineColor:k},D.chirography.unshift(e),D.linePrack.unshift(y)):D.overlapInCanvas(y),[]),"function"==typeof D.touchendCallback&&D.touchendCallback()))},T=function(e){(e=a(e||window.event)).type},I=function(e){if(null==l||null==D.offsetTop)if("svg"==D.writeType)l=$(D.canvas).offset().left,c=$(D.canvas).offset().top;else{var t=0;l=D.canvas.offsetLeft,c=D.canvas.offsetTop;for(var i=D.canvas.parentNode;t<100&&i.tagName&&"BODY"!=i.tagName;)l+=i.offsetLeft,c+=i.offsetTop,i=i.parentNode,t++}var n=e.clientX-l,e=e.clientY-c+100+o.toolBarHeight;return o.hideToolBar&&(e-=o.toolBarHeight),window!=top&&root.iframeDialog&&(e+=$(window.top.document).find(".kg-hw-content").height()),o.notYTop&&(e-=100),{x:n*=b,y:e*=w}},B=function(e){(function(e){if(e.length<=1)return e[0].r=1;D.distance({x:e[0].x,y:e[0].y},{x:e[1].x,y:e[1].y});for(var t=0,i=0,n=0;n<e.length-1&&(t+=e[n].dis,i+=e[n].time-e[n+1].time,!(p<t));n++);e[0].r=Math.min(i/+t*D.pressure+D.lineMin,D.lineMax)*h})(e),r(e)},M=(this.distance=function(e,t){var i=t.x-e.x,t=t.y-e.y;return Math.sqrt(i*i+t*t)},this.reWriteCanvas=function(){g.restore()},this.writeCanvas=function(){D.clearCanvas();for(var e=0;e<D.linePrack.length;e++){var t=D.linePrack[D.linePrack.length-e-1],i=[];g.fillStyle=D.chirography[D.chirography.length-e-1].lineColor,h=D.chirography[D.chirography.length-e-1].lineSize,k=D.chirography[D.chirography.length-e-1].lineColor;for(var n=0;n<t.length;n++)i.unshift(t[t.length-n-1]),B(i)}return!0},this.clearCanvas=function(){"function"==typeof D.clearCanvasCallback&&D.clearCanvasCallback(),g&&g.clearRect(0,0,D.canvas.width,D.canvas.height),u&&u.clear()},this.clearCanvasAndData=function(){D.clearCanvas(),D.linePrack=[],D.chirography=[],D.bethelPoint=[],C=!0},this.overlapInCanvas=function(e){for(var t=e[0],i=0;i<D.linePrack.length;i++)for(var n=D.linePrack[i],a=0;a<n.length;a++)if((t.x-n[a].x)*(t.x-n[a].x)+(t.y-n[a].y)*(t.y-n[a].y)<400){D.linePrack.splice(i,1),D.chirography.splice(i,1),D.writeCanvas();break}},this.overlapLine=function(e,t,i,n){g.isPointInPath(20,50)},function(e,t,i){if("svg"==D.writeType){void 0===i&&(i=e[0].color);for(var n="M "+e[0].mx+" "+e[0].my+" C",a=1;a<e.length;a++)n=(n=(n+=" "+e[a].c1x+" "+e[a].c1y)+(" "+e[a].c2x+" "+e[a].c2y))+(" "+e[a].ex+" "+e[a].ey);u.path(n).attr("stroke",i).attr("stroke-width",1).attr("fill",i)}else{g.beginPath(),g.moveTo(e[0].mx,e[0].my),null!=i?(g.fillStyle=i,g.strokeStyle=i):(g.fillStyle=e[0].color,g.strokeStyle=e[0].color);for(var o=1;o<e.length;o++)g.bezierCurveTo(e[o].c1x,e[o].c1y,e[o].c2x,e[o].c2y,e[o].ex,e[o].ey);g.stroke(),null!=t&&g.fill()}});this.saveImage=function(){return this.canvas.toDataURL.apply(this.canvas,arguments)},this.coordinateSystem=function(e,t){return{x:e,y:t}},this.transformpdf=function(){for(var e=this.linePrack,t=0;t<e.length;t++){var i=e[t];if(!(i.length<2)){for(var n,a,o,s,r,l,c,g,d,u,h=0,p=i.length,f=+i[p-1].x+0+.1,m=+i[p-1].y+0,v=i[p-1].r,k=+i[p-2].x+0+.1,S=+i[p-2].y+0,y=i[p-2].r,b=k-f,w=S-m,C=2*Math.sqrt(b*b+w*w+1e-4),x=w=w/C*1*v,A=-(b=b/C*1*v),_=[],h=3;h<=i.length;h++)a=+i[p-h].x+0,s=+i[p-h].y+0,r=(y+(l=i[p-h].r))/2,c=k-(n=(k+a)/2),d=-(g=(g=S-(o=(S+s)/2))/(C=2*Math.sqrt(c*c+g*g+1e-4))*1*r),u=c=c/C*1*r,_[0]=D.coordinateSystem(f+x,m+A),_[1]=D.coordinateSystem(k+x,S+A),_[2]=D.coordinateSystem(k+d,S+u),_[3]=D.coordinateSystem(n+d,o+u),_[4]=D.coordinateSystem(n+d-c,o+u-g),_[5]=D.coordinateSystem(n-d-c,o-u-g),_[6]=D.coordinateSystem(n-d,o-u),_[7]=D.coordinateSystem(k-d,S-u),_[8]=D.coordinateSystem(k-x,S-A),_[9]=D.coordinateSystem(f-x,m-A),_[10]=D.coordinateSystem(f-x-b,m-A-w),_[11]=D.coordinateSystem(f+x-b,m+A-w),_[12]=D.coordinateSystem(f+x,m+A),f=n,m=o,k=a,S=s,y=l,b=-c,w=-g,x=d,A=u,D.transformpdfData.push(_);n=+i[0].x+0,o=+i[0].y+0,r=i[0].r,c=k-n,d=-(g=(g=S-o)/(C=2*Math.sqrt(c*c+g*g+1e-4))*1*r),u=c=c/C*1*r,_[0]=D.coordinateSystem(f+x,m+A),_[0]=D.coordinateSystem(f+x,m+A)}}},this.getExtrema=function(){var e=this;x={top:e.canvasHeight*w,right:0,bottom:0,left:e.canvasWidth*b};for(var t=0;t<e.linePrack.length;t++)for(var i=0;i<e.linePrack[t].length;i++)e.linePrack[t][i].y<x.top&&(x.top=e.linePrack[t][i].y),e.linePrack[t][i].y>x.bottom&&(x.bottom=e.linePrack[t][i].y),e.linePrack[t][i].x>x.right&&(x.right=e.linePrack[t][i].x),e.linePrack[t][i].x<x.left&&(x.left=e.linePrack[t][i].x)};this.calcRotateCanvasInfo=function(){for(var e,t,i,n,a=this,o=[],s=[],r=x.bottom-x.top+60,l=x.right-x.left+60,c=0;c<a.linePrack.length;c++){o[c]=[],s[c]={lineSize:a.chirography[c].lineSize,lineColor:a.chirography[c].lineColor};for(var g=0;g<a.linePrack[c].length;g++)n=a.linePrack[c][g].x-x.left+30,e=a.linePrack[c][g].y-x.top+30,t=-Math.PI/2,i=x.right-x.left+60,n=d(n,e,t,0,i),o[c][g]={x:m(n.x),y:m(n.y),dis:a.linePrack[c][g].dis,time:a.linePrack[c][g].time,r:a.linePrack[c][g].r}}return{canvasWidth:r/b,canvasHeight:l/w,canvasInnerWidth:r,canvasInnerHeight:l,linePrack:o,chirography:s,bethelPoint:a.bethelPoint}},this.destory=function(){},this.centreRotate=function(e){for(var t,i=-(Math.min(D.canvasWidth*Math.cos(e),0)+Math.min(D.canvasHeight*Math.cos(e+Math.PI/2),0)),n=-(Math.min(D.canvasWidth*Math.sin(e),0)+Math.min(D.canvasHeight*Math.sin(e+Math.PI/2),0)),a=0;a<D.bethelPoint.length;a++){t=d(D.bethelPoint[a][0].mx,D.bethelPoint[a][0].my,e,i,n),D.bethelPoint[a][0].mx=t.x,D.bethelPoint[a][0].my=t.y;for(var o=1;o<D.bethelPoint[a].length;o++)t=d(D.bethelPoint[a][o].c1x,D.bethelPoint[a][o].c1y,e,i,n),D.bethelPoint[a][o].c1x=t.x,D.bethelPoint[a][o].c1y=t.y,t=d(D.bethelPoint[a][o].c2x,D.bethelPoint[a][o].c2y,e,i,n),D.bethelPoint[a][o].c2x=t.x,D.bethelPoint[a][o].c2y=t.y,t=d(D.bethelPoint[a][o].ex,D.bethelPoint[a][o].ey,e,i,n),D.bethelPoint[a][o].ex=t.x,D.bethelPoint[a][o].ey=t.y}var s=Math.abs(D.canvasWidth*Math.cos(e))+Math.abs(D.canvasHeight*Math.cos(e+Math.PI/2)),r=Math.abs(D.canvasWidth*Math.sin(e))+Math.abs(D.canvasHeight*Math.sin(e+Math.PI/2));D.canvasWidth=s,D.canvasHeight=r},this.toSVG=function(e){for(var t=this,i=e?new Snap(e):new Snap,n=0;n<t.bethelPoint.length;n++){for(var a="M "+m(t.bethelPoint[n][0].mx/t.canvasHeight)+" "+m(t.bethelPoint[n][0].my/t.canvasHeight)+" C",o=1;o<t.bethelPoint[n].length;o++)a=(a=(a+=" "+m(t.bethelPoint[n][o].c1x/t.canvasHeight)+" "+m(t.bethelPoint[n][o].c1y/t.canvasHeight))+(" "+m(t.bethelPoint[n][o].c2x/t.canvasHeight)+" "+m(t.bethelPoint[n][o].c2y/t.canvasHeight)))+(" "+m(t.bethelPoint[n][o].ex/t.canvasHeight)+" "+m(t.bethelPoint[n][o].ey/t.canvasHeight));i.path(a).attr("stroke",t.bethelPoint[n][0].color).attr("stroke-width",1/t.canvasHeight).attr("fill",t.bethelPoint[n][0].color)}e="0 0 "+m(t.canvasWidth/t.canvasHeight)+" 1";return i.attr("viewBox",e),i.attr("width",m(t.canvasWidth/t.canvasHeight)+"px"),i.attr("height","1px"),i.outerSVG()},this.toCommonSVG=function(e){for(var t=e?new Snap(e):new Snap,i=0;i<D.bethelPoint.length;i++){for(var n="M "+m(D.bethelPoint[i][0].mx)+" "+m(D.bethelPoint[i][0].my)+" C",a=1;a<D.bethelPoint[i].length;a++)n=(n=(n+=" "+m(D.bethelPoint[i][a].c1x)+" "+m(D.bethelPoint[i][a].c1y))+(" "+m(D.bethelPoint[i][a].c2x)+" "+m(D.bethelPoint[i][a].c2y)))+(" "+m(D.bethelPoint[i][a].ex)+" "+m(D.bethelPoint[i][a].ey));t.path(n).attr("stroke",D.bethelPoint[i][0].color).attr("stroke-width",1).attr("fill",D.bethelPoint[i][0].color)}e="0 0 "+D.canvasWidth+" "+D.canvasHeight;return t.attr("viewBox",e),t.attr("width",D.canvasWidth+"px"),t.attr("height",D.canvasHeight+"px"),t.outerSVG()},this.pathToSVG=function(c){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,g=$("body").width(),d=$("body").height();if(1==e){var e="svg"+Math.floor(1e4*Math.random()),t=$("<svg id="+e+"></svg>"),i=(t.css("position","fixed"),$("body").prepend(t),new Snap("#"+e));i.attr("width",g+"px"),i.attr("height",d+"px");for(var n=0;n<c.length;n++){for(var a="M "+m(c[n][0].mx*g)+" "+m((1-c[n][0].my)*d)+" C",o=1;o<c[n].length;o++)a=(a=(a+=" "+m(c[n][o].c1x*g)+" "+m((1-c[n][o].c1y)*d))+(" "+m(c[n][o].c2x*g)+" "+m((1-c[n][o].c2y)*d)))+(" "+m(c[n][o].ex*g)+" "+m((1-c[n][o].ey)*d));i.path(a).attr("stroke",c[n][0].color).attr("stroke-width",1).attr("fill","none")}}else Object.keys(c).forEach(function(e){for(var t=c[e],i=0;i<t.length;i++){var n="svg"+i+Math.floor(1e4*Math.random()),a=$("<svg id="+n+"></svg>"),o=(a.css("position","fixed"),$("body").prepend(a),new Snap("#"+n));o.attr("width",g+"px"),o.attr("height",d+"px");for(var s=0;s<t[i].length;s++){for(var r="M "+t[i][s][0].mx*g+" "+(1-t[i][s][0].my)*d+" C",l=1;l<t[i][s].length;l++)r=(r=(r+=" "+t[i][s][l].c1x*g+" "+(1-t[i][s][l].c1y)*d)+(" "+t[i][s][l].c2x*g+" "+(1-t[i][s][l].c2y)*d))+(" "+t[i][s][l].ex*g+" "+(1-t[i][s][l].ey)*d);o.path(r).attr("stroke",t[i][s][0].color).attr("stroke-width",1).attr("fill",t[i][s][0].color)}}})},this.SVGToPath=function(e,t,i,c,g,d,u,n,a,h){var p,o,f;{if(void 0!==e&&void 0!==t&&void 0!==i&&void 0!==c&&void 0!==g&&void 0!==d&&void 0!==u)return t=new Snap(t),p=[],void 0!==n&&void 0!==a&&void 0!==h||(o=parseFloat(t.attr("height")),n=parseFloat(t.getBBox().width),a=parseFloat(t.getBBox().height),h=o/a),n=t.selectAll("path"),f="",n.forEach(function(e){for(var t,i=e.attr("d").split(" "),n=[],a=0;a<i.length;a++)2==(t=i[a].split(",")).length?(n.push(t[0]),n.push(t[1])):n.push(t[0]);for(var o=[],a=0;a<n.length;a++){var s,r=n[a];if(isNaN(parseInt(r.slice(0,1)))){if(f=r.slice(0,1),1==n[a].length&&"Z"!=f)continue;r=r.slice(1)}switch(f){case"M":s=n[a+1],a++;var l="none"==(l=e.attr("stroke"))?"#000000":v(l);console.log(m(1-(parseFloat(s)*h+u)/g)),o.push({mx:m(parseFloat(r)*h/c+d/c),my:m(1-(parseFloat(s)*h+u)/g),color:l});break;case"Q":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(r)*h/c+d/c),c2y:m(1-(parseFloat(n[a+1])*h+u)/g),ex:m(parseFloat(n[a+2])*h/c+d/c),ey:m(1-(parseFloat(n[a+3])*h+u/g))}),a+=3;break;case"C":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(n[a+2])*h/c+d/c),c2y:m(1-(parseFloat(n[a+3])*h+u)/g),ex:m(parseFloat(n[a+4])*h/c+d/c),ey:m(1-(parseFloat(n[a+5])*h+u)/g)}),a+=5;break;case"L":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(r)*h/c+d/c),c2y:m(1-(parseFloat(n[a+1])*h+u)/g),ex:m(parseFloat(r)*h/c+d/c),ey:m(1-(parseFloat(n[a+1])*h+u)/g)}),a++;break;case"Z":p.push(o),o=[]}}o.length&&p.push(o)}),void 0===e[i]&&(e[i]=[]),e[i].push(p),e;console.log("参数缺失")}},this.SVGToPathNoPage=function(e,c,g,d,u,t,i,h){var p,n,f;{if(void 0!==e&&void 0!==c&&void 0!==g&&void 0!==d&&void 0!==u)return e=new Snap(e),p=[],void 0!==t&&void 0!==i&&void 0!==h||(n=parseFloat(e.attr("height")),t=parseFloat(e.getBBox().width),i=parseFloat(e.getBBox().height),h=i/n),t=e.selectAll("path"),f="",t.forEach(function(e){for(var t,i=e.attr("d").split(" "),n=[],a=0;a<i.length;a++)2==(t=i[a].split(",")).length?(n.push(t[0]),n.push(t[1])):n.push(t[0]);for(var o=[],a=0;a<n.length;a++){var s,r=n[a];if(isNaN(parseInt(r.slice(0,1)))){if(f=r.slice(0,1),1==n[a].length&&"Z"!=f)continue;r=r.slice(1)}switch(f){case"M":s=n[a+1],a++;var l="none"==(l=e.attr("stroke"))?"#000000":v(l);o.push({mx:m(parseFloat(r)*h/c+d/c),my:m(1-(parseFloat(s)*h+u)/g),color:l});break;case"Q":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(r)*h/c+d/c),c2y:m(1-(parseFloat(n[a+1])*h+u)/g),ex:m(parseFloat(n[a+2])*h/c+d/c),ey:m(1-(parseFloat(n[a+3])*h+u/g))}),a+=3;break;case"C":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(n[a+2])*h/c+d/c),c2y:m(1-(parseFloat(n[a+3])*h+u)/g),ex:m(parseFloat(n[a+4])*h/c+d/c),ey:m(1-(parseFloat(n[a+5])*h+u)/g)}),a+=5;break;case"L":o.push({c1x:m(parseFloat(r)*h/c+d/c),c1y:m(1-(parseFloat(n[a+1])*h+u)/g),c2x:m(parseFloat(r)*h/c+d/c),c2y:m(1-(parseFloat(n[a+1])*h+u)/g),ex:m(parseFloat(r)*h/c+d/c),ey:m(1-(parseFloat(n[a+1])*h+u)/g)}),a++;break;case"Z":p.push(o),o=[]}}o.length&&p.push(o)}),p;console.log("参数缺失")}}}return e.prototype.initCanvas=function(e){var t=e.canvas_width,e=e.canvas_height;this.painting.init(t,e,t*this.times,e*this.times),this.canvas.getContext("2d").fillStyle="rgba(0,0,0,0)"},e.prototype.setSize=function(e){this.painting.setLineSize(e)},e.prototype.setColor=function(e){this.painting.setLineColor(e)},e.prototype.clear=function(){this.isSign=!1,this.painting.clearCanvasAndData()},e.prototype.setWebHandWrite=function(e,t){var i=this.canvas.getContext("2d");i.textAlign="left",i.textBaseline="bottom",i.shadowBlur=0,i.font=t.fontStyle+" "+parseFloat(t.fontSize)*this.times+"px "+t.fontFamily,i.fillStyle=t.fontColor;for(var n=0;e&&n<e.length;n++){var a=e[n];i.fillText(a.txt,a.left*this.times,a.top*this.times)}},e.prototype.toDataURL=function(i,n){for(var e=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height),t=e.data,a=e.width,o=0,s=e.height,r=0,l=0;l<this.canvas.width;l++)for(var c=0;c<e.height;c++){var g=4*(l+e.width*c);(0<t[g]||0<t[1+g]||t[2+g]||0<t[3+g])&&(r=Math.max(c,r),o=Math.max(l,o),s=Math.min(c,s),a=Math.min(l,a))}a++,o++,s++,r++;var d=this.painting.saveImage(),u=new Image;u.src=d,u.onload=function(){var e=P.createElement("canvas"),t=(e.width=o-a,e.height=r-s,e.getContext("2d")),t=(1==n.mode&&n.noCutting&&(e.width=n.display_width,e.height=n.display_height,s=a=0),0==n.mode&&n.noCutting&&(e.width=e.width>n.display_width?e.width:n.display_width,e.height=e.height>n.display_height?e.height:n.display_height,s=a=0),t.drawImage(u,a,s,e.width,e.height,0,0,e.width,e.height),{});t.imageData=e.toDataURL(),t.width=e.width,t.height=e.height,i(t)}},window.Painting=i,e}(document));
//V3.0.0.572