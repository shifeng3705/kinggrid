!function(t){"function"!=typeof define||!define.amd||"undefined"!=typeof nonUseAmd&&nonUseAmd?t():"undefined"!=typeof HTMLDev&&HTMLDev?define(["./signature"],t):define(["./signature.min"],t)}((window,function(t){window;var C=window.kinggrid,S=window.Signature,T=window.jQuery;function n(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function l(t,i){s=i;var e,a,s=0==(a=n(e=t)*n(s))?0:(1<(e=(e.x*s.x+e.y*s.y)/a)&&(e=1),Math.acos(e));return 0<t.x*i.y-i.x*t.y&&(s*=-1),180*s/Math.PI}function a(t,i){this.preV={x:null,y:null},this.pinchStartLen=null,this.scale=1,this.isDoubleTap=!1,this.rotate=i.rotate||function(){},this.pointStart=i.pointStart||function(){},this.multipointStart=i.multipointStart||function(){},this.multipointEnd=i.multipointEnd||function(){},this.pinch=i.pinch||function(){},this.swipe=i.swipe||function(){},this.tap=i.tap||function(){},this.doubleTap=i.doubleTap||function(){},this.longTap=i.longTap||function(){},this.singleTap=i.singleTap||function(){},this.pressMove=i.pressMove||function(){},this.delta=null,this.last=null,this.now=null,this.tapTimeout=null,this.touchTimeout=null,this.longTapTimeout=null,this.swipeTimeout=null,this.x1=this.x2=this.y1=this.y2=null,this.preTapPosition={x:null,y:null},t.addEventListener("touchstart",this.start.bind(this),!1),t.addEventListener("touchmove",this.move.bind(this),!1),t.addEventListener("touchend",this.end.bind(this),!1),t.addEventListener("touchcancel",this.cancel.bind(this),!1)}a.prototype={start:function(t){var i,e;t.touches&&(this.now=Date.now(),this.x1=t.touches[0].pageX,this.y1=t.touches[0].pageY,this.delta=this.now-(this.last||this.now),this.pointStart(t),null!==this.preTapPosition.x&&(this.isDoubleTap=0<this.delta&&this.delta<=250&&Math.abs(this.preTapPosition.x-this.x1)<30&&Math.abs(this.preTapPosition.y-this.y1)<30),this.preTapPosition.x=this.x1,this.preTapPosition.y=this.y1,this.last=this.now,i=this.preV,1<t.touches.length&&(e={x:t.touches[1].pageX-this.x1,y:t.touches[1].pageY-this.y1},i.x=e.x,i.y=e.y,this.pinchStartLen=n(i),this.multipointStart(t)),this.longTapTimeout=setTimeout(function(){this.longTap(t)}.bind(this),750))},move:function(t){var i,e,a,s;t.touches&&(i=this.preV,s=t.touches.length,e=t.touches[0].pageX,a=t.touches[0].pageY,this.isDoubleTap=!1,1<s?(s={x:t.touches[1].pageX-e,y:t.touches[1].pageY-a},null!==i.x&&(0<this.pinchStartLen&&(t.scale=n(s)/this.pinchStartLen,this.pinch(t)),t.angle=l(s,i),this.rotate(t)),i.x=s.x,i.y=s.y):null!==this.x2&&(t.deltaX=e-this.x2,t.deltaY=a-this.y2,this.pressMove(t)),this._cancelLongTap(),this.x2=e,this.y2=a,t.preventDefault())},end:function(t){var i;t.changedTouches&&(this._cancelLongTap(),i=this,t.touches.length<2&&this.multipointEnd(t),this.x2&&30<Math.abs(this.x1-this.x2)||this.y2&&30<Math.abs(this.preV.y-this.y2)?(t.direction=this._swipeDirection(this.x1,this.x2,this.y1,this.y2),this.swipeTimeout=setTimeout(function(){i.swipe(t)},0)):this.tapTimeout=setTimeout(function(){i.isDoubleTap?(i.doubleTap(t),clearTimeout(i.touchTimeout),i.isDoubleTap=!1):i.touchTimeout=setTimeout(function(){i.singleTap(t)},250)},0),this.preV.x=0,this.preV.y=0,this.scale=1,this.pinchStartLen=null,this.x1=this.x2=this.y1=this.y2=null)},cancel:function(){clearTimeout(this.touchTimeout),clearInterval(this.tapTimeout),clearInterval(this.longTapTimeout),clearInterval(this.swipeTimeout)},_cancelLongTap:function(){clearTimeout(this.longTapTimeout)},_swipeDirection:function(t,i,e,a){return Math.abs(t-i)>=Math.abs(e-a)?0<t-i?"Left":"Right":0<e-a?"Up":"Down"}};var _=C.Utils;_.extend(S.options.template,{infoBtl:'<div class="kg-dialog kg-dialog-info" id="kg-info"><%var autoCertMode = Signature.options.autoCertMode; %><%var modified = this.modified;%><%var timeVerify = this.timeVerify;%><%var tsaInfo = !!this.signatureData.signMeta?this.signatureData.signMeta.tsaInfo:0; %><%var canSign = this.signatureData.signMeta || this.canSign(); %><div class="kg-title success <%modified?"kg-hide":""%>" style="padding:0 0 15px 0"><i class="kg-icon"></i><div><span a="<%canSign%>" data-kgi18n-html="VerifyNormal">检测结果：保护数据正常！</span><%if(timeVerify!=null){%><span class="timestamp <%timeVerify==true?"green":"red"%>"><span data-kgi18n-html="<%timeVerify==true?"Trusted":"UnTrusted"%>"></span></span><%}%></div></div><div class="kg-title danger  <%modified?"":"kg-hide"%> "  style="padding:20px 0"><i class="kg-icon"></i><div><span data-kgi18n-html="VerifyTamper">检测结果：保护数据被篡改！</span><%if(timeVerify!=null){%><span class="timestamp <%timeVerify==true?"green":"red"%>"><span data-kgi18n-html="<%timeVerify==true?"Trusted":"UnTrusted"%>"></span></span><%}%></div></div><div class="kg-content"><div class="kg-tab"><ul class="kg-nav clearfix"><li class=" <% modified?"":"active"%> "><a href="#" class="kg-title-red" kg-target="signatureinfo" data-kgi18n-html="SignInfo">签章信息</a></li><%if(autoCertMode){%><%if(canSign){%><li class=""><a href="#" class="kg-title-red" kg-target="certinfo" data-kgi18n-html="CertInfo">证书信息</a></li><%if(!!tsaInfo){%><li class=""><a href="#" class="kg-title-red" kg-target="tsaInfo"  data-kgi18n-html="tStampInfo">时间戳信息</a></li><%}%><%}%><%}{%><%if(this.icon_sign == null || this.icon_sign == true){%><%if(canSign){%><li class="" ><a href="#" class="kg-title-red" kg-target="certinfo" data-kgi18n-html="CertInfo">证书信息</a></li><%if(!!tsaInfo){%><li class=""><a href="#" class="kg-title-red" kg-target="tsaInfo"  data-kgi18n-html="tStampInfo">时间戳信息</a></li><%}%><%}%><%}%><%}%></ul><div class="kg-tab-content"><div class="kg-tab-pane active signatureinfo"><% var SDATA = this.signatureData; %><% var modifiedItems = this.modifiedItems; %><% var scanStamp = this.signatureData.stampType;%><div class="kg-meta"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Application">应用程序：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.appname%></span></div><%if(SDATA.orgname){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="AuthorizedUnit">授权单位：</label><span class="kg-value  <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.orgname%></span></div><%}%><%if(SDATA.username){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="UserName">用户名称：</label><span class="kg-value  <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.username%></span></div><%}%><%if(SDATA.keysn){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="KeySequence">密钥序列：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.keysn%></span></div><%}%><%if(SDATA.esid){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" >esid</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.esid%></span></div><%}%><%if(SDATA.seal.signname){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureName">签章名称：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%SDATA.seal.signname%></span></div><%}%><%if(SDATA.seal.signsn){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureSequence">签章序列：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%SDATA.seal.signsn%></span></div><%}%><%if(SDATA.timestamp.signtime){%><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureDate">签章日期：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%SDATA.timestamp.signtime%></span></div><%}%></div><%if(this.icon_remove == null || this.icon_remove == true){%><div><button type="button" id="revoke_<%this.signatureid%>" class="kg-button" i-id="revoke" data-kgi18n-html="RevokeSign" >撤销签章</button></div><%}%></div><%if(canSign){%><div class="kg-tab-pane certinfo"><%var noCertInfo = !this.signatureData.signMeta; %><%if(!noCertInfo){%><%var certinfo = this.signatureData.signMeta.certinfo; %><div class="kg-meta" style="padding-bottom:20px;"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Version">版本：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>">V<%certinfo.version%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SerialNumber">序号：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height:17px;margin-top:5px;"><%certinfo.serialNumber%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="SignatureAlgorithm">签名算法：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%certinfo.algName%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="Issuer">颁发者：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height: 17px;margin-top:5px;"><%certinfo.issuerDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="User">使用者：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>" style="line-height: 17px;margin-top:5px;"><%certinfo.subjectDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="ValidFrom">有效期从：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(new Date(certinfo.notBefore) , "yyyy-MM-dd hh:mm:ss")%></span><label  class="kg-to-sm">~</label><span class="<%this.Global%>-value mf-0 <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(new Date(certinfo.notAfter) , "yyyy-MM-dd hh:mm:ss")%></span></div></div><%}else{%><div class="kg-meta"><div class="clearfix kg-item kg-visble "><label class="kg-label"></label><span class="kg-value">----------------------------------------------------------------------------------------------------------------------</span></div><div class="clearfix kg-item kg-nosign">当前文档未做数字签名</div><div class="clearfix kg-item kg-visble"><label class="kg-label"></label><span class="kg-value">--------------------------------------------------------------------</span></div></div><%}%><%if(noCertInfo){%><div><button type="button" id="sign_<%this.signatureid%>" class="kg-button" data-kgi18n-html="DigitalSign">数字签名</button></div><%}else{%><%}%></div><%if(!!tsaInfo){%><div class="kg-tab-pane tsaInfo"><div class="kg-meta"><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaTime">时间戳时间：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaTime%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSubject" >证书使用者：</label><span class="kg-value <%this.Global%>-value" <%this.isMobile?"mobile-value":""%>"> <%tsaInfo.tsaCert.subjectDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSerialNumber">证书序列号：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.serialNumber%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaIssuerDN">时间戳机构：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.issuerDN%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="TsaSigAlg">签名算法：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%tsaInfo.tsaCert.oid%></span></div><div class="clearfix kg-item "><label class="kg-label <%this.Global%>-label" data-kgi18n-html="ValidFrom">有效期从：</label><span class="kg-value <%this.Global%>-value <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(kinggrid.Utils.getDate(tsaInfo.tsaCert.startDate) , "yyyy-MM-dd hh:mm:ss")%></span><label  class="kg-to-sm">~</label><span class="<%this.Global%>-value mf-0 <%this.isMobile?"mobile-value":""%>"><%kinggrid.Utils.formatDate(kinggrid.Utils.getDate(tsaInfo.tsaCert.endDate) , "yyyy-MM-dd hh:mm:ss")%></span></div></div></div><%}%><%}%></div></div></div></div>',handwritedlg:'<div class="kg-dialog kg-dialog-info" id="kg-handwrite"><div class="kg-hw-content"><div class="kg-hw-info kg-hw-model"><span data-kgi18n-html="Model">模式</span><select id="hw_model" ><option value="0" <%this.mode == 0?"selected":""%> data-kgi18n-html="HWSignatrue" >手写签名</option><option value="1" <%this.mode == 1?"selected":""%> data-kgi18n-html="TextApproval">文字签批</option></select></div><div class="kg-hw-info kg-hw-name"><span data-kgi18n-html="Name">名称</span><input type="text" data-kgi18n-value="HWApproval" value="手写签批" id="nameid" style="margin-left:1px;width:76px;height:16px;"/></div><div class="kg-hw-info kg-hw-color"><span data-kgi18n-html="Color">颜色</span><select id="hw_color"><option value="black" data-kgi18n-html="KGfontColor黑">黑</option><option value="red" data-kgi18n-html="KGfontColor红">红</option><option value="blue" data-kgi18n-html="KGfontColor蓝">蓝</option><option value="green" data-kgi18n-html="KGfontColor绿">绿</option></select></div><div class="kg-hw-info kg-hw-linewidth kg-hw-handwrite"><span data-kgi18n-html="PenWidth">笔宽</span><select id="hw_width"><% for(var i=1;i<=8;i++) {%><option value="<%i%>"><%i%></option><%}%></select></div><div class="kg-hw-info kg-hw-fontFamily kg-hw-written"><span data-kgi18n-html="Font">字体</span><select id="hw_fontFamily"><% for(var i=0;i<this.fontFamily.length;i++) {%><option value="<%this.fontFamily[i].ename%>"><%this.fontFamily[i].zname%></option><%}%></select></div><div class="kg-hw-info kg-hw-fontSize kg-hw-written"><span data-kgi18n-html="FontSize">字号</span><select id="hw_fontSize"><% for(var i=16;i<=80;i+=4) {%><option value="<%i%>"<%i==this.fontSize?"selected":""%>><%i%></option><%}%></select></div></div><div class="kg-hw-canvas"><div id="kg-hw-tip">请手写签批</div><div id="kg-hw-span" class="kg-hw-written kg-hw-text-span"></div><textarea class="kg-hw-written kg-hw-text-edit" spellcheck="false"></textarea><canvas id="canvasId" style="position:relative" width=700px height=300px></canvas></div><div id="div-judge" class="kg-tab-content" align="center"><button type="button" id="clearid" class="kg-button" data-kgi18n-html="Clear">清除</button><button type="button" id="okid" class="kg-button" data-kgi18n-html="Sign">签名</button></div></div>',barcodedlg:'<div class="kg-dialog kg-dialog-info" id="kg-barcode"><label class="kg-label" data-kgi18n-html="QrCodeContent">二维码内容</label><textarea id="bcId" align="center" rows="3" cols="25"></textarea><br/><br/><div id="output"><br /></div><div id="div-judge" class="kg-tab-content"><button type="button" id="bc_clearid" class="kg-button" data-kgi18n-html="Clear">清除</button><button type="button" id="bc_okid" class="kg-button" data-kgi18n-html="Confirm">确认</button></div></div>',scanbarcodedlg:'<div class="kg-dialog kg-dialog-info" id="kg-scanBC"><div id="contentHolder" style="width:320px;height:320px; background:red;"><video id="html5_qrcode_video" height="320px" width="320px" autoplay></video><canvas id="qr-canvas" width="320px" height="320px" style="display:none;"></canvas> <br/></div></div>',scanStampdlg:'<div class="kg-dialog" id="kg-scanStampdlg"><div id="support"></div><div id="scanStampContent"><div id="kg-qrCodeImgForeground" class="hide" data-kgi18n-html="QrcodeInvalid">二维码已失效，点击刷新</div><img id="kg-qrcodeImg" width="320px" height="320px"/></div></div>'}),S._create.prototype.onshowSealsDialog=function(t){var i=this,t=(t.find(".arrow").hide(),t.find("#kg-switcher")),e={swipe:function(t){i.switcher["Left"===t.direction?"swipePrev":"swipeNext"]()},tap:function(){i.switcher.swipeNext()}};i.switcher.animate=!1,new a(t[0],e)},S.prototype.onhandleImg=function(i){var s=this,e=function(t){var i,e,a=s.verify();S._verfiyInfotoServer&&(s.signatureData,i=[],e=s._getLogInfo({LOGTYPE:"00",LOGSORT:"33",LOGMEMO:a?"文档验证成功":"文档验证失败"}),i.push(e),s.sealService.saveLog(i)),s.signatureInfo(a)},t=function(){if(void 0!==S.options.extra){var t=i.attributes.signatureid.nodeValue;if(t){t=S.options.extra[t];if(null!=t&&void 0!==t&&t.icon_move)return t.icon_move()}}}(),t=null==t||t;s.canMove(i)&&t?_.addEvent(i,"mousedown touchstart",function(t){t.originalEvent=t;s.runMove(t,i,function(t){t||e()});t.preventDefault(),t.stopPropagation()}):S.options.verifyResType?_.addEvent(i,S.options.verifyResType,e):_.addEvent(i,"click",e)},S.prototype.signatureInfo=function(){var e=this;return e.showDialog("infoBtl",{target:e,onShow:function(){var i=this,t=i.find(".kg-tab"),t=(i.tab=_.tab(t),i.find("#verifysign_"+e.signatureid)[0]),t=(t&&(t.onclick=function(){e.verifySignData(function(t){t.result?S.alert(C.msg("normal_signdata","KG_MSG")):t.errcode?e.error(t):S.alert(C.msg("modify_signdata","KG_MSG"))})}),i.find("#sign_"+e.signatureid)[0]);t&&(t.onclick=function(){e.signSignature(function(t){t.result&&(S.alert(C.msg("success_signdata","KG_MSG")),i.remove())})}),null!=e.icon_remove&&1!=e.icon_remove||(i.find("#revoke_"+e.signatureid)[0].onclick=function(){e.revokeSignature(function(t){t.result&&i.remove()})})}})};class s{constructor(){}find(t){return document.querySelectorAll(t)}}class i{constructor(t,i){this.createPad=this.createPad.bind(this),this.createPad(),this.container=document.getElementById("hwm-container"),this.canvas=document.getElementById("hwm-canvas"),this.times=1;var e=new s,e=(e[0]={},Object.assign(e[0],t),e.options={},Object.assign(e.options,t),{dlg:e,toolBarHeight:0,notYTop:!0});Object.assign(e,t),this.painting=new Painting("hwm-canvas",e),this.isSign=!1,this.initCanvas=this.initCanvas.bind(this),this.initCanvas(e),this.touchStart=this.touchStart.bind(this),this.touchEnd=this.touchEnd.bind(this),this.painting.touchendCallback=this.touchEnd,this.painting.touchmoveCallback=this.touchStart,this.context=this.canvas.getContext("2d"),this.applyBtn=document.getElementById("hwm-sign"),this.cancelBtn=document.getElementById("hwm-cancel"),this.cancelBtn.onclick=this.close.bind(this),this.clearBtn=document.getElementById("hwm-clear"),this.clearBtn.onclick=this.clear.bind(this),this.blackBtn=document.getElementById("hwm-color-black"),this.blackBtn.onclick=this.setColor.bind(this),this.greenBtn=document.getElementById("hwm-color-green"),this.greenBtn.onclick=this.setColor.bind(this),this.blueBtn=document.getElementById("hwm-color-blue"),this.blueBtn.onclick=this.setColor.bind(this),this.redBtn=document.getElementById("hwm-color-red"),this.redBtn.onclick=this.setColor.bind(this),this.show=this.show.bind(this),this.ticksBtn=document.getElementById("hwm-tick"),this.tickList=document.getElementById("hwm-ticks-list"),this.tickList.ontouchmove=this.ignoreTouchMove,this.tickList.onmousemove=this.ignoreTouchMove,this.showTick=this.showTick.bind(this),this.hideTick=this.hideTick.bind(this),this.tickBtnClick=this.tickBtnClick.bind(this),this.painting.touchstartCallback=this.hideTick,this.ticksBtn.onclick=this.tickBtnClick,this.changeSize=this.changeSize.bind(this);document.querySelectorAll("div[data-type]").forEach(t=>{t.addEventListener("click",this.changeSize),t.addEventListener("touch",this.changeSize)}),this.lineMax=e.lineMax||4,this.painting.setLineMax(this.lineMax),this.lineMin=e.lineMin||.5,this.painting.setLineMin(this.lineMin),this.smoothness=e.smoothness||100,this.painting.setSmoothness(this.smoothness);t=e.fontColor||"red",this[t+"Btn"].click(),t=e.lineSize||"5";this.painting.setLineSize(t),document.getElementById("size-radiu-"+t).classList.add("size-selected"),this.toDataURL=this.toDataURL.bind(this),this.applyBtn.onclick=i}createPad(){if(!document.getElementById("hwm-container")){var a=document.createElement("div"),t=(a.classList.add("KG_OverlayContainer","hidden"),a.setAttribute("id","hwm-container"),window.screen.width),i=window.screen.height,e=document.createElement("canvas"),t=(e.setAttribute("id","hwm-canvas"),e.width=t,e.height=i,e.style.width=t+"px",e.style.height=i+"px",e.style.position="relative",a.appendChild(e),document.createElement("div")),i=(t.setAttribute("id","hwm-tick"),t.classList.add("tick-btn"),a.appendChild(t),document.createElement("div")),s=(i.setAttribute("id","hwm-ticks-list"),i.classList.add("ticks-list"),document.createElement("div")),e=document.createElement("div");s.classList.add("tick-column"),e.classList.add("tick-column");for(var n=1;n<=8;n++){var l=document.createElement("div"),o=document.createElement("div");o.dataset.type="sizeBtn",o.setAttribute("id","size-"+n),o.dataset.size=n,o.classList.add("size-container"),l.dataset.size=n,l.setAttribute("id","size-radiu-"+n),l.dataset.type="sizeRadiu",l.classList.add("size-btn"),o.appendChild(l),s.appendChild(o)}i.appendChild(s);t=document.createElement("span"),e=(t.classList.add("tick-title"),t.innerHTML="请选择线宽",e.appendChild(t),a.appendChild(i),["red","blue","green","black"].forEach(function(t,i){var e=document.createElement("div");e.classList.add("color-btn"),e.setAttribute("id","hwm-color-"+t),e.setAttribute("data-color",""+t),e.style.top=114+50*i+"px",e.style.backgroundColor=t,0===i&&e.classList.add("selected"),a.appendChild(e)}),document.createElement("div")),t=(e.setAttribute("id","hwm-clear"),e.classList.add("clear-btn"),a.appendChild(e),document.createElement("div")),i=(t.setAttribute("id","hwm-cancel"),t.classList.add("cancel-btn"),a.appendChild(t),document.createElement("div"));i.setAttribute("id","hwm-sign"),i.classList.add("sign-btn","hidden"),a.appendChild(i),document.body.appendChild(a)}}initCanvas(t){var i=t.canvas_width,t=t.canvas_height;this.painting.init(i,t,i*this.times,t*this.times),this.canvas.getContext("2d").fillStyle="rgba(0,0,0,0)"}touchStart(){this.isSign=!0,this.applyBtn.classList.remove("hidden"),this.hideTick()}touchEnd(){this.isSign=!1}init(t){}changeSize(t){t.preventDefault(),t.stopPropagation();var t=t.target,i=t.getAttribute("data-size");"sizeBtn"===t.getAttribute("data-type")?(t.parentNode.parentNode.querySelector('div[data-size][class="size-btn size-selected"]').classList.remove("size-selected"),t.firstChild.classList.add("size-selected"),this.painting.setLineSize(i)):"sizeRadiu"===t.getAttribute("data-type")&&(t.parentNode.parentNode.querySelector('div[data-size][class="size-btn size-selected"]').classList.remove("size-selected"),t.classList.add("size-selected"),this.painting.setLineSize(i))}ignoreTouchMove(t){t.preventDefault(),t.stopPropagation()}setColor(t){t.preventDefault(),t.stopPropagation(),this.hideTick();var t=t.target,i=t.getAttribute("data-color");t.parentNode.querySelector('div[data-color][class="color-btn selected"]').classList.remove("selected"),t.classList.add("selected"),this.painting.setLineColor(i)}hide(){this.container.classList.add("hidden")}show(){this.container.classList.remove("hidden")}clear(t){t&&(t.preventDefault(),t.stopPropagation()),this.painting.clearCanvasAndData(),this.isSign=!1,this.hideTick(),this.applyBtn.classList.add("hidden")}close(t){this.redBtn.click(),this.clear(),this.hide(),this.container.parentElement.removeChild(this.container)}tickBtnClick(){1!==this.tickList.classList.length?this.hideTick():this.showTick()}showTick(){this.tickList.classList.add("show-list")}hideTick(){this.tickList.classList.remove("show-list")}toDataURL(e,t){this.hideTick();for(var i=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height),a=i.data,s=i.width,n=0,l=i.height,o=0,h=0;h<this.canvas.width;h++)for(var d=0;d<i.height;d++){var c=4*(h+i.width*d);(0<a[c]||0<a[1+c]||a[2+c]||0<a[3+c])&&(o=Math.max(d,o),n=Math.max(h,n),l=Math.min(d,l),s=Math.min(h,s))}s++,n++,l++,o++;var r=this.painting.saveImage(),g=new Image;g.src=r,g.onload=function(){var t=document.createElement("canvas");t.width=n-s,t.height=o-l;t.getContext("2d").drawImage(g,s,l,t.width,t.height,0,0,t.width,t.height);var i={};i.imageData=t.toDataURL(),i.width=t.width,i.height=t.height,e(i)}}}S.prototype.handWriteMobile=function(h,d){h.canvas_height=window.screen.height,h.canvas_width=window.screen.width,h.noCutting=!0,h.needResizeImage=!0;var c=h.canvas_height,r=h.canvas_width,g=Number(h.image_width)||8,u=Number(h.image_height)||8;S.create({}).sealService.getKeysn({},function(t){0;var o=new i(h,function(){S.hideToolBar=null,o.toDataURL(function(l){_.rotateBase64Img(l.imageData,270,t=>{l.imageData=t,o.hide();h.canvas_height,h.canvas_width;var t=l.imageData,n=new Image;n.onload=function(){c=l.height,r=l.width,c>window.screen.width?((i=document.createElement("canvas")).width=window.screen.width,i.height=window.screen.width*r/c,i.getContext("2d").drawImage(n,0,0,i.width,i.height),t=i.toDataURL(),c=i.width,r=i.height):(i=n,s=c,a=r,(e=document.createElement("canvas")).width=s,e.height=a,e.getContext("2d").drawImage(i,0,0,i.width,i.height),t=e.toDataURL()),l.imageData=t.replace(/^data:image\/\w+;base64,/,""),l.name=h.name||"",l.width=_.pxConversionMm(c/10),l.height=_.pxConversionMm(r/10);var t,i,e,a,s=l.width/l.height;a=l,parseFloat(a.width)>parseFloat(a.height)?(l.width,l.width=g,l.height=l.width/s):(l.height,l.height=u,l.width=l.height*s),d(l),o.close()},n.src=t})},{mode:0,noCutting:h.noCutting,display_width:h.canvas_width,display_height:h.canvas_height})});o.show()})},S.prototype.handWriteDlg=function(r,g){var u,v=this,m=0,p=0,t=S.create({}),f=!1,b=Number(r.image_width)||8,k=Number(r.image_height)||8,w=JSON.parse(localStorage.getItem("kg-hw-fontSize"))||Object.create(null),y=r.canvas_width,x=r.canvas_height,m=Math.max(parseInt(r.canvas_width),300)-30,p=parseInt(r.canvas_height);v.mode=r.mode||0,t.sealService.getKeysn({},function(t){w[u=t]?v.fontSize=w[u]:v.fontSize=r.fontSize||"20",v.fontFamily=M.fontFamily,_.extend(r,{title:C.msg("HWSignature","KG_TITLE"),target:v,onCancel:function(){T("#nameid").blur()}});var e,l=v.showDialog("handwritedlg",r),t=(S.repairInputEvent(T("#nameid")),l.find("#canvasId")[0]),a=(m<screen.availWidth&&540<screen.availWidth?(t.width=m,t.height=p):screen.availWidth>screen.availHeight?700<screen.availWidth?(t.width=m=670,p=t.height=.9*(screen.availHeight-210),r.noCutting&&(f=!0,t.width=m=screen.availWidth-30,t.height=p=r.canvas_height)):(t.width=.95*screen.availWidth,p=t.height=.9*(screen.availHeight-210)):r.noCutting&&r.canvas_width&&r.canvas_height&&r.canvas_width<screen.availWidth?(t.width=m=r.canvas_width,t.height=p=r.canvas_height):(r.noCutting&&(f=!0,t.height=p=r.canvas_height),m=t.width=.83*(screen.availWidth-190)+190),r.dlg=l,r.canvas_height=t.height,r.canvas_width=t.width,r.hideToolBar&&(r.canvas_height+=T(".kg-hw-content").height(),S.hideToolBar=r.hideToolBar),l.find(".kg-hw-text-span").css({height:t.height,width:t.width})),s=l.find(".kg-hw-text-edit").css({height:t.height,width:t.width}),i=(l.find(".kg-hw-content").width(m),T(".kg-dialog-info").width("auto"),l.find("#hw_width").val(r.lineSize||5),l[0].reset(),r.toolBarHeight=T(".kg-hw-content").height(),new SignaturePad(t,r));if(r.fontColor)if(0==r.fontColor.indexOf("#"))l.find("#hw_color").val(r.fontColor),i.setColor(r.fontColor),a.css({color:r.fontColor}),s.css({color:r.fontColor});else for(var n=["black","red","blue","green"],o=0;o<4;o++)if(n[o]==r.fontColor){l.find("#hw_color").val(r.fontColor),i.setColor(r.fontColor),a.css({color:r.fontColor}),s.css({color:r.fontColor});break}function h(t){"0"==t?(v.mode=0,l.find(".kg-hw-written").css({display:"none"}),l.find(".kg-hw-handwrite").css({display:"block"}),l.find("#kg-hw-tip").css({display:"inline-block"}),i.setWebHandWrite(e,{fontStyle:"normal",fontSize:a.css("font-size"),fontFamily:a.css("font-family"),fontColor:a.css("color")}),e=new Array,a.html(""),s.val("")):"1"==t&&(v.mode=1,l.find(".kg-hw-handwrite").css({display:"none"}),l.find(".kg-hw-written").css({display:"block"}),l.find("#kg-hw-tip").css({display:"none"}))}function d(t){a.css({"font-size":t+"px","line-height":6+1.2*t+"px"}),s.css({"font-size":t+"px","line-height":6+1.2*t+"px"}).attr("rows",1)}r.buttonText&&l.find("#okid").html(r.buttonText),r.hideToolBar&&l.find(".kg-hw-content").css("display","none"),l.find("#hw_color").change(function(){var t=l.find("#hw_color").val();i.setColor(t),a.css({color:t}),s.css({color:t})}),l.find("#hw_width").change(function(){var t=l.find("#hw_width").val();i.setSize(t)}),l.find("#hw_model").change(function(t){h(t.target.value)}),s.keyup(function(t){var i=_.convertText(this.value);parseFloat(s.css("line-height"))*i.split("<br>").length>parseFloat(s.css("height"))?console.warn("文字超过限制"):a.html(i),e=_.handleEdittable(a,i)}),l.find("#hw_fontFamily").change(function(t){a.css({"font-family":this.value}),s.css({"font-family":this.value})}),d(v.fontSize),l.find("#hw_fontSize").change(function(t){d(this.value),e=_.handleEdittable(a,a.html()),w[u]=this.value,localStorage.setItem("kg-hw-fontSize",JSON.stringify(w))});var t=l.find("#clearid"),c=l.find("#okid"),t=(t&&t.click(function(){e=new Array,a.html(""),s.val(""),i.clear()}),c&&c.click(function(){l.close(),S.hideToolBar=null,i.setWebHandWrite(e,{fontStyle:"normal",fontSize:a.css("font-size"),fontFamily:a.css("font-family"),fontColor:a.css("color")}),i.toDataURL(function(s){var t,n,i=r.canvas_height/r.canvas_width,e=s.imageData;f?((n=new Image).onload=function(){t=n,a=y,i=x,(e=document.createElement("canvas")).width=a,e.height=i,e.getContext("2d").drawImage(t,0,0,t.width,t.height);var t,i,e,a=e.toDataURL();s.imageData=a.replace(/^data:image\/\w+;base64,/,""),s.name=r.name||l.find("#nameid").val(),s.width=_.pxConversionMm(y/10),s.height=_.pxConversionMm(x/10),g(s),l.remove()},n.src=e):(s.imageData=s.imageData.replace(/^data:image\/\w+;base64,/,""),s.name=r.name||l.find("#nameid").val(),s.height=_.pxConversionMm(s.height)/r.canvas_height,s.width=_.pxConversionMm(s.width)/r.canvas_width,r.noCutting?(s.width=_.pxConversionMm(r.canvas_width/10),s.height=_.pxConversionMm(r.canvas_height/10)):(s.height=_.pxConversionMm(s.height)/r.canvas_height,s.width=_.pxConversionMm(s.width)/r.canvas_width,e=s,parseFloat(e.width)>parseFloat(e.height)?(t=b/s.width,s.width=b,s.height=s.height*t*i):(t=k/s.height,s.height=k,s.width=s.width*t/i)),g(s),l.remove())},{mode:v.mode,noCutting:r.noCutting,display_width:r.canvas_width,display_height:r.canvas_height})}),h(v.mode),(r.canvas_width-144)/2),c=(r.canvas_height-58)/2+25;l.find("#kg-hw-tip").css({left:t+"px",top:c+"px"})})},S.prototype.barCodeDlg=function(i,e){var t={title:T.kgi18n.prop("OtherInfoQrCode"),target:this,onCancel:function(){T("#bcId").blur()}},a=this.showDialog("barcodedlg",t),t=(S.repairInputEvent(T("#bcId")),a.find("#bc_clearid")),s=a.find("#bc_okid"),n=a.find("#bcId");t&&t.click(function(){n.val("")}),s&&s.click(function(){a.close();var t=a.find("#output").qrcode(n.val()),t={height:i.image_height||"5",width:i.image_width||"5",imageData:t,name:T.kgi18n.prop("OtherInfoQrCode")};e(t)})},S.prototype.scanStampDlg=function(t,i){var e,a;S.options.clientConfig||(e=this,a={title:C.msg("scanBCSignature","KG_TITLE"),target:e,onCancel:!1},t=t.type,S.ScanStamp.call(e,function(){return e.showDialog("scanStampdlg",a)},function(t){i(t)},t).getQrCodeImageByStamp())},S.prototype.scanBCDlg=function(i,e){var t={title:C.msg("scanBCSignature","KG_TITLE"),target:this,onCancel:!1},a=this.showDialog("scanbarcodedlg",t);try{var s=document.getElementById("qr-canvas").getContext("2d"),n=document.getElementById("html5_qrcode_video"),l=(window.navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL||window.oURL,window.navigator.getUserMedia&&window.navigator.getUserMedia({video:!0,audio:!1},function(t){n.src=window.URL.createObjectURL(t),n.play()},function(t){alert("出错信息: "+t.name)}),setInterval(function(){var t;s&&(s.drawImage(n,0,0,640,480),t=s.getImageData(0,0,640,480),(t=jsQR.decodeQRFromImage(t.data,t.width,t.height))&&(a.close(),window.clearInterval(l),i.content=t,t={height:i.image_height||"5",width:i.image_width||"5",imageData:T("#output").qrcode(t),name:T.kgi18n.prop("OtherInfoQrCode")},e(t)))},2e3))}catch(t){printHtml("浏览器不支持HTML5 CANVAS")}};var M=kingPlus();return _.extend(M.alertConfig,{cancelDisplay:!0,quickClose:!1,backdropOpacity:.1}),_.extend(M.loadingConfig,{cancelDisplay:!0,quickClose:!1,backdropOpacity:.1}),_.extend(M.dialogConfig,{cancelDisplay:!1,quickClose:!0}),S}));
//V3.0.0.572